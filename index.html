<!-- –ü—Ä–∏–º–µ—Ä –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π —Å—Å—ã–ª–∫–∏ -->
<a href="https://360.yandex.ru/gpt?utm_source=ai_catalog&utm_medium=referral&utm_campaign=ai_tools&utm_content=site_id" 
   target="_blank">
   –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ø–Ω–¥–µ–∫—Å GPT
</a>
<a href="https://developers.sber.ru/gigachat?partner_id=YOUR_ID&ref=ai_catalog" 
   target="_blank">
   GigaChat –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
</a>
<!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ UTM: -->
<a href="https://servise.com?utm_source=ai_catalog&utm_medium=referral&utm_campaign=ai_tools&utm_content=button_top">
  –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–µ—Ä–≤–∏—Å
</a>
<!-- –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ -->
<script>
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();
    for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
    k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(YOUR_ID, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true,
        webvisor:true
    });
</script>
<!-- –í–∞—Ä–∏–∞–Ω—Ç A -->
<a href="link?ref=ai_catalog_a" class="btn btn-primary">
    <i class="fas fa-rocket"></i>
    –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ
</a>

<!-- –í–∞—Ä–∏–∞–Ω—Ç B -->
<a href="link?ref=ai_catalog_b" class="btn btn-gradient">
    <i class="fas fa-bolt"></i>
    –ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
</a>
<!-- –ü—Ä–∏–º–µ—Ä SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–∏ -->
<article>
    <h1>–Ø–Ω–¥–µ–∫—Å GPT: –ü–æ–ª–Ω—ã–π –æ–±–∑–æ—Ä –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å ChatGPT</h1>
    <p>–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞–∑–±–µ—Ä–µ–º, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ø–Ω–¥–µ–∫—Å GPT –≤ –†–æ—Å—Å–∏–∏...</p>
    <!-- –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
    <div class="cta-box">
        <a href="–ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è-—Å—Å—ã–ª–∫–∞" class="btn-primary">
            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ø–Ω–¥–µ–∫—Å GPT —Å–æ —Å–∫–∏–¥–∫–æ–π 15%
        </a>
    </div>
</article>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞ –∫–ª–∏–∫–æ–≤
function trackAffiliateClick(serviceName, linkType, position) {
    const data = {
        service: serviceName,
        link_type: linkType,
        position: position,
        timestamp: new Date().toISOString(),
        user_id: getUserId(),
        page_url: window.location.href
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    let clicks = JSON.parse(localStorage.getItem('affiliate_clicks') || '[]');
    clicks.push(data);
    localStorage.setItem('affiliate_clicks', JSON.stringify(clicks));
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/api/track-click', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
document.querySelectorAll('[href*="utm_source"], [href*="ref="]').forEach(link => {
    link.addEventListener('click', function(e) {
        const service = this.dataset.service || 'unknown';
        trackAffiliateClick(service, 'outbound', this.dataset.position);
    });
});
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
class AffiliateManager {
    constructor() {
        this.partnerCodes = {
            'yandex': 'ai_catalog_yandex_2024',
            'sber': 'ai_catalog_sber_partner',
            'fusion': 'FUSION_AI_CATALOG',
            'deepseek': 'DEEPSEEK_REF'
        };
        
        this.utmParams = {
            source: 'ai_catalog',
            medium: 'referral',
            campaign: 'ai_tools_2024'
        };
    }
    
    generateLink(service, userId = null) {
        const baseUrls = {
            'yandex': 'https://360.yandex.ru/gpt',
            'sber': 'https://developers.sber.ru/gigachat',
            'fusion': 'https://fusionbrain.ai/diffusion',
            'deepseek': 'https://deepseek.ru',
            'codegpt': 'https://codegpt.ru'
        };
        
        const url = new URL(baseUrls[service]);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–æ–¥
        if (service === 'yandex') {
            url.searchParams.set('ref', this.partnerCodes[service]);
        } else if (service === 'sber') {
            url.searchParams.set('partner_id', this.partnerCodes[service]);
        } else {
            url.searchParams.set('promo', this.partnerCodes[service]);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º UTM-–º–µ—Ç–∫–∏
        url.searchParams.set('utm_source', this.utmParams.source);
        url.searchParams.set('utm_medium', this.utmParams.medium);
        url.searchParams.set('utm_campaign', this.utmParams.campaign);
        
        // –î–æ–±–∞–≤–ª—è–µ–º user_id –µ—Å–ª–∏ –µ—Å—Ç—å
        if (userId) {
            url.searchParams.set('sub_id', userId);
            url.searchParams.set('click_id', this.generateClickId(userId));
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
        url.searchParams.set('_t', Date.now());
        
        return url.toString();
    }
    
    generateClickId(userId) {
        return `${userId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const affiliateManager = new AffiliateManager();
const yandexLink = affiliateManager.generateLink('yandex', 'user123');
// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ API –Ø–Ω–¥–µ–∫—Å
async function getYandexAffiliateStats(apiKey, dateFrom, dateTo) {
    const response = await fetch('https://api.partner.yandex.ru/v2/statistics', {
        method: 'POST',
        headers: {
            'Authorization': `OAuth ${apiKey}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            from_date: dateFrom,
            to_date: dateTo,
            group_by: 'day',
            metrics: ['clicks', 'leads', 'confirmed_revenue'],
            dimensions: ['offer']
        })
    });
    
    const data = await response.json();
    return data.result;
}

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
const stats = await getYandexAffiliateStats(
    '–≤–∞—à_api_–∫–ª—é—á',
    '2024-01-01',
    '2024-01-31'
);
<!-- affiliate-dashboard.html -->
<div class="affiliate-dashboard">
    <div class="dashboard-header">
        <h2>–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç</h2>
        <div class="affiliate-id">
            –í–∞—à ID: <code id="affiliateId">AI_CATALOG_123</code>
            <button onclick="copyAffiliateId()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <h3>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="stat-item">
                <span>–ü–µ—Ä–µ—Ö–æ–¥—ã:</span>
                <strong id="totalClicks">0</strong>
            </div>
            <div class="stat-item">
                <span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
                <strong id="totalRegistrations">0</strong>
            </div>
            <div class="stat-item">
                <span>–û–±—â–∏–π –¥–æ—Ö–æ–¥:</span>
                <strong id="totalRevenue">0 ‚ÇΩ</strong>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>–ü–æ —Å–µ—Ä–≤–∏—Å–∞–º</h3>
            <table class="service-stats">
                <thead>
                    <tr>
                        <th>–°–µ—Ä–≤–∏—Å</th>
                        <th>–ü–µ—Ä–µ—Ö–æ–¥—ã</th>
                        <th>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</th>
                        <th>–î–æ—Ö–æ–¥</th>
                    </tr>
                </thead>
                <tbody id="serviceStats">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div class="stat-card">
            <h3>–í–∞—à–∏ —Å—Å—ã–ª–∫–∏</h3>
            <div class="affiliate-links">
                <div class="link-item">
                    <label>–Ø–Ω–¥–µ–∫—Å GPT:</label>
                    <input type="text" readonly value="https://ai-catalog.ru/redirect/yandex?ref=ID123">
                    <button onclick="copyLink(this)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="link-item">
                    <label>Kandinsky:</label>
                    <input type="text" readonly value="https://ai-catalog.ru/redirect/kandinsky?ref=ID123">
                    <button onclick="copyLink(this)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <!-- –î—Ä—É–≥–∏–µ —Å—Å—ã–ª–∫–∏ -->
            </div>
        </div>
    </div>
    
    <div class="referral-section">
        <h3>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π</h3>
        <p>–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</p>
        <div class="referral-link">
            <input type="text" id="referralLink" readonly 
                   value="https://ai-catalog.ru?ref=ID123">
            <button onclick="copyReferralLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <p>–ü–æ–ª—É—á–∞–π—Ç–µ 10% –æ—Ç –¥–æ—Ö–æ–¥–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</p>
    </div>
</div>
<!-- Hotjar –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏ -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:YOUR_HOTJAR_ID,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ A/B —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫
function setupABTest() {
    const variants = [
        {
            name: 'variant_a',
            buttonText: '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ',
            buttonColor: 'primary',
            icon: 'rocket'
        },
        {
            name: 'variant_b', 
            buttonText: '–ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø',
            buttonColor: 'gradient',
            icon: 'key'
        },
        {
            name: 'variant_c',
            buttonText: '–ù–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å',
            buttonColor: 'success', 
            icon: 'play'
        }
    ];
    
    // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º
    const userId = getUserId();
    const variantIndex = hashString(userId) % variants.length;
    const variant = variants[variantIndex];
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç
    applyVariant(variant);
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
    trackVariantConversion(variant.name);
}

function applyVariant(variant) {
    const buttons = document.querySelectorAll('.affiliate-button');
    buttons.forEach(button => {
        button.textContent = variant.buttonText;
        button.className = `btn btn-${variant.buttonColor}`;
        const icon = button.querySelector('i');
        if (icon) {
            icon.className = `fas fa-${variant.icon}`;
        }
    });
}
// affiliate-api.js
const express = require('express');
const router = express.Router();

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞
router.get('/api/affiliate/stats/:affiliateId', async (req, res) => {
    const { affiliateId } = req.params;
    const { period = 'month' } = req.query;
    
    const stats = await AffiliateStats.findOne({ affiliateId });
    
    if (!stats) {
        return res.status(404).json({ error: '–ü–∞—Ä—Ç–Ω—ë—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–µ—Ä–∏–æ–¥—É
    let filteredStats;
    if (period === 'month') {
        const monthAgo = new Date();
        monthAgo.setMonth(monthAgo.getMonth() - 1);
        filteredStats = stats.clicks.filter(click => 
            click.date > monthAgo
        );
    } else if (period === 'week') {
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        filteredStats = stats.clicks.filter(click => 
            click.date > weekAgo
        );
    }
    
    // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    const aggregated = {
        totalClicks: filteredStats.length,
        totalConversions: filteredStats.filter(c => c.converted).length,
        totalRevenue: filteredStats.reduce((sum, click) => 
            sum + (click.revenue || 0), 0
        ),
        services: aggregateByService(filteredStats),
        dailyStats: aggregateByDay(filteredStats)
    };
    
    res.json(aggregated);
});

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π —Å—Å—ã–ª–∫–∏
router.post('/api/affiliate/generate-link', async (req, res) => {
    const { affiliateId, service, customParams = {} } = req.body;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è affiliateId
    const affiliate = await Affiliate.findById(affiliateId);
    if (!affiliate) {
        return res.status(400).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π affiliate ID' });
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏
    const link = generateAffiliateLink({
        affiliateId,
        service,
        ...customParams
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
    await AffiliateLink.create({
        affiliateId,
        service,
        link,
        createdAt: new Date()
    });
    
    res.json({ link });
});

// –í–µ–±—Ö—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Å–∏–π –æ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤
router.post('/webhook/conversion/:service', async (req, res) => {
    const { service } = req.params;
    const conversionData = req.body;
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ—Ä–≤–∏—Å–∞
    switch(service) {
        case 'yandex':
            await processYandexConversion(conversionData);
            break;
        case 'sber':
            await processSberConversion(conversionData);
            break;
        case 'fusion':
            await processFusionConversion(conversionData);
            break;
        default:
            console.log('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å:', service);
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä—É
    if (conversionData.affiliateId) {
        await notifyAffiliate(conversionData.affiliateId, conversionData);
    }
    
    res.json({ received: true });
});
<!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫—É—Ä—Å–∞ -->
<div class="course-page">
    <div class="course-hero">
        <h1>AI Master: –û—Å–≤–æ–π –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –∑–∞ 30 –¥–Ω–µ–π</h1>
        <p class="subtitle">–ü–æ–ª–Ω—ã–π –∫—É—Ä—Å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞</p>
        
        <div class="pricing">
            <div class="price-card">
                <h3>–ë–∞–∑–æ–≤—ã–π</h3>
                <div class="price">4,900 ‚ÇΩ</div>
                <ul>
                    <li>15 –≤–∏–¥–µ–æ-—É—Ä–æ–∫–æ–≤</li>
                    <li>–î–æ—Å—Ç—É–ø –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –Ω–∞ 3 –º–µ—Å—è—Ü–∞</li>
                    <li>–ß–∞—Ç —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏</li>
                </ul>
                <button class="btn btn-primary">–ö—É–ø–∏—Ç—å –∫—É—Ä—Å</button>
            </div>
            
            <div class="price-card popular">
                <div class="badge">–ü–æ–ø—É–ª—è—Ä–Ω—ã–π</div>
                <h3>PRO</h3>
                <div class="price">9,900 ‚ÇΩ</div>
                <ul>
                    <li>30 –≤–∏–¥–µ–æ-—É—Ä–æ–∫–æ–≤</li>
                    <li>–ü–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø</li>
                    <li>–õ–∏—á–Ω—ã–π –º–µ–Ω—Ç–æ—Ä</li>
                    <li>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</li>
                    <li>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</li>
                </ul>
                <button class="btn btn-gradient">–ö—É–ø–∏—Ç—å PRO</button>
            </div>
            
            <div class="price-card">
                <h3>VIP</h3>
                <div class="price">24,900 ‚ÇΩ</div>
                <ul>
                    <li>–í—Å—ë –∏–∑ –ø–∞–∫–µ—Ç–∞ PRO</li>
                    <li>2 –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</li>
                    <li>–ü–æ–º–æ—â—å —Å –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ–º</li>
                    <li>–î–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–π –≥—Ä—É–ø–ø–µ</li>
                </ul>
                <button class="btn btn-primary">–ö—É–ø–∏—Ç—å VIP</button>
            </div>
        </div>
    </div>
</div>
// marketplace.js
class AIMarketplace {
    constructor() {
        this.services = [];
        this.categories = [];
    }
    
    async loadServices() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –∏–∑ –±–∞–∑—ã –∏–ª–∏ API
        const response = await fetch('/api/services');
        this.services = await response.json();
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        this.categories = this.groupByCategory(this.services);
        
        this.renderMarketplace();
    }
    
    groupByCategory(services) {
        const categories = {};
        
        services.forEach(service => {
            if (!categories[service.category]) {
                categories[service.category] = [];
            }
            categories[service.category].push(service);
        });
        
        return categories;
    }
    
    renderMarketplace() {
        const container = document.getElementById('marketplace');
        
        Object.entries(this.categories).forEach(([category, services]) => {
            const categorySection = this.createCategorySection(category, services);
            container.appendChild(categorySection);
        });
    }
    
    createCategorySection(category, services) {
        const section = document.createElement('div');
        section.className = 'category-section';
        
        const title = document.createElement('h2');
        title.textContent = this.getCategoryTitle(category);
        section.appendChild(title);
        
        const grid = document.createElement('div');
        grid.className = 'services-grid';
        
        services.forEach(service => {
            const card = this.createServiceCard(service);
            grid.appendChild(card);
        });
        
        section.appendChild(grid);
        return section;
    }
    
    createServiceCard(service) {
        const card = document.createElement('div');
        card.className = 'service-card';
        
        card.innerHTML = `
            <div class="service-header">
                <div class="service-icon">
                    <i class="${service.icon}"></i>
                </div>
                <div class="service-rating">
                    <span class="stars">${'‚òÖ'.repeat(service.rating)}</span>
                    <span class="reviews">(${service.reviews})</span>
                </div>
            </div>
            
            <h3 class="service-title">${service.name}</h3>
            <p class="service-description">${service.description}</p>
            
            <div class="service-features">
                ${service.features.map(feature => 
                    `<span class="feature-tag">${feature}</span>`
                ).join('')}
            </div>
            
            <div class="service-pricing">
                <span class="price">${service.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : `${service.price} ‚ÇΩ/–º–µ—Å`}</span>
                <span class="commission">–ö–æ–º–∏—Å—Å–∏—è: ${service.commission}%</span>
            </div>
            
            <a href="${service.affiliateLink}" 
               class="btn btn-primary affiliate-link"
               data-service="${service.id}">
                <i class="fas fa-external-link-alt"></i>
                –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–µ—Ä–≤–∏—Å—É
            </a>
            
            <div class="affiliate-info">
                <i class="fas fa-handshake"></i>
                –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
            </div>
        `;
        
        return card;
    }
}
<!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π -->
<div class="consultation-page">
    <h1>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é AI –≤ –±–∏–∑–Ω–µ—Å</h1>
    
    <div class="consultation-options">
        <div class="option">
            <h3><i class="fas fa-video"></i> –†–∞–∑–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä</h3>
            <p>60-–º–∏–Ω—É—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –≤—ã–±–æ—Ä—É AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞</p>
            <div class="price">3,900 ‚ÇΩ</div>
            <button class="btn btn-primary" onclick="bookConsultation('single')">
                –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
        
        <div class="option popular">
            <h3><i class="fas fa-calendar-check"></i> –ü–∞–∫–µ—Ç –∏–∑ 4 –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π</h3>
            <p>–ü–æ–ª–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é AI –≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞</p>
            <div class="price">12,900 ‚ÇΩ</div>
            <div class="savings">–≠–∫–æ–Ω–æ–º–∏—è 3,900 ‚ÇΩ</div>
            <button class="btn btn-gradient" onclick="bookConsultation('package')">
                –í—ã–±—Ä–∞—Ç—å –ø–∞–∫–µ—Ç
            </button>
        </div>
        
        <div class="option">
            <h3><i class="fas fa-briefcase"></i> –ë–∏–∑–Ω–µ—Å-–∞—É–¥–∏—Ç</h3>
            <p>–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é AI</p>
            <div class="price">24,900 ‚ÇΩ</div>
            <button class="btn btn-primary" onclick="bookConsultation('audit')">
                –ó–∞–∫–∞–∑–∞—Ç—å –∞—É–¥–∏—Ç
            </button>
        </div>
    </div>
    
    <div class="booking-form" id="bookingForm">
        <h3>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</h3>
        <form id="consultationForm">
            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:</label>
                <select id="consultationType" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                    <option value="single">–†–∞–∑–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä (3,900 ‚ÇΩ)</option>
                    <option value="package">–ü–∞–∫–µ—Ç –∏–∑ 4 –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π (12,900 ‚ÇΩ)</option>
                    <option value="audit">–ë–∏–∑–Ω–µ—Å-–∞—É–¥–∏—Ç (24,900 ‚ÇΩ)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>–í–∞—à–µ –∏–º—è:</label>
                <input type="text" required>
            </div>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" required>
            </div>
            
            <div class="form-group">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="tel" required>
            </div>
            
            <div class="form-group">
                <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</label>
                <input type="datetime-local" required>
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-calendar-plus"></i>
                –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </form>
    </div>
</div>
// dashboard.js
class AffiliateDashboard {
    constructor() {
        this.charts = {};
        this.init();
    }
    
    async init() {
        await this.loadData();
        this.renderCharts();
        this.setupRealTimeUpdates();
    }
    
    async loadData() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
        const [clicks, conversions, revenue] = await Promise.all([
            fetch('/api/stats/clicks').then(r => r.json()),
            fetch('/api/stats/conversions').then(r => r.json()),
            fetch('/api/stats/revenue').then(r => r.json())
        ]);
        
        this.data = { clicks, conversions, revenue };
    }
    
    renderCharts() {
        // Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        this.renderRevenueChart();
        this.renderConversionChart();
        this.renderTopServicesChart();
        this.renderGeoChart();
    }
    
    renderRevenueChart() {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        this.charts.revenue = new Chart(ctx, {
            type: 'line',
            data: {
                labels: this.getLast30Days(),
                datasets: [{
                    label: '–î–æ—Ö–æ–¥',
                    data: this.data.revenue.daily,
                    borderColor: '#7C3AED',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '–î–æ—Ö–æ–¥ –ø–æ –¥–Ω—è–º'
                    }
                }
            }
        });
    }
    
    renderTopServicesChart() {
        const ctx = document.getElementById('servicesChart').getContext('2d');
        this.charts.services = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: this.data.revenue.topServices.map(s => s.name),
                datasets: [{
                    label: '–î–æ—Ö–æ–¥ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º',
                    data: this.data.revenue.topServices.map(s => s.revenue),
                    backgroundColor: [
                        '#7C3AED', '#10B981', '#F59E0B', 
                        '#EF4444', '#3B82F6'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '–¢–æ–ø —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–æ –¥–æ—Ö–æ–¥—É'
                    }
                }
            }
        });
    }
    
    setupRealTimeUpdates() {
        // WebSocket –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        const socket = new WebSocket('wss://ai-catalog.ru/ws/stats');
        
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.updateDashboard(data);
        };
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            this.refreshData();
        }, 60000);
    }
    
    updateDashboard(newData) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –≥—Ä–∞—Ñ–∏–∫–∏
        Object.assign(this.data, newData);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
        document.getElementById('totalClicks').textContent = 
            this.data.clicks.total.toLocaleString();
        document.getElementById('totalConversions').textContent = 
            this.data.conversions.total.toLocaleString();
        document.getElementById('totalRevenue').textContent = 
            `${this.data.revenue.total.toLocaleString()} ‚ÇΩ`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
        this.updateCharts();
    }
    
    updateCharts() {
        if (this.charts.revenue) {
            this.charts.revenue.data.datasets[0].data = this.data.revenue.daily;
            this.charts.revenue.update();
        }
        
        if (this.charts.services) {
            this.charts.services.data.datasets[0].data = 
                this.data.revenue.topServices.map(s => s.revenue);
            this.charts.services.update();
        }
    }
}
// report-generator.js
class ReportGenerator {
    constructor() {
        this.templates = {
            daily: this.generateDailyReport.bind(this),
            weekly: this.generateWeeklyReport.bind(this),
            monthly: this.generateMonthlyReport.bind(this)
        };
    }
    
    async generateReport(type, email) {
        const data = await this.fetchReportData(type);
        const html = this.templates[type](data);
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ email
        await this.sendEmail(email, html);
        
        return true;
    }
    
    generateDailyReport(data) {
        return `
            <!DOCTYPE html>
            <html>
            <head>
                <style>
                    .report { font-family: Arial, sans-serif; max-width: 600px; }
                    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
                    .stat-card { background: #f5f5f5; padding: 20px; border-radius: 10px; }
                    .stat-value { font-size: 24px; font-weight: bold; color: #7C3AED; }
                </style>
            </head>
            <body>
                <div class="report">
                    <h2>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç AI Catalog</h2>
                    <p>–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">–ü–µ—Ä–µ—Ö–æ–¥—ã</div>
                            <div class="stat-value">${data.clicks}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏–∏</div>
                            <div class="stat-value">${data.conversions}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">–î–æ—Ö–æ–¥</div>
                            <div class="stat-value">${data.revenue} ‚ÇΩ</div>
                        </div>
                    </div>
                    
                    <h3>–¢–æ–ø 5 —Å–µ—Ä–≤–∏—Å–æ–≤:</h3>
                    <ul>
                        ${data.topServices.map(service => `
                            <li>${service.name}: ${service.conversions} –∫–æ–Ω–≤–µ—Ä—Å–∏–π, ${service.revenue} ‚ÇΩ</li>
                        `).join('')}
                    </ul>
                    
                    <p>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>–ö–æ–º–∞–Ω–¥–∞ AI Catalog</p>
                </div>
            </body>
            </html>
        `;
    }
    
    async sendEmail(to, html) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º SendGrid, Mailgun –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å
        const response = await fetch('https://api.email-service.com/send', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer YOUR_API_KEY',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                to: to,
                subject: '–û—Ç—á–µ—Ç AI Catalog',
                html: html
            })
        });
        
        return response.ok;
    }
}
// –°–æ–∑–¥–∞–Ω–∏–µ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
class MultiLevelAffiliate {
    constructor() {
        this.levels = [
            { commission: 30, requiredReferrals: 0 }, // –£—Ä–æ–≤–µ–Ω—å 1
            { commission: 35, requiredReferrals: 10 }, // –£—Ä–æ–≤–µ–Ω—å 2
            { commission: 40, requiredReferrals: 25 }, // –£—Ä–æ–≤–µ–Ω—å 3
            { commission: 45, requiredReferrals: 50 }  // –£—Ä–æ–≤–µ–Ω—å 4
        ];
    }
    
    calculateCommission(affiliate, saleAmount) {
        const level = this.getAffiliateLevel(affiliate);
        const baseCommission = saleAmount * (level.commission / 100);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –±–æ–Ω—É—Å—ã –∑–∞ —É—Ä–æ–≤–Ω–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
        const referralBonus = this.calculateReferralBonus(affiliate);
        
        return baseCommission + referralBonus;
    }
    
    getAffiliateLevel(affiliate) {
        const referrals = affiliate.referrals || [];
        const activeReferrals = referrals.filter(r => r.active);
        
        for (let i = this.levels.length - 1; i >= 0; i--) {
            if (activeReferrals.length >= this.levels[i].requiredReferrals) {
                return this.levels[i];
            }
        }
        
        return this.levels[0];
    }
    
    calculateReferralBonus(affiliate) {
        let totalBonus = 0;
        
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–æ–Ω—É—Å—ã —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
        affiliate.referrals?.forEach(referral => {
            if (referral.sales > 0) {
                // 10% –æ—Ç –¥–æ—Ö–æ–¥–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
                totalBonus += referral.sales * 0.1;
                
                // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –±–æ–Ω—É—Å—ã —Å —Å—É–±-—Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                if (referral.referrals) {
                    totalBonus += this.calculateReferralBonus(referral) * 0.05;
                }
            }
        });
        
        return totalBonus;
    }
}
// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AmoCRM, Bitrix24 –∏ —Ç.–¥.
class CRMIntegration {
    constructor(crmType, apiKey) {
        this.crmType = crmType;
        this.apiKey = apiKey;
    }
    
    async createLead(leadData) {
        switch (this.crmType) {
            case 'amo':
                return await this.createAmoLead(leadData);
            case 'bitrix':
                return await this.createBitrixLead(leadData);
            case 'hubspot':
                return await this.createHubspotLead(leadData);
            default:
                throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è CRM —Å–∏—Å—Ç–µ–º–∞');
        }
    }
    
    async createAmoLead(leadData) {
        const response = await fetch('https://YOUR_DOMAIN.amocrm.ru/api/v4/leads', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${this.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify([{
                name: `AI Catalog: ${leadData.name}`,
                price: leadData.value,
                custom_fields_values: [{
                    field_id: 12345, // ID –ø–æ–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞
                    values: [{ value: leadData.affiliateId }]
                }]
            }])
        });
        
        return await response.json();
    }
    
    async syncAffiliates() {
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ —Å CRM
        const affiliates = await this.getAffiliatesFromDatabase();
        
        for (const affiliate of affiliates) {
            const contact = await this.findOrCreateContact(affiliate);
            await this.updateAffiliateInCRM(affiliate, contact.id);
        }
    }
}
// React Native –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  FlatList,
  StyleSheet,
  TouchableOpacity
} from 'react-native';

const AffiliateApp = () => {
  const [stats, setStats] = useState({});
  const [links, setLinks] = useState([]);
  const [notifications, setNotifications] = useState([]);
  
  useEffect(() => {
    loadAffiliateData();
  }, []);
  
  const loadAffiliateData = async () => {
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å API
    const response = await fetch('https://api.ai-catalog.ru/affiliate/mobile', {
      headers: {
        'Authorization': `Bearer ${userToken}`
      }
    });
    
    const data = await response.json();
    setStats(data.stats);
    setLinks(data.links);
    setNotifications(data.notifications);
  };
  
  const renderLinkItem = ({ item }) => (
    <TouchableOpacity 
      style={styles.linkItem}
      onPress={() => copyToClipboard(item.url)}
    >
      <Text style={styles.serviceName}>{item.service}</Text>
      <Text style={styles.linkUrl} numberOfLines={1}>{item.url}</Text>
      <Text style={styles.clicksCount}>
        {item.clicks} –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ ‚Ä¢ {item.conversions} –∫–æ–Ω–≤–µ—Ä—Å–∏–π
      </Text>
    </TouchableOpacity>
  );
  
  return (
    <View style={styles.container}>
      <View style={styles.header}>
        <Text style={styles.title}>–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç</Text>
        <Text style={styles.affiliateId}>ID: {stats.affiliateId}</Text>
      </View>
      
      <View style={styles.statsContainer}>
        <View style={styles.statCard}>
          <Text style={styles.statValue}>{stats.totalRevenue || 0} ‚ÇΩ</Text>
          <Text style={styles.statLabel}>–û–±—â–∏–π –¥–æ—Ö–æ–¥</Text>
        </View>
        
        <View style={styles.statCard}>
          <Text style={styles.statValue}>{stats.totalClicks || 0}</Text>
          <Text style={styles.statLabel}>–ü–µ—Ä–µ—Ö–æ–¥—ã</Text>
        </View>
        
        <View style={styles.statCard}>
          <Text style={styles.statValue}>{stats.conversionRate || '0%'}</Text>
          <Text style={styles.statLabel}>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</Text>
        </View>
      </View>
      
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>–í–∞—à–∏ —Å—Å—ã–ª–∫–∏</Text>
        <FlatList
          data={links}
          renderItem={renderLinkItem}
          keyExtractor={item => item.id}
          showsVerticalScrollIndicator={false}
        />
      </View>
      
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</Text>
        {notifications.map(notification => (
          <View key={notification.id} style={styles.notification}>
            <Text style={styles.notificationText}>{notification.message}</Text>
            <Text style={styles.notificationTime}>
              {new Date(notification.timestamp).toLocaleDateString()}
            </Text>
          </View>
        ))}
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#0F172A',
    padding: 16,
  },
  header: {
    marginBottom: 24,
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  affiliateId: {
    color: '#94A3B8',
    fontSize: 14,
  },
  statsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 24,
  },
  statCard: {
    backgroundColor: '#1E293B',
    borderRadius: 12,
    padding: 16,
    alignItems: 'center',
    flex: 1,
    marginHorizontal: 4,
  },
  statValue: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#7C3AED',
    marginBottom: 4,
  },
  statLabel: {
    fontSize: 12,
    color: '#94A3B8',
  },
  section: {
    marginBottom: 24,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#FFFFFF',
    marginBottom: 12,
  },
  linkItem: {
    backgroundColor: '#1E293B',
    borderRadius: 12,
    padding: 16,
    marginBottom: 8,
  },
  serviceName: {
    fontSize: 16,
    fontWeight: '600',
    color: '#FFFFFF',
    marginBottom: 4,
  },
  linkUrl: {
    color: '#60A5FA',
    fontSize: 14,
    marginBottom: 8,
  },
  clicksCount: {
    color: '#94A3B8',
    fontSize: 12,
  },
  notification: {
    backgroundColor: '#1E293B',
    borderRadius: 12,
    padding: 12,
    marginBottom: 8,
  },
  notificationText: {
    color: '#FFFFFF',
    fontSize: 14,
    marginBottom: 4,
  },
  notificationTime: {
    color: '#64748B',
    fontSize: 12,
  },
});

export default AffiliateApp;
<!-- marketplace.html -->
<div class="affiliate-marketplace">
    <div class="marketplace-header">
        <h1>–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –±–∏—Ä–∂–∞ AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</h1>
        <p>–ü–æ–¥–∫–ª—é—á–∞–π—Ç–µ—Å—å –∫ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–º –ø—Ä–æ–≥—Ä–∞–º–º–∞–º –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö</p>
    </div>
    
    <div class="marketplace-filters">
        <div class="filter-group">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
            <select id="categoryFilter">
                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                <option value="text">–¢–µ–∫—Å—Ç–æ–≤—ã–µ AI</option>
                <option value="image">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</option>
                <option value="video">–í–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ</option>
                <option value="code">–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤</option>
                <option value="business">–ë–∏–∑–Ω–µ—Å-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>–ö–æ–º–∏—Å—Å–∏—è:</label>
            <select id="commissionFilter">
                <option value="">–õ—é–±–∞—è</option>
                <option value="10">–û—Ç 10%</option>
                <option value="20">–û—Ç 20%</option>
                <option value="30">–û—Ç 30%</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
            <select id="sortFilter">
                <option value="popular">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
                <option value="commission">–ü–æ –∫–æ–º–∏—Å—Å–∏–∏</option>
                <option value="new">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
            </select>
        </div>
    </div>
    
    <div class="marketplace-grid" id="affiliateOffers">
        <!-- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
    
    <div class="how-it-works">
        <h2>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h2>
        <div class="steps">
            <div class="step">
                <div class="step-number">1</div>
                <h3>–í—ã–±–∏—Ä–∞–µ—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h3>
                <p>–ù–∞–π–¥–∏—Ç–µ AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å</p>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <h3>–ü–æ–ª—É—á–∞–µ—Ç–µ —Å—Å—ã–ª–∫—É</h3>
                <p>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏ –ø–æ–ª—É—á–∏—Ç–µ —Å—Å—ã–ª–∫—É</p>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <h3>–ü—Ä–∏–≤–ª–µ–∫–∞–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                <p>–†–∞–∑–º–µ—â–∞–π—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç–µ, –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö, –≤ —Ä–∞—Å—Å—ã–ª–∫–∞—Ö</p>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <h3>–ü–æ–ª—É—á–∞–µ—Ç–µ –¥–æ—Ö–æ–¥</h3>
                <p>–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç —Å –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–∏ –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ</p>
            </div>
        </div>
    </div>
</div>

<script>
class AffiliateMarketplace {
    constructor() {
        this.offers = [];
        this.filters = {
            category: '',
            commission: '',
            sort: 'popular'
        };
        
        this.init();
    }
    
    async init() {
        await this.loadOffers();
        this.renderOffers();
        this.setupFilters();
    }
    
    async loadOffers() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å API
        const response = await fetch('/api/affiliate/offers');
        this.offers = await response.json();
    }
    
    renderOffers() {
        const container = document.getElementById('affiliateOffers');
        container.innerHTML = '';
        
        const filteredOffers = this.applyFilters();
        
        filteredOffers.forEach(offer => {
            const card = this.createOfferCard(offer);
            container.appendChild(card);
        });
    }
    
    createOfferCard(offer) {
        const card = document.createElement('div');
        card.className = 'affiliate-offer';
        
        card.innerHTML = `
            <div class="offer-badge ${offer.featured ? 'featured' : ''}">
                ${offer.featured ? 'üî• –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º' : ''}
            </div>
            
            <div class="offer-header">
                <img src="${offer.logo}" alt="${offer.name}" class="offer-logo">
                <div class="offer-meta">
                    <span class="offer-category">${offer.category}</span>
                    <span class="offer-rating">
                        ${'‚òÖ'.repeat(Math.floor(offer.rating))}
                        <span class="rating-count">(${offer.reviews})</span>
                    </span>
                </div>
            </div>
            
            <h3 class="offer-title">${offer.name}</h3>
            <p class="offer-description">${offer.description}</p>
            
            <div class="offer-stats">
                <div class="stat">
                    <span class="stat-label">–ö–æ–º–∏—Å—Å–∏—è</span>
                    <span class="stat-value commission">${offer.commission}%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">–í—ã–ø–ª–∞—Ç–∞</span>
                    <span class="stat-value">${offer.payout}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Cookie</span>
                    <span class="stat-value">${offer.cookieDays} –¥–Ω–µ–π</span>
                </div>
            </div>
            
            <div class="offer-tags">
                ${offer.tags.map(tag => 
                    `<span class="tag">${tag}</span>`
                ).join('')}
            </div>
            
            <div class="offer-actions">
                <button class="btn btn-outline" onclick="viewOfferDetails('${offer.id}')">
                    <i class="fas fa-info-circle"></i>
                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                </button>
                <button class="btn btn-primary" onclick="joinAffiliateProgram('${offer.id}')">
                    <i class="fas fa-sign-in-alt"></i>
                    –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                </button>
            </div>
        `;
        
        return card;
    }
    
    applyFilters() {
        let filtered = [...this.offers];
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if (this.filters.category) {
            filtered = filtered.filter(offer => 
                offer.category === this.filters.category
            );
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–∏—Å—Å–∏–∏
        if (this.filters.commission) {
            filtered = filtered.filter(offer => 
                offer.commission >= parseInt(this.filters.commission)
            );
        }
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        switch (this.filters.sort) {
            case 'commission':
                filtered.sort((a, b) => b.commission - a.commission);
                break;
            case 'new':
                filtered.sort((a, b) => 
                    new Date(b.createdAt) - new Date(a.createdAt)
                );
                break;
            case 'popular':
            default:
                filtered.sort((a, b) => b.popularity - a.popularity);
        }
        
        return filtered;
    }
    
    setupFilters() {
        document.getElementById('categoryFilter').addEventListener('change', (e) => {
            this.filters.category = e.target.value;
            this.renderOffers();
        });
        
        document.getElementById('commissionFilter').addEventListener('change', (e) => {
            this.filters.commission = e.target.value;
            this.renderOffers();
        });
        
        document.getElementById('sortFilter').addEventListener('change', (e) => {
            this.filters.sort = e.target.value;
            this.renderOffers();
        });
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
const marketplace = new AffiliateMarketplace();

function viewOfferDetails(offerId) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    window.location.href = `/affiliate/offer/${offerId}`;
}

async function joinAffiliateProgram(offerId) {
    try {
        const response = await fetch(`/api/affiliate/join/${offerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: getCurrentUserId()
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            showNotification('‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ!');
            window.open(data.affiliateUrl, '_blank');
        } else {
            throw new Error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        }
    } catch (error) {
        showNotification('‚ùå ' + error.message, 'error');
    }
}
</script>

<style>
.affiliate-marketplace {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.marketplace-header {
    text-align: center;
    margin-bottom: 40px;
}

.marketplace-filters {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    color: #CBD5E1;
    font-weight: 500;
}

.filter-group select {
    width: 100%;
    padding: 10px;
    background: #1E293B;
    border: 1px solid #334155;
    border-radius: 8px;
    color: white;
}

.marketplace-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 25px;
    margin-bottom: 60px;
}

.affiliate-offer {
    background: #1E293B;
    border-radius: 16px;
    padding: 25px;
    border: 1px solid #334155;
    transition: all 0.3s;
    position: relative;
}

.affiliate-offer:hover {
    transform: translateY(-5px);
    border-color: #7C3AED;
    box-shadow: 0 10px 30px rgba(124, 58, 237, 0.2);
}

.offer-badge {
    position: absolute;
    top: -10px;
    right: 20px;
    background: #EF4444;
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.offer-badge.featured {
    background: linear-gradient(135deg, #F59E0B, #EF4444);
}

.offer-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.offer-logo {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    object-fit: cover;
}

.offer-meta {
    flex: 1;
}

.offer-category {
    display: block;
    color: #94A3B8;
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.offer-rating {
    color: #F59E0B;
    font-size: 0.9rem;
}

.rating-count {
    color: #64748B;
    margin-left: 5px;
}

.offer-title {
    font-size: 1.4rem;
    color: white;
    margin-bottom: 15px;
}

.offer-description {
    color: #94A3B8;
    line-height: 1.6;
    margin-bottom: 20px;
}

.offer-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.stat {
    text-align: center;
    background: rgba(255, 255, 255, 0.05);
    padding: 10px;
    border-radius: 8px;
}

.stat-label {
    display: block;
    color: #94A3B8;
    font-size: 0.8rem;
    margin-bottom: 5px;
}

.stat-value {
    display: block;
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
}

.stat-value.commission {
    color: #10B981;
}

.offer-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
}

.tag {
    background: rgba(124, 58, 237, 0.1);
    color: #A78BFA;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
}

.offer-actions {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-outline {
    background: transparent;
    border: 1px solid #475569;
    color: #CBD5E1;
}

.btn-outline:hover {
    border-color: #7C3AED;
    color: white;
}

.btn-primary {
    background: linear-gradient(135deg, #7C3AED, #10B981);
    color: white;
}

.btn-primary:hover {
    opacity: 0.9;
}

.how-it-works {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    padding: 40px;
    margin-top: 40px;
}

.steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 30px;
    margin-top: 30px;
}

.step {
    text-align: center;
}

.step-number {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #7C3AED, #10B981);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0 auto 20px;
}

.step h3 {
    color: white;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.step p {
    color: #94A3B8;
    line-height: 1.6;
}
</style>
// video-content-manager.js
class VideoContentManager {
    constructor() {
        this.videos = [];
        this.platforms = ['youtube', 'rutube', 'vk', 'telegram'];
    }
    
    async createVideoContent(topic, affiliateLinks) {
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è
        const script = await this.generateScript(topic, affiliateLinks);
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤–∏–¥–µ–æ
        const videoStructure = {
            title: this.generateVideoTitle(topic),
            description: this.generateDescription(topic, affiliateLinks),
            tags: this.generateTags(topic),
            chapters: this.generateChapters(script),
            affiliateLinks: this.prepareAffiliateLinks(affiliateLinks),
            timestamps: this.generateTimestamps(script)
        };
        
        return videoStructure;
    }
    
    generateVideoTitle(topic) {
        const titles = [
            `–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ${topic} –≤ 2024 –≥–æ–¥—É`,
            `${topic}: –ü–æ–ª–Ω—ã–π –æ–±–∑–æ—Ä –∏ —Å–µ–∫—Ä–µ—Ç—ã`,
            `–Ø –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª ${topic} - –≤–æ—Ç —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å`,
            `${topic} –ø—Ä–æ—Ç–∏–≤ –∞–Ω–∞–ª–æ–≥–æ–≤: —á—Ç–æ –ª—É—á—à–µ?`
        ];
        
        return titles[Math.floor(Math.random() * titles.length)];
    }
    
    generateDescription(topic, links) {
        return `
–í —ç—Ç–æ–º –≤–∏–¥–µ–æ —è —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—é –ø—Ä–æ ${topic} - –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è [—Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è].

üìã –ß—Ç–æ –≤—ã —É–∑–Ω–∞–µ—Ç–µ:
‚Ä¢ –ö–∞–∫ –Ω–∞—á–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ${topic}
‚Ä¢ –°–µ–∫—Ä–µ—Ç—ã –∏ –ª–∞–π—Ñ—Ö–∞–∫–∏
‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–Ω–∞–ª–æ–≥–∞–º–∏
‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

üéÅ –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ —Å–∫–∏–¥–∫–∏:
${links.map(link => `‚Ä¢ ${link.name}: ${link.promoCode || '–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ'}`).join('\n')}

‚è±Ô∏è –¢–∞–π–º–∫–æ–¥—ã:
00:00 - –í–≤–µ–¥–µ–Ω–∏–µ
02:15 - –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
05:30 - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã
08:45 - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–Ω–∞–ª–æ–≥–∞–º–∏
12:00 - –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ —Å–æ–≤–µ—Ç—ã

üîó –°—Å—ã–ª–∫–∏ –∏–∑ –≤–∏–¥–µ–æ:
${links.map(link => `${link.name}: ${link.url}`).join('\n')}

#${topic.replace(/\s+/g, '')} #AI #–Ω–µ–π—Ä–æ—Å–µ—Ç–∏ #–æ–±–∑–æ—Ä
        `.trim();
    }
    
    async generateScript(topic, links) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º AI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è
        const response = await fetch('/api/generate-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                topic: topic,
                links: links,
                style: 'educational',
                duration: '10-15 –º–∏–Ω—É—Ç'
            })
        });
        
        return await response.json();
    }
    
    generateChapters(script) {
        return script.sections.map((section, index) => ({
            time: this.formatTime(index * 180), // 3 –º–∏–Ω—É—Ç—ã –Ω–∞ —Å–µ–∫—Ü–∏—é
            title: section.title
        }));
    }
    
    prepareAffiliateLinks(links) {
        return links.map(link => ({
            ...link,
            trackableUrl: this.addTrackingParams(link.url, 'video'),
            qrCode: this.generateQRCode(link.url)
        }));
    }
    
    addTrackingParams(url, source) {
        const urlObj = new URL(url);
        urlObj.searchParams.set('utm_source', 'youtube');
        urlObj.searchParams.set('utm_medium', 'video');
        urlObj.searchParams.set('utm_campaign', source);
        return urlObj.toString();
    }
    
    formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
}

// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å YouTube API
class YouTubeManager {
    constructor(apiKey) {
        this.apiKey = apiKey;
        this.baseUrl = 'https://www.googleapis.com/youtube/v3';
    }
    
    async uploadVideo(videoFile, metadata) {
        const formData = new FormData();
        formData.append('video', videoFile);
        formData.append('metadata', JSON.stringify(metadata));
        
        const response = await fetch(`${this.baseUrl}/videos?part=snippet,status`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${this.apiKey}`
            },
            body: formData
        });
        
        return await response.json();
    }
    
    async updateVideoDescription(videoId, description) {
        const response = await fetch(`${this.baseUrl}/videos?part=snippet`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${this.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id: videoId,
                snippet: {
                    description: description
                }
            })
        });
        
        return await response.json();
    }
    
    async getVideoAnalytics(videoId) {
        const response = await fetch(
            `${this.baseUrl}/videos?part=statistics,contentDetails&id=${videoId}&key=${this.apiKey}`
        );
        
        return await response.json();
    }
}
// ai-assistant.js
class AffiliateAIAssistant {
    constructor() {
        this.model = 'gpt-4';
        this.context = this.getDefaultContext();
    }
    
    async initialize() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–∞
        const affiliateData = await this.loadAffiliateData();
        this.context.affiliate = affiliateData;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        const stats = await this.loadStatistics();
        this.context.stats = stats;
        
        console.log('AI Assistant initialized');
    }
    
    async askQuestion(question) {
        const messages = [
            {
                role: 'system',
                content: this.getSystemPrompt()
            },
            {
                role: 'user',
                content: question
            }
        ];
        
        const response = await this.callAI(messages);
        return this.processResponse(response);
    }
    
    getSystemPrompt() {
        return `
–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ AI Catalog. 
–¢–≤–æ—è —Ü–µ–ª—å - –ø–æ–º–æ–≥–∞—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –∏—Ö –¥–æ—Ö–æ–¥.

–¢–µ–∫—É—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ä—Ç–Ω—ë—Ä–µ:
- ID: ${this.context.affiliate?.id || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
- –£—Ä–æ–≤–µ–Ω—å: ${this.context.affiliate?.level || '–Ω–æ–≤–∏—á–æ–∫'}
- –î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü: ${this.context.stats?.monthlyRevenue || 0} ‚ÇΩ
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è: ${this.context.stats?.conversionRate || '0%'}

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- –Ø–Ω–¥–µ–∫—Å GPT (–∫–æ–º–∏—Å—Å–∏—è: 30%)
- Kandinsky (–∫–æ–º–∏—Å—Å–∏—è: 25%)
- GigaChat (–∫–æ–º–∏—Å—Å–∏—è: 20%)
- DeepSeek (–∫–æ–º–∏—Å—Å–∏—è: 15%)

–¢–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
1. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –¥–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
2. –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è
3. –ü–æ–º–æ–≥–∞—Ç—å —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞
4. –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º.
        `.trim();
    }
    
    async callAI(messages) {
        try {
            const response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: this.model,
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 1000
                })
            });
            
            return await response.json();
        } catch (error) {
            console.error('AI request failed:', error);
            return {
                content: '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
            };
        }
    }
    
    processResponse(response) {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
        const recommendations = this.extractRecommendations(response.content);
        const links = this.extractAffiliateLinks(response.content);
        const metrics = this.calculatePotentialRevenue(recommendations);
        
        return {
            answer: response.content,
            recommendations: recommendations,
            suggestedLinks: links,
            potentialRevenue: metrics,
            timestamp: new Date().toISOString()
        };
    }
    
    extractRecommendations(text) {
        // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        const recommendations = [];
        const lines = text.split('\n');
        
        lines.forEach(line => {
            if (line.includes('—Ä–µ–∫–æ–º–µ–Ω–¥') || line.includes('—Å–æ–≤–µ—Ç') || line.includes('–ø–æ–ø—Ä–æ–±—É–π')) {
                recommendations.push(line.trim());
            }
        });
        
        return recommendations.slice(0, 3); // –ú–∞–∫—Å–∏–º—É–º 3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    }
    
    extractAffiliateLinks(text) {
        const links = [];
        const affiliateServices = ['–Ø–Ω–¥–µ–∫—Å GPT', 'Kandinsky', 'GigaChat', 'DeepSeek'];
        
        affiliateServices.forEach(service => {
            if (text.includes(service)) {
                links.push({
                    service: service,
                    url: this.generateAffiliateLink(service),
                    commission: this.getCommissionForService(service)
                });
            }
        });
        
        return links;
    }
    
    calculatePotentialRevenue(recommendations) {
        // –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞
        const baseRevenue = this.context.stats?.monthlyRevenue || 0;
        const estimatedIncrease = recommendations.length * 0.1; // 10% –∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
        const potentialRevenue = baseRevenue * (1 + estimatedIncrease);
        
        return {
            current: baseRevenue,
            potential: potentialRevenue,
            increase: ((potentialRevenue - baseRevenue) / baseRevenue * 100).toFixed(1) + '%'
        };
    }
    
    generateAffiliateLink(service) {
        const links = {
            '–Ø–Ω–¥–µ–∫—Å GPT': 'https://360.yandex.ru/gpt?ref=ai_assistant',
            'Kandinsky': 'https://fusionbrain.ai?ref=ai_assistant',
            'GigaChat': 'https://developers.sber.ru/gigachat?ref=ai_assistant',
            'DeepSeek': 'https://deepseek.ru?ref=ai_assistant'
        };
        
        return links[service] || '#';
    }
    
    getCommissionForService(service) {
        const commissions = {
            '–Ø–Ω–¥–µ–∫—Å GPT': '30%',
            'Kandinsky': '25%', 
            'GigaChat': '20%',
            'DeepSeek': '15%'
        };
        
        return commissions[service] || '10%';
    }
    
    async generateContentIdeas(count = 5) {
        const prompt = `
–ü—Ä–∏–¥—É–º–∞–π ${count} –∏–¥–µ–π –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ —Ç–µ–º—É AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, 
–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –ø—Ä–∏–≤–ª–µ–∫–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–µ –ø—Ä–æ–¥–∞–∂–∏.

–£—á–∏—Ç—ã–≤–∞–π —Ç–µ–∫—É—â–∏–µ —Ç—Ä–µ–Ω–¥—ã –∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "ideas": [
    {
      "title": "–ù–∞–∑–≤–∞–Ω–∏–µ –∏–¥–µ–∏",
      "type": "article/video/social",
      "targetAudience": "—Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è",
      "estimatedTime": "–≤—Ä–µ–º—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ",
      "affiliateServices": ["—Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è"]
    }
  ]
}
        `;
        
        const response = await this.askQuestion(prompt);
        
        try {
            // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            const jsonMatch = response.answer.match(/```json\n([\s\S]*?)\n```/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[1]);
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç JSON, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
            return {
                ideas: response.recommendations.map((rec, index) => ({
                    title: rec,
                    type: 'article',
                    targetAudience: '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ AI',
                    estimatedTime: '2-3 —á–∞—Å–∞',
                    affiliateServices: response.suggestedLinks.map(link => link.service)
                }))
            };
        } catch (error) {
            console.error('Error parsing AI response:', error);
            return { ideas: [] };
        }
    }
}

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —á–∞—Ç-–±–æ—Ç–∞
class AIChatInterface {
    constructor() {
        this.assistant = new AffiliateAIAssistant();
        this.messageHistory = [];
        this.setupUI();
    }
    
    setupUI() {
        const container = document.createElement('div');
        container.className = 'ai-chat-container';
        container.innerHTML = `
            <div class="ai-chat-header">
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ai-info">
                    <h3>AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
                    <p>–ü–æ–º–æ–≥–∞–µ—Ç —É–≤–µ–ª–∏—á–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –¥–æ—Ö–æ–¥</p>
                </div>
                <button class="close-chat" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="ai-chat-messages" id="chatMessages">
                <div class="message ai-message">
                    <div class="message-content">
                        –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å:
                        1. –ê–Ω–∞–ª–∏–∑–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                        2. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é
                        3. –ò–¥–µ—è–º–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                        4. –û—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ
                        
                        –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?
                    </div>
                </div>
            </div>
            
            <div class="ai-chat-input">
                <input type="text" 
                       id="chatInput" 
                       placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..."
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <div class="ai-quick-actions">
                <button class="quick-action" onclick="askQuestion('–ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é?')">
                    üìà –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é
                </button>
                <button class="quick-action" onclick="askQuestion('–ö–∞–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã —Å–µ–π—á–∞—Å –ª—É—á—à–µ –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å?')">
                    üöÄ –õ—É—á—à–∏–µ —Å–µ—Ä–≤–∏—Å—ã
                </button>
                <button class="quick-action" onclick="generateContentIdeas()">
                    üí° –ò–¥–µ–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                </button>
            </div>
        `;
        
        document.body.appendChild(container);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        this.assistant.initialize();
    }
    
    async sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        this.addUserMessage(message);
        input.value = '';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        this.showTypingIndicator();
        
        try {
            // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI
            const response = await this.assistant.askQuestion(message);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            this.hideTypingIndicator();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
            this.addAIMessage(response);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            this.messageHistory.push({
                question: message,
                response: response,
                timestamp: new Date()
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤ localStorage
            this.saveHistory();
            
        } catch (error) {
            this.hideTypingIndicator();
            this.addErrorMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        }
    }
    
    addUserMessage(text) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        messageDiv.innerHTML = `
            <div class="message-content">${this.escapeHtml(text)}</div>
        `;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    addAIMessage(response) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai-message';
        
        let content = `<div class="message-content">${response.answer}</div>`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
        if (response.recommendations && response.recommendations.length > 0) {
            content += `
                <div class="recommendations">
                    <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong>
                    <ul>
                        ${response.recommendations.map(rec => 
                            `<li>${this.escapeHtml(rec)}</li>`
                        ).join('')}
                    </ul>
                </div>
            `;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
        if (response.suggestedLinks && response.suggestedLinks.length > 0) {
            content += `
                <div class="affiliate-links">
                    <strong>–°—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è:</strong>
                    <div class="links-list">
                        ${response.suggestedLinks.map(link => `
                            <a href="${link.url}" target="_blank" class="affiliate-link">
                                ${link.service} (–∫–æ–º–∏—Å—Å–∏—è: ${link.commission})
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        messageDiv.innerHTML = content;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    async generateContentIdeas() {
        const ideas = await this.assistant.generateContentIdeas(5);
        
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai-message';
        
        let content = '<div class="message-content"><strong>–ò–¥–µ–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞:</strong></div>';
        
        ideas.ideas.forEach((idea, index) => {
            content += `
                <div class="content-idea">
                    <h4>${index + 1}. ${idea.title}</h4>
                    <div class="idea-meta">
                                               <span class="idea-type">${idea.type}</span>
                        <span class="idea-audience">üë• ${idea.targetAudience}</span>
                        <span class="idea-time">‚è±Ô∏è ${idea.estimatedTime}</span>
                    </div>
                    <div class="idea-services">
                        <strong>–°–µ—Ä–≤–∏—Å—ã:</strong>
                        ${idea.affiliateServices.map(service => 
                            `<span class="service-tag">${service}</span>`
                        ).join('')}
                    </div>
                </div>
            `;
        });
        
        messageDiv.innerHTML = content;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    showTypingIndicator() {
        const messagesContainer = document.getElementById('chatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai-message typing';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="message-content">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    addErrorMessage(text) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message error-message';
        messageDiv.innerHTML = `
            <div class="message-content">
                <i class="fas fa-exclamation-circle"></i>
                ${this.escapeHtml(text)}
            </div>
        `;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    saveHistory() {
        localStorage.setItem('ai_chat_history', JSON.stringify(this.messageHistory));
    }
    
    loadHistory() {
        const saved = localStorage.getItem('ai_chat_history');
        if (saved) {
            this.messageHistory = JSON.parse(saved);
        }
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
const chatStyles = `
<style>
.ai-chat-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 400px;
    max-height: 600px;
    background: #1E293B;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    z-index: 1000;
    border: 1px solid #334155;
    overflow: hidden;
}

.ai-chat-header {
    background: linear-gradient(135deg, #7C3AED, #10B981);
    padding: 15px 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    color: white;
}

.ai-avatar {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.ai-info {
    flex: 1;
}

.ai-info h3 {
    margin: 0;
    font-size: 1.1rem;
}

.ai-info p {
    margin: 0;
    font-size: 0.85rem;
    opacity: 0.9;
}

.close-chat {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 5px;
}

.ai-chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    max-height: 400px;
}

.message {
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-content {
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.5;
}

.user-message .message-content {
    background: #7C3AED;
    color: white;
    margin-left: 40px;
    border-bottom-right-radius: 4px;
}

.ai-message .message-content {
    background: #334155;
    color: #E2E8F0;
    margin-right: 40px;
    border-bottom-left-radius: 4px;
}

.error-message .message-content {
    background: rgba(239, 68, 68, 0.2);
    color: #FCA5A5;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.ai-chat-input {
    padding: 15px 20px;
    border-top: 1px solid #334155;
    display: flex;
    gap: 10px;
    background: #0F172A;
}

.ai-chat-input input {
    flex: 1;
    padding: 12px 16px;
    background: #1E293B;
    border: 1px solid #475569;
    border-radius: 8px;
    color: white;
    font-size: 0.95rem;
}

.ai-chat-input input:focus {
    outline: none;
    border-color: #7C3AED;
}

.ai-chat-input button {
    background: #7C3AED;
    color: white;
    border: none;
    border-radius: 8px;
    width: 45px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    transition: background 0.3s;
}

.ai-chat-input button:hover {
    background: #6D28D9;
}

.ai-quick-actions {
    padding: 15px 20px;
    border-top: 1px solid #334155;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: #0F172A;
}

.quick-action {
    padding: 10px 15px;
    background: rgba(124, 58, 237, 0.1);
    border: 1px solid rgba(124, 58, 237, 0.3);
    border-radius: 8px;
    color: #A78BFA;
    font-size: 0.9rem;
    cursor: pointer;
    text-align: left;
    transition: all 0.3s;
}

.quick-action:hover {
    background: rgba(124, 58, 237, 0.2);
    border-color: #7C3AED;
}

.typing .message-content {
    padding: 8px 16px;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    background: #94A3B8;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

.recommendations, .affiliate-links {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #475569;
}

.recommendations ul {
    margin: 10px 0 0 20px;
    padding: 0;
}

.recommendations li {
    margin-bottom: 8px;
    color: #CBD5E1;
}

.affiliate-links .links-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
}

.affiliate-link {
    display: block;
    padding: 8px 12px;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 6px;
    color: #34D399;
    text-decoration: none;
    font-size: 0.85rem;
    transition: all 0.3s;
}

.affiliate-link:hover {
    background: rgba(16, 185, 129, 0.2);
    border-color: #10B981;
}

.content-idea {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

.content-idea h4 {
    margin: 0 0 10px 0;
    color: white;
    font-size: 1rem;
}

.idea-meta {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 10px;
    font-size: 0.85rem;
}

.idea-type, .idea-audience, .idea-time {
    background: rgba(255, 255, 255, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
    color: #94A3B8;
}

.idea-services {
    margin-top: 10px;
}

.service-tag {
    display: inline-block;
    background: rgba(124, 58, 237, 0.2);
    color: #A78BFA;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    margin: 4px 4px 4px 0;
}
</style>
`;

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç
document.head.insertAdjacentHTML('beforeend', chatStyles);

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑ HTML
window.askQuestion = function(question) {
    if (window.chatAssistant) {
        window.chatAssistant.askQuestion(question);
    }
};

window.generateContentIdeas = function() {
    if (window.chatAssistant) {
        window.chatAssistant.generateContentIdeas();
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    window.chatAssistant = new AIChatInterface();
});
// ml-analytics.js
class MLAnalytics {
    constructor() {
        this.model = null;
        this.trainingData = [];
        this.predictions = {};
    }
    
    async initialize() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        await this.loadHistoricalData();
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –∏–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–æ–≤–æ–π
        await this.loadOrTrainModel();
        
        console.log('ML Analytics initialized');
    }
    
    async loadHistoricalData() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–∫–∞—Ö, –∫–æ–Ω–≤–µ—Ä—Å–∏—è—Ö, –¥–æ—Ö–æ–¥–∞—Ö
        const response = await fetch('/api/analytics/historical');
        const data = await response.json();
        
        this.trainingData = data.map(item => ({
            features: this.extractFeatures(item),
            label: item.converted ? 1 : 0,
            revenue: item.revenue || 0
        }));
    }
    
    extractFeatures(data) {
        return [
            data.timeOfDay / 24, // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫
            data.dayOfWeek / 7,  // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
            data.device === 'mobile' ? 1 : 0,
            data.device === 'desktop' ? 1 : 0,
            data.source === 'organic' ? 1 : 0,
            data.source === 'social' ? 1 : 0,
            data.source === 'referral' ? 1 : 0,
            data.affiliateScore || 0.5,
            data.previousClicks || 0,
            data.sessionDuration || 0
        ];
    }
    
    async loadOrTrainModel() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º TensorFlow.js –¥–ª—è ML
        if (typeof tf === 'undefined') {
            console.warn('TensorFlow.js not loaded');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        try {
            this.model = await tf.loadLayersModel('/models/conversion-model.json');
            console.log('Model loaded from cache');
        } catch (error) {
            console.log('Training new model...');
            await this.trainModel();
        }
    }
    
    async trainModel() {
        const tf = window.tf;
        
        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å
        this.model = tf.sequential();
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–∏
        this.model.add(tf.layers.dense({
            units: 16,
            activation: 'relu',
            inputShape: [10]
        }));
        
        this.model.add(tf.layers.dropout({ rate: 0.2 }));
        
        this.model.add(tf.layers.dense({
            units: 8,
            activation: 'relu'
        }));
        
        this.model.add(tf.layers.dense({
            units: 1,
            activation: 'sigmoid'
        }));
        
        // –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å
        this.model.compile({
            optimizer: tf.train.adam(0.001),
            loss: 'binaryCrossentropy',
            metrics: ['accuracy']
        });
        
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
        const xs = tf.tensor2d(
            this.trainingData.map(d => d.features)
        );
        
        const ys = tf.tensor2d(
            this.trainingData.map(d => [d.label]),
            [this.trainingData.length, 1]
        );
        
        // –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
        await this.model.fit(xs, ys, {
            epochs: 50,
            batchSize: 32,
            validationSplit: 0.2,
            callbacks: {
                onEpochEnd: (epoch, logs) => {
                    console.log(`Epoch ${epoch}: loss = ${logs.loss.toFixed(4)}`);
                }
            }
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–¥–µ–ª—å
        await this.model.save('localstorage://conversion-model');
        
        console.log('Model training complete');
    }
    
    async predictConversion(userData) {
        if (!this.model) {
            console.warn('Model not loaded');
            return 0.5; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        }
        
        const features = this.extractFeatures(userData);
        const input = tf.tensor2d([features]);
        
        const prediction = this.model.predict(input);
        const probability = (await prediction.data())[0];
        
        // –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
        input.dispose();
        prediction.dispose();
        
        return probability;
    }
    
    async predictRevenue(userData) {
        const conversionProbability = await this.predictConversion(userData);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –¥–æ—Ö–æ–¥–∞
        const similarUsers = this.findSimilarUsers(userData);
        const avgRevenue = similarUsers.reduce((sum, user) => 
            sum + (user.revenue || 0), 0
        ) / similarUsers.length || 0;
        
        return conversionProbability * avgRevenue;
    }
    
    findSimilarUsers(userData) {
        const userFeatures = this.extractFeatures(userData);
        
        return this.trainingData
            .filter(data => {
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å –ø–æ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–π –±–ª–∏–∑–æ—Å—Ç–∏
                const similarity = this.cosineSimilarity(
                    userFeatures,
                    data.features
                );
                return similarity > 0.7; // –ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏
            })
            .slice(0, 10); // –ë–µ—Ä–µ–º 10 –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ—Ö–æ–∂–∏—Ö
    }
    
    cosineSimilarity(vec1, vec2) {
        let dotProduct = 0;
        let norm1 = 0;
        let norm2 = 0;
        
        for (let i = 0; i < vec1.length; i++) {
            dotProduct += vec1[i] * vec2[i];
            norm1 += vec1[i] ** 2;
            norm2 += vec2[i] ** 2;
        }
        
        norm1 = Math.sqrt(norm1);
        norm2 = Math.sqrt(norm2);
        
        if (norm1 === 0 || norm2 === 0) return 0;
        return dotProduct / (norm1 * norm2);
    }
    
    async generateRecommendations(userId) {
        const userData = await this.getUserData(userId);
        const predictions = await this.getUserPredictions(userData);
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
        const recommendations = [];
        
        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        if (predictions.bestTime) {
            recommendations.push({
                type: 'timing',
                title: '–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏',
                description: `–ü—É–±–ª–∏–∫—É–π—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç –≤ ${predictions.bestTime} –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Å–∏–∏`,
                priority: 'high'
            });
        }
        
        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        if (predictions.bestContentType) {
            recommendations.push({
                type: 'content',
                title: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞',
                description: `–§–æ–∫—É—Å –Ω–∞ ${predictions.bestContentType} –∫–æ–Ω—Ç–µ–Ω—Ç–µ`,
                priority: 'medium'
            });
        }
        
        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º
        if (predictions.topServices) {
            recommendations.push({
                type: 'services',
                title: '–õ—É—á—à–∏–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è',
                description: `–°–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞: ${predictions.topServices.join(', ')}`,
                priority: 'high'
            });
        }
        
        return recommendations;
    }
    
    async getUserPredictions(userData) {
        const predictions = {
            conversionProbability: await this.predictConversion(userData),
            estimatedRevenue: await this.predictRevenue(userData),
            bestTime: this.calculateBestTime(userData),
            bestContentType: this.predictBestContentType(userData),
            topServices: await this.predictTopServices(userData)
        };
        
        return predictions;
    }
    
    calculateBestTime(userData) {
        // –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        const hourlyData = this.analyzeHourlyPerformance();
        
        // –ù–∞—Ö–æ–¥–∏–º –≤—Ä–µ–º—è —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Å–∏–µ–π
        const bestHour = Object.entries(hourlyData)
            .reduce((best, [hour, data]) => 
                data.conversionRate > best.conversionRate ? 
                { hour, ...data } : best
            );
        
        return `${bestHour.hour}:00`;
    }
    
    analyzeHourlyPerformance() {
        const hourlyData = {};
        
        for (let hour = 0; hour < 24; hour++) {
            hourlyData[hour] = {
                clicks: 0,
                conversions: 0,
                conversionRate: 0
            };
        }
        
        // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —á–∞—Å–∞–º
        this.trainingData.forEach(data => {
            const hour = Math.floor(data.features[0] * 24);
            hourlyData[hour].clicks++;
            if (data.label === 1) {
                hourlyData[hour].conversions++;
            }
        });
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Å–∏—é
        Object.values(hourlyData).forEach(data => {
            data.conversionRate = data.clicks > 0 ? 
                data.conversions / data.clicks : 0;
        });
        
        return hourlyData;
    }
    
    predictBestContentType(userData) {
        const contentTypes = ['article', 'video', 'social', 'email'];
        
        // –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
        const weights = {
            article: userData.features[6] || 0.5, // referral source
            video: userData.features[4] || 0.5,   // organic source
            social: userData.features[5] || 0.5,  // social source
            email: 0.3 // –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
        };
        
        return Object.entries(weights)
            .reduce((best, [type, weight]) => 
                weight > best.weight ? { type, weight } : best
            ).type;
    }
    
    async predictTopServices(userData, limit = 3) {
        const services = ['yandex', 'kandinsky', 'gigachat', 'deepseek'];
        
        // –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
        const predictions = await Promise.all(
            services.map(async service => {
                const serviceData = { ...userData, service };
                const probability = await this.predictConversion(serviceData);
                return { service, probability };
            })
        );
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
        predictions.sort((a, b) => b.probability - a.probability);
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø N —Å–µ—Ä–≤–∏—Å–æ–≤
        return predictions.slice(0, limit).map(p => p.service);
    }
}

// –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
class PredictionVisualizer {
    constructor(mlAnalytics) {
        this.ml = mlAnalytics;
        this.charts = {};
    }
    
    async renderUserPredictions(userId) {
        const userData = await this.ml.getUserData(userId);
        const predictions = await this.ml.getUserPredictions(userData);
        
        this.renderConversionProbability(predictions);
        this.renderRevenuePrediction(predictions);
        this.renderTimeAnalysis(predictions);
        this.renderServiceRecommendations(predictions);
    }
    
    renderConversionProbability(predictions) {
        const ctx = document.getElementById('conversionChart').getContext('2d');
        
        this.charts.conversion = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['–ö–æ–Ω–≤–µ—Ä—Å–∏—è', '–ù–µ—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏'],
                datasets: [{
                    data: [
                        predictions.conversionProbability * 100,
                        (1 - predictions.conversionProbability) * 100
                    ],
                    backgroundColor: [
                        '#10B981',
                        '#EF4444'
                    ]
                }]
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: `–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏–∏: ${(predictions.conversionProbability * 100).toFixed(1)}%`
                    }
                }
            }
        });
    }
    
    renderRevenuePrediction(predictions) {
        const ctx = document.getElementById('revenuePredictionChart').getContext('2d');
        
        // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ 30 –¥–Ω–µ–π
        const days = Array.from({ length: 30 }, (_, i) => i + 1);
        const revenue = days.map(day => 
            predictions.estimatedRevenue * day * (0.8 + Math.random() * 0.4)
        );
        
        this.charts.revenue = new Chart(ctx, {
            type: 'line',
            data: {
                labels: days,
                datasets: [{
                    label: '–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –¥–æ—Ö–æ–¥',
                    data: revenue,
                    borderColor: '#7C3AED',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: `–ü—Ä–æ–≥–Ω–æ–∑ –¥–æ—Ö–æ–¥–∞: ${predictions.estimatedRevenue.toFixed(2)} ‚ÇΩ/–¥–µ–Ω—å`
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: '–î–æ—Ö–æ–¥ (‚ÇΩ)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–î–Ω–∏'
                        }
                    }
                }
            }
        });
    }
    
    renderTimeAnalysis(predictions) {
        const hourlyData = this.ml.analyzeHourlyPerformance();
        const ctx = document.getElementById('timeChart').getContext('2d');
        
        const hours = Object.keys(hourlyData);
        const conversionRates = Object.values(hourlyData).map(d => d.conversionRate * 100);
        
        this.charts.time = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: hours.map(h => `${h}:00`),
                datasets: [{
                    label: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ —á–∞—Å–∞–º (%)',
                    data: conversionRates,
                    backgroundColor: hours.map(h => 
                        h === parseInt(predictions.bestTime) ? '#10B981' : '#3B82F6'
                    )
                }]
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: `–õ—É—á—à–µ–µ –≤—Ä–µ–º—è: ${predictions.bestTime}`
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è (%)'
                        }
                    }
                }
            }
        });
    }
    
    renderServiceRecommendations(predictions) {
        const container = document.getElementById('serviceRecommendations');
        container.innerHTML = '';
        
        predictions.topServices.forEach((service, index) => {
            const serviceCard = this.createServiceCard(service, index + 1);
            container.appendChild(serviceCard);
        });
    }
    
    createServiceCard(serviceName, rank) {
        const card = document.createElement('div');
        card.className = 'service-recommendation-card';
        
        const serviceInfo = {
            yandex: {
                name: '–Ø–Ω–¥–µ–∫—Å GPT',
                commission: '30%',
                color: '#FF3333'
            },
            kandinsky: {
                name: 'Kandinsky',
                commission: '25%',
                color: '#7C3AED'
            },
            gigachat: {
                name: 'GigaChat',
                commission: '20%',
                color: '#10B981'
            },
            deepseek: {
                name: 'DeepSeek',
                commission: '15%',
                color: '#3B82F6'
            }
        };
        
        const info = serviceInfo[serviceName] || {
            name: serviceName,
            commission: '10%',
            color: '#6B7280'
        };
        
        card.innerHTML = `
            <div class="service-rank">#${rank}</div>
            <div class="service-icon" style="background: ${info.color}20; border-color: ${info.color}">
                <i class="fas fa-robot" style="color: ${info.color}"></i>
            </div>
            <div class="service-info">
                <h4>${info.name}</h4>
                <p class="service-commission">–ö–æ–º–∏—Å—Å–∏—è: ${info.commission}</p>
                <p class="service-recommendation">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –≤–∞—à–µ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏</p>
            </div>
            <a href="/affiliate/${serviceName}" class="service-action">
                <i class="fas fa-arrow-right"></i>
            </a>
        `;
        
        return card;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
document.addEventListener('DOMContentLoaded', async function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ML –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    const mlAnalytics = new MLAnalytics();
    await mlAnalytics.initialize();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    const visualizer = new PredictionVisualizer(mlAnalytics);
    
    // –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userId = getCurrentUserId();
    if (userId) {
        await visualizer.renderUserPredictions(userId);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    setInterval(async () => {
        if (userId) {
            await visualizer.renderUserPredictions(userId);
        }
    }, 300000); // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
});
// partner-ecosystem.js
class PartnerEcosystem {
    constructor() {
        this.partners = new Map();
        this.services = new Map();
        this.commissions = new Map();
        this.tiers = {
            bronze: { minRevenue: 0, commissionMultiplier: 1.0 },
            silver: { minRevenue: 10000, commissionMultiplier: 1.1 },
            gold: { minRevenue: 50000, commissionMultiplier: 1.2 },
            platinum: { minRevenue: 200000, commissionMultiplier: 1.3 }
        };
    }
    
    async initialize() {
        await this.loadPartners();
        await this.loadServices();
        await this.calculateCommissions();
        this.setupAutoUpgrades();
    }
    
    async loadPartners() {
        const response = await fetch('/api/ecosystem/partners');
        const partners = await response.json();
        
        partners.forEach(partner => {
            this.partners.set(partner.id, {
                ...partner,
                tier: this.calculateTier(partner),
                referrals: [],
                performance: this.calculatePerformance(partner)
            });
        });
    }
    
    calculateTier(partner) {
        const revenue = partner.monthlyRevenue || 0;
        
        for (const [tierName, tierConfig] of Object.entries(this.tiers).reverse()) {
            if (revenue >= tierConfig.minRevenue) {
                return tierName;
            }
        }
        
        return 'bronze';
    }
    
    calculatePerformance(partner) {
        const metrics = {
            conversionRate: partner.conversions / partner.clicks || 0,
            averageOrderValue: partner.revenue / partner.conversions || 0,
            retentionRate: this.calculateRetention(partner),
            growthRate: this.calculateGrowth(partner)
        };
        
        // –û–±—â–∏–π –ø–µ—Ä—Ñ–æ—Ä–º–∞–Ω—Å-—Å–∫–æ—Ä (0-100)
        const score = (
            metrics.conversionRate * 40 +
            metrics.averageOrderValue * 30 +
            metrics.retentionRate * 20 +
            metrics.growthRate * 10
        );
        
        return { ...metrics, score };
    }
    
    calculateRetention(partner) {
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ—Ç–µ–Ω—à–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫
        const repeatPurchases = partner.repeatCustomers || 0;
        const totalCustomers = partner.totalCustomers || 1;
        return repeatPurchases / totalCustomers;
    }
    
    calculateGrowth(partner) {
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–æ—Å—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
        const currentRevenue = partner.currentMonthRevenue || 0;
        const previousRevenue = partner.previousMonthRevenue || 0;
        
        if (previousRevenue === 0) return 1.0;
        return currentRevenue / previousRevenue;
    }
    
    async loadServices() {
        const response = await fetch('/api/ecosystem/services');
        const services = await response.json();
        
        services.forEach(service => {
            this.services.set(service.id, {
                ...service,
                partners: [],
                performance: this.calculateServicePerformance(service)
            });
        });
    }
    
    calculateServicePerformance(service) {
        return {
            totalRevenue: service.revenue || 0,
            averageCommission: service.averageCommission || 0,
            partnerSatisfaction: service.satisfactionScore || 0,
            growthTrend: service.growthTrend || 0
        };
    }
    
    async calculateCommissions() {
        for (const [partnerId, partner] of this.partners) {
            const tier = this.tiers[partner.tier];
            let totalCommission = 0;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
            partner.services?.forEach(serviceData => {
                const service = this.services.get(serviceData.serviceId);
                if (service) {
                    const baseCommission = serviceData.revenue * (service.commissionRate / 100);
                    const tierBonus = baseCommission * (tier.commissionMultiplier - 1);
                    const performanceBonus = baseCommission * (partner.performance.score / 100) * 0.1;
                    
                    const total = baseCommission + tierBonus + performanceBonus;
                    
                    this.commissions.set(`${partnerId}_${serviceData.serviceId}`, {
                        partnerId,
                        serviceId: serviceData.serviceId,
                        baseCommission,
                        tierBonus,
                        performanceBonus,
                        total,
                        date: new Date().toISOString().split('T')[0]
                    });
                    
                    totalCommission += total;
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä—Ç–Ω—ë—Ä–∞
            partner.totalCommission = totalCommission;
            partner.pendingPayout = totalCommission;
        }
    }
    
    setupAutoUpgrades() {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∏—Ä–æ–≤ –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
        setInterval(async () => {
            await this.checkAndUpgradeTiers();
        }, 24 * 60 * 60 * 1000);
    }
    
    async checkAndUpgradeTiers() {
        for (const [partnerId, partner] of this.partners) {
            const currentTier = partner.tier;
            const newTier = this.calculateTier(partner);
            
            if (newTier !== currentTier) {
                await this.upgradePartnerTier(partnerId, newTier);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                await this.sendTierUpgradeNotification(partner, currentTier, newTier);
            }
        }
    }
    
    async upgradePartnerTier(partnerId, newTier) {
        const partner = this.partners.get(partnerId);
        partner.tier = newTier;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        await fetch(`/api/ecosystem/partners/${partnerId}/tier`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tier: newTier })
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–∏—Å—Å–∏–∏
        await this.calculateCommissions();
    }
    
    async sendTierUpgradeNotification(partner, oldTier, newTier) {
        const message = `
üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–≤—ã—à–µ–Ω–∏–µ–º —É—Ä–æ–≤–Ω—è!
        
–í—ã –ø–µ—Ä–µ—à–ª–∏ —Å —É—Ä–æ–≤–Ω—è ${oldTier.toUpperCase()} –Ω–∞ —É—Ä–æ–≤–µ–Ω—å ${newTier.toUpperCase()}!

–ù–æ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∞ –Ω–∞ ${Math.round((this.tiers[newTier].commissionMultiplier - 1) * 100)}%
‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
‚Ä¢ –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
‚Ä¢ –î–æ—Å—Ç—É–ø –∫ –Ω–æ–≤—ã–º —Å–µ—Ä–≤–∏—Å–∞–º

–í–∞—à —Ç–µ–∫—É—â–∏–π –¥–æ—Ö–æ–¥: ${partner.monthlyRevenue} ‚ÇΩ
        `;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email
        await fetch('/api/notifications/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to: partner.email,
                subject: '–ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≤ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ AI Catalog',
                message: message
            })
        });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
        await this.sendTelegramNotification(partner.telegramId, message);
    }
    
    async addNewService(serviceData) {
        const serviceId = `service_${Date.now()}`;
        const service = {
            id: serviceId,
            ...serviceData,
            createdAt: new Date().toISOString(),
            active: true,
            partnersCount: 0
        };
        
        this.services.set(serviceId, service);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–æ–≤—ã–º –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º
        await this.notifyPartnersAboutNewService(service);
        
        return serviceId;
    }
    
    async notifyPartnersAboutNewService(service) {
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–º –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω —Å–µ—Ä–≤–∏—Å
        const interestedPartners = Array.from(this.partners.values())
            .filter(partner => this.isServiceRelevantForPartner(service, partner))
            .slice(0, 50); // –õ–∏–º–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        
        for (const partner of interestedPartners) {
            await this.sendServiceNotification(partner, service);
        }
    }
    
    isServiceRelevantForPartner(service, partner) {
        // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        const partnerCategories = partner.interests || [];
        return service.categories?.some(category => 
            partnerCategories.includes(category)
        ) || false;
    }
    
    async sendServiceNotification(partner, service) {
        const message = `
üéØ –ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è: ${service.name}
        
${service.description}

üîë –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
${service.features?.map(f => `‚Ä¢ ${f}`).join('\n')}

üí∞ –ö–æ–º–∏—Å—Å–∏—è: ${service.commissionRate}%
üéÅ –ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –ø–µ—Ä–≤—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤: ${service.promoCode || 'NEWSERVICE2024'}

–ù–∞—á–∞—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ: ${service.affiliateLink}
        `;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        if (partner.notificationsEnabled) {
            await fetch('/api/notifications/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: partner.email,
                    subject: `–ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å: ${service.name}`,
                    message: message
                })
            });
        }
    }
    
    async generatePartnerReport(partnerId, period = 'month') {
        const partner = this.partners.get(partnerId);
        if (!partner) return null;
        
        const report = {
            partner: {
                id: partner.id,
                name: partner.name,
                tier: partner.tier,
                email: partner.email
            },
            period: period,
            generatedAt: new Date().toISOString(),
            summary: await this.generateSummary(partnerId, period),
            services: await this.generateServiceBreakdown(partnerId, period),
            growth: await this.generateGrowthAnalysis(partnerId, period),
            recommendations: await this.generateRecommendations(partnerId),
            comparison: await this.generatePeerComparison(partnerId)
        };
        
        return report;
    }
    
    async generateSummary(partnerId, period) {
        const partner = this.partners.get(partnerId);
        
        return {
            totalClicks: partner.clicks || 0,
            totalConversions: partner.conversions || 0,
            totalRevenue: partner.revenue || 0,
            totalCommission: partner.totalCommission || 0,
            conversionRate: ((partner.conversions / partner.clicks) * 100 || 0).toFixed(2) + '%',
            averageOrderValue: (partner.revenue / partner.conversions || 0).toFixed(2) + ' ‚ÇΩ'
        };
    }
    
    async generateServiceBreakdown(partnerId, period) {
        const commissions = Array.from(this.commissions.values())
            .filter(c => c.partnerId === partnerId)
            .reduce((acc, commission) => {
                const service = this.services.get(commission.serviceId);
                if (!acc[commission.serviceId]) {
                    acc[commission.serviceId] = {
                        serviceName: service?.name || 'Unknown',
                        clicks: 0,
                        conversions: 0,
                        revenue: 0,
                        commission: 0
                    };
                }
                
                acc[commission.serviceId].commission += commission.total;
                return acc;
            }, {});
        
        return Object.values(commissions);
    }
    
    async generateGrowthAnalysis(partnerId, period) {
        const partner = this.partners.get(partnerId);
        
        // –ó–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        return {
            monthOverMonthGrowth: (Math.random() * 50).toFixed(2) + '%',
            quarterOverQuarterGrowth: (Math.random() * 100).toFixed(2) + '%',
            yearOverYearGrowth: (Math.random() * 200).toFixed(2) + '%',
            projectedNextMonth: Math.round(partner.monthlyRevenue * (1 + Math.random() * 0.3)) + ' ‚ÇΩ'
        };
    }
    
    async generateRecommendations(partnerId) {
        const partner = this.partners.get(partnerId);
        const recommendations = [];
        
        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        if (partner.performance.conversionRate < 0.02) {
            recommendations.push({
                type: 'conversion',
                priority: 'high',
                title: '–£–≤–µ–ª–∏—á—å—Ç–µ –∫–æ–Ω–≤–µ—Ä—Å–∏—é',
                description: '–í–∞—à–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏—è –Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ª—É—á—à–∏—Ç—å –ø—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é.',
                action: '–ü—Ä–æ–≤–µ—Å—Ç–∏ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫'
            });
        }
        
        if (partner.tier === 'bronze' && partner.monthlyRevenue > 8000) {
            recommendations.push({
                type: 'tier',
                priority: 'medium',
                title: '–ë–ª–∏–∑–∫–æ –∫ –ø–æ–≤—ã—à–µ–Ω–∏—é —É—Ä–æ–≤–Ω—è',
                description: `–î–æ —É—Ä–æ–≤–Ω—è Silver –æ—Å—Ç–∞–ª–æ—Å—å ${10000 - partner.monthlyRevenue} ‚ÇΩ`,
                action: '–ê–∫—Ç–∏–≤–Ω–µ–µ –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å —Ç–æ–ø–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã'
            });
        }
        
        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º
        const serviceBreakdown = await this.generateServiceBreakdown(partnerId, 'month');
        if (serviceBreakdown.length < 3) {
            recommendations.push({
                type: 'diversification',
                priority: 'medium',
                title: '–î–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤',
                description: '–í—ã –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç–µ –º–∞–ª–æ —Å–µ—Ä–≤–∏—Å–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –µ—â—ë 1-2 –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Ä–∏—Å–∫–æ–≤.',
                action: '–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞'
            });
        }
        
        return recommendations;
    }
    
    async generatePeerComparison(partnerId) {
        const partner = this.partners.get(partnerId);
        const sameTierPartners = Array.from(this.partners.values())
            .filter(p => p.tier === partner.tier && p.id !== partnerId)
            .slice(0, 10); // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å 10 –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏ —Ç–æ–≥–æ –∂–µ —É—Ä–æ–≤–Ω—è
        
        const metrics = {
            averageConversionRate: this.calculateAverage(sameTierPartners, 'conversionRate'),
            averageRevenue: this.calculateAverage(sameTierPartners, 'monthlyRevenue'),
            averageCommission: this.calculateAverage(sameTierPartners, 'totalCommission')
        };
        
        return {
            peerCount: sameTierPartners.length,
            yourPosition: this.calculatePosition(partner, sameTierPartners),
            metrics: metrics,
            comparison: {
                conversionRate: this.compareMetric(partner.performance.conversionRate, metrics.averageConversionRate),
                revenue: this.compareMetric(partner.monthlyRevenue, metrics.averageRevenue),
                commission: this.compareMetric(partner.totalCommission, metrics.averageCommission)
            }
        };
    }
    
    calculateAverage(partners, metric) {
        const values = partners.map(p => p[metric] || p.performance?.[metric] || 0);
        return values.reduce((sum, val) => sum + val, 0) / values.length;
    }
    
    calculatePosition(partner, peers) {
        const sorted = [...peers, partner]
            .sort((a, b) => (b.monthlyRevenue || 0) - (a.monthlyRevenue || 0));
        
        return sorted.findIndex(p => p.id === partner.id) + 1;
    }
    
    compareMetric(yourValue, averageValue) {
        const difference = yourValue - averageValue;
        const percentage = (difference / averageValue) * 100;
        
        return {
            difference: difference.toFixed(2),
            percentage: percentage.toFixed(2) + '%',
            status: percentage >= 0 ? 'above' : 'below'
        };
    }
    
    async exportReport(report, format = 'pdf') {
        const exportFormats = {
            pdf: this.exportToPDF,
            excel: this.exportToExcel,
            json: this.exportToJSON,
            html: this.exportToHTML
        };
        
        const exporter = exportFormats[format];
        if (exporter) {
            return await exporter(report);
        }
        
        throw new Error(`Unsupported format: ${format}`);
    }
    
    async exportToPDF(report) {
        // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF
        const html = this.generateHTMLReport(report);
        
        const response = await fetch('/api/export/pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ html: html })
        });
        
        return await response.blob();
    }
    
    generateHTMLReport(report) {
        return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –æ—Ç—á–µ—Ç - ${report.partner.name}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { text-align: center; margin-bottom: 40px; }
        .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .metric-card { background: #f5f5f5; padding: 20px; border-radius: 10px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; color: #7C3AED; }
        .recommendations { margin: 40px 0; }
        .recommendation { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 10px 0; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –æ—Ç—á–µ—Ç</h1>
        <p>–ü–µ—Ä–∏–æ–¥: ${report.period} | –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${new Date(report.generatedAt).toLocaleDateString('ru-RU')}</p>
    </div>
    
    <div class="summary">
        <div class="metric-card">
            <div class="metric-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥</div>
            <div class="metric-value">${report.summary.totalRevenue} ‚ÇΩ</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">–ö–æ–º–∏—Å—Å–∏—è</div>
            <div class="metric-value">${report.summary.totalCommission} ‚ÇΩ</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
            <div class="metric-value">${report.summary.conversionRate}</div>
        </div>
    </div>
    
    <div class="recommendations">
        <h2>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
        ${report.recommendations.map(rec => `
            <div class="recommendation">
                <strong>${rec.title}</strong>
                <p>${rec.description}</p>
                <small>–î–µ–π—Å—Ç–≤–∏–µ: ${rec.action}</small>
            </div>
        `).join('')}
    </div>
</body>
</html>
        `;
    }
}

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø–∞–Ω–µ–ª–∏
class PartnerDashboard {
    constructor(ecosystem) {
        this.ecosystem = ecosystem;
        this.currentPartnerId = null;
        this.charts = {};
    }
    
    async initialize(partnerId) {
        this.currentPartnerId = partnerId;
        
        await this.loadPartnerData();
        this.renderDashboard();
        this.setupRealTimeUpdates();
    }
    
    async loadPartnerData() {
        this.partnerData = await this.ecosystem.generatePartnerReport(
            this.currentPartnerId,
            'month'
        );
        
        this.stats = {
            daily: await this.fetchDailyStats(),
            weekly: await this.fetchWeeklyStats(),
            monthly: await this.fetchMonthlyStats()
        };
    }
    
    renderDashboard() {
        this.renderHeader();
        this.renderQuickStats();
        this.renderRevenueChart();
        this.renderServicePerformance();
        this.renderRecommendations();
        this.renderPeerComparison();
    }
    
    renderHeader() {
        const header = document.getElementById('dashboardHeader');
        if (!header) return;
        
        header.innerHTML = `
            <div class="partner-header">
                <div class="partner-info">
                    <h1>–ü—Ä–∏–≤–µ—Ç, ${this.partnerData.partner.name}!</h1>
                    <div class="partner-tier">
                        <span class="tier-badge tier-${this.partnerData.partner.tier}">
                            ${this.partnerData.partner.tier.toUpperCase()}
                        </span>
                        <span class="next-tier-info">
                            –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: 
                            ${this.calculateNextTierRequirement()}
                        </span>
                    </div>
                </div>
                
                <div class="partner-actions">
                    <button class="btn btn-primary" onclick="exportReport('pdf')">
                        <i class="fas fa-file-pdf"></i> –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞
                    </button>
                    <button class="btn btn-secondary" onclick="showWithdrawalModal()">
                        <i class="fas fa-wallet"></i> –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤
                    </button>
                </div>
            </div>
        `;
    }
    
    calculateNextTierRequirement() {
        const currentTier = this.partnerData.partner.tier;
        const tiers = ['bronze', 'silver', 'gold', 'platinum'];
        const currentIndex = tiers.indexOf(currentTier);
        
        if (currentIndex >= tiers.length - 1) {
            return '–í—ã –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ!';
        }
        
        const nextTier = tiers[currentIndex + 1];
        const nextTierConfig = this.ecosystem.tiers[nextTier];
        const currentRevenue = this.partnerData.summary.totalRevenue;
        
        const required = nextTierConfig.minRevenue - currentRevenue;
        
        if (required <= 0) {
            return '–ì–æ—Ç–æ–≤–æ –∫ –ø–æ–≤—ã—à–µ–Ω–∏—é!';
        }
        
        return `${required} ‚ÇΩ`;
    }
    
    renderQuickStats() {
        const container = document.getElementById('quickStats');
        if (!container) return;
        
        container.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">${this.partnerData.summary.totalRevenue} ‚ÇΩ</div>
                        <div class="stat-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥</div>
                        <div class="stat-trend trend-up">
                            <i class="fas fa-arrow-up"></i> ${this.partnerData.growth.monthOverMonthGrowth}
                        </div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-hand-holding-usd"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">${this.partnerData.summary.totalCommission} ‚ÇΩ</div>
                        <div class="stat-label">–í–∞—à–∞ –∫–æ–º–∏—Å—Å–∏—è</div>
                        <div class="stat-trend trend-up">
                            <i class="fas fa-arrow-up"></i> ${this.partnerData.growth.monthOverMonthGrowth}
                        </div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">${this.partnerData.summary.conversionRate}</div>
                        <div class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
                        <div class="stat-trend trend-${this.partnerData.comparison?.conversionRate?.status}">
                            <i class="fas fa-arrow-${this.partnerData.comparison?.conversionRate?.status === 'above' ? 'up' : 'down'}"></i>
                            ${this.partnerData.comparison?.conversionRate?.percentage}
                        </div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">${this.partnerData.comparison?.yourPosition || 'N/A'}</div>
                        <div class="stat-label">–ú–µ—Å—Ç–æ —Å—Ä–µ–¥–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div>
                        <div class="stat-trend">
                            –í—Å–µ–≥–æ: ${this.partnerData.comparison?.peerCount || 0} –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    renderRevenueChart() {
        const ctx = document.getElementById('revenueChart');
        if (!ctx) return;
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Chart.js
        this.charts.revenue = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: this.getLast30Days(),
                datasets: [
                    {
                        label: '–î–æ—Ö–æ–¥',
                        data: this.generateRevenueData(),
                        borderColor: '#7C3AED',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: '–ö–æ–º–∏—Å—Å–∏—è',
                        data: this.generateCommissionData(),
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–∞ –∏ –∫–æ–º–∏—Å—Å–∏–∏'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–°—É–º–º–∞ (‚ÇΩ)'
                        }
                    }
                }
            }
        });
    }
    
    renderServicePerformance() {
        const container = document.getElementById('servicePerformance');
        if (!container) return;
        
        const services = this.partnerData.services || [];
        
        container.innerHTML = `
            <h3>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º</h3>
            <div class="services-grid">
                ${services.map(service => `
                    <div class="service-performance-card">
                        <div class="service-header">
                            <h4>${service.serviceName}</h4>
                            <span class="service-revenue">${service.revenue} ‚ÇΩ</span>
                        </div>
                        
                        <div class="service-metrics">
                            <div class="metric">
                                <span class="metric-label">–ö–æ–º–∏—Å—Å–∏—è</span>
                                <span class="metric-value">${service.commission} ‚ÇΩ</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">–ö–æ–º–∏—Å—Å–∏—è %</span>
                                <span class="metric-value">
                                    ${((service.commission / service.revenue) * 100 || 0).toFixed(1)}%
                                </span>
                            </div>
                        </div>
                        
                        <div class="service-actions">
                            <a href="/service/${service.serviceId}" class="btn btn-sm btn-outline">
                                <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                            </a>
                            <button class="btn btn-sm btn-primary" onclick="generateServiceReport('${service.serviceId}')">
                                <i class="fas fa-file-alt"></i> –û—Ç—á–µ—Ç
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    renderRecommendations() {
        const container = document.getElementById('recommendations');
        if (!container) return;
        
        const recommendations = this.partnerData.recommendations || [];
        
        if (recommendations.length === 0) {
            container.innerHTML = `
                <div class="no-recommendations">
                    <i class="fas fa-check-circle"></i>
                    <p>–í—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –Ω–æ—Ä–º–µ. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–æ—Å—Ç–∞</h3>
            <div class="recommendations-list">
                ${recommendations.map(rec => `
                    <div class="recommendation-card priority-${rec.priority}">
                        <div class="recommendation-icon">
                            ${this.getRecommendationIcon(rec.type)}
                        </div>
                        <div class="recommendation-content">
                            <h4>${rec.title}</h4>
                            <p>${rec.description}</p>
                            <div class="recommendation-action">
                                <strong>–î–µ–π—Å—Ç–≤–∏–µ:</strong> ${rec.action}
                            </div>
                        </div>
                        <div class="recommendation-priority">
                            <span class="priority-badge">${rec.priority === 'high' ? '–í—ã—Å–æ–∫–∏–π' : '–°—Ä–µ–¥–Ω–∏–π'}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    getRecommendationIcon(type) {
        const icons = {
            conversion: 'fas fa-percentage',
            tier: 'fas fa-level-up-alt',
            diversification: 'fas fa-layer-group',
            content: 'fas fa-pen-alt',
            timing: 'fas fa-clock'
        };
        
        return `<i class="${icons[type] || 'fas fa-lightbulb'}"></i>`;
    }
    
    renderPeerComparison() {
        const container = document.getElementById('peerComparison');
        if (!container || !this.partnerData.comparison) return;
        
        const comparison = this.partnerData.comparison;
        
        container.innerHTML = `
            <h3>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏</h3>
            <div class="comparison-grid">
                <div class="comparison-card">
                    <h4>–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è</h4>
                    <div class="position-display">
                        <div class="position-number">${comparison.yourPosition}</div>
                        <div class="position-label">–∏–∑ ${comparison.peerCount}</div>
                    </div>
                </div>
                
                <div class="comparison-card">
                    <h4>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</h4>
                    <div class="comparison-result ${comparison.comparison.conversionRate.status}">
                        <div class="comparison-value">
                            ${comparison.comparison.conversionRate.percentage}
                        </div>
                        <div class="comparison-label">
                            ${comparison.comparison.conversionRate.status === 'above' ? '–í—ã—à–µ' : '–ù–∏–∂–µ'} —Å—Ä–µ–¥–Ω–µ–≥–æ
                        </div>
                    </div>
                </div>
                
                <div class="comparison-card">
                    <h4>–î–æ—Ö–æ–¥</h4>
                    <div class="comparison-result ${comparison.comparison.revenue.status}">
                        <div class="comparison-value">
                            ${comparison.comparison.revenue.percentage}
                        </div>
                        <div class="comparison-label">
                            ${comparison.comparison.revenue.status === 'above' ? '–í—ã—à–µ' : '–ù–∏–∂–µ'} —Å—Ä–µ–¥–Ω–µ–≥–æ
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    setupRealTimeUpdates() {
        // WebSocket –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        this.socket = new WebSocket('wss://ai-catalog.ru/ws/partner-updates');
        
        this.socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleRealTimeUpdate(data);
        };
        
        this.socket.onopen = () => {
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
            this.socket.send(JSON.stringify({
                type: 'subscribe',
                partnerId: this.currentPartnerId
            }));
        };
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        setInterval(() => {
            this.refreshDashboard();
        }, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    }
    
    async handleRealTimeUpdate(update) {
        switch (update.type) {
            case 'conversion':
                await this.handleNewConversion(update.data);
                break;
            case 'commission':
                await this.handleNewCommission(update.data);
                break;
            case 'tier_change':
                await this.handleTierChange(update.data);
                break;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        await this.refreshDashboard();
    }
    
    async handleNewConversion(conversion) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        this.showNotification(
            `üéâ –ù–æ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è! +${conversion.amount} ‚ÇΩ`,
            'success'
        );
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        this.stats.daily.conversions++;
        this.stats.daily.revenue += conversion.amount;
    }
    
    async handleNewCommission(commission) {
        this.showNotification(
            `üí∞ –ù–∞—á–∏—Å–ª–µ–Ω–∞ –∫–æ–º–∏—Å—Å–∏—è: ${commission.amount} ‚ÇΩ`,
            'info'
        );
    }
    
    async handleTierChange(tierData) {
        this.showNotification(
            `üèÜ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å ${tierData.newTier.toUpperCase()}!`,
            'success'
        );
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        await this.loadPartnerData();
        this.renderHeader();
    }
    
    async refreshDashboard() {
        await this.loadPartnerData();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        this.renderQuickStats();
        this.renderRecommendations();
        this.renderPeerComparison();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
        if (this.charts.revenue) {
            this.charts.revenue.data.datasets[0].data = this.generateRevenueData();
            this.charts.revenue.data.datasets[1].data = this.generateCommissionData();
            this.charts.revenue.update();
        }
    }
    
    showNotification(message, type = 'info') {
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        document.body.appendChild(notification);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
    
    getLast30Days() {
        const days = [];
        for (let i = 29; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            days.push(date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }));
        }
        return days;
    }
    
    generateRevenueData() {
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        return Array.from({ length: 30 }, () => 
            Math.floor(Math.random() * 1000) + 500
        );
    }
    
    generateCommissionData() {
        return this.generateRevenueData().map(revenue => 
            Math.floor(revenue * (0.2 + Math.random() * 0.1))
        );
    }
    
    async fetchDailyStats() {
        const response = await fetch(`/api/partner/${this.currentPartnerId}/stats/daily`);
        return await response.json();
    }
    
    async fetchWeeklyStats() {
        const response = await fetch(`/api/partner/${this.currentPartnerId}/stats/weekly`);
        return await response.json();
    }
    
    async fetchMonthlyStats() {
        const response = await fetch(`/api/partner/${this.currentPartnerId}/stats/monthly`);
        return await response.json();
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
window.exportReport = async function(format) {
    if (window.partnerDashboard && window.partnerDashboard.partnerData) {
        const blob = await window.ecosystem.exportReport(
            window.partnerDashboard.partnerData,
            format
        );
        
        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
a.download = partner-report-${new Date().toISOString().split('T')[0]}.${format};
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
window.URL.revokeObjectURL(url);
}
};

window.generateServiceReport = async function(serviceId) {
const response = await fetch(/api/partner/service/${serviceId}/report);
const report = await response.json();
// –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –æ—Ç—á–µ—Ç–æ–º –ø–æ —Å–µ—Ä–≤–∏—Å—É
showServiceReportModal(report);
};

window.showWithdrawalModal = function() {
const modal = document.createElement('div');
modal.className = 'modal withdrawal-modal';
modal.innerHTML = `
<div class="modal-content">
<div class="modal-header">
<h3>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h3>
<button class="modal-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
</div>
        <div class="modal-body">
            <div class="balance-info">
                <p>–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞: <strong id="availableBalance">0 ‚ÇΩ</strong></p>
                <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 1000 ‚ÇΩ</p>
            </div>
            
            <form id="withdrawalForm">
                <div class="form-group">
                    <label>–°—É–º–º–∞ (‚ÇΩ)</label>
                    <input type="number" id="withdrawalAmount" min="1000" step="100" required>
                </div>
                
                <div class="form-group">
                    <label>–°–ø–æ—Å–æ–± –≤—ã–ø–ª–∞—Ç—ã</label>
                    <select id="withdrawalMethod" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±</option>
                        <option value="bank_card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
                        <option value="yoomoney">–ÆMoney</option>
                        <option value="qiwi">QIWI</option>
                        <option value="crypto">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ (USDT)</option>
                    </select>
                </div>
                
                <div id="methodDetails" style="display: none;">
                    <!-- –î–µ—Ç–∞–ª–∏ —Å–ø–æ—Å–æ–±–∞ –≤—ã–ø–ª–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                
                <div class="form-group">
                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea id="withdrawalComment" rows="2"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–≤–æ–¥
                </button>
            </form>
        </div>
    </div>
`;

document.body.appendChild(modal);

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å
loadAvailableBalance();

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
document.getElementById('withdrawalForm').addEventListener('submit', handleWithdrawalSubmit);

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–∞ –≤—ã–ø–ª–∞—Ç—ã
document.getElementById('withdrawalMethod').addEventListener('change', loadMethodDetails);
document.getElementById('availableBalance').textContent = 
    `${data.available} ‚ÇΩ`;
document.getElementById('withdrawalAmount').max = data.available;
if (!method) {
    container.style.display = 'none';
    return;
}

container.style.display = 'block';

// –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
const response = await fetch(`/api/withdrawal/methods/${method}/template`);
const template = await response.text();

container.innerHTML = template;
const formData = {
    amount: document.getElementById('withdrawalAmount').value,
    method: document.getElementById('withdrawalMethod').value,
    comment: document.getElementById('withdrawalComment').value,
    details: getMethodDetails()
};

try {
    const response = await fetch('/api/withdrawal/request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    });
    
    if (response.ok) {
        alert('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 1-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è.');
        document.querySelector('.withdrawal-modal').remove();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        if (window.partnerDashboard) {
            window.partnerDashboard.refreshDashboard();
        }
    } else {
        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞');
    }
} catch (error) {
    alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
}
switch(method) {
    case 'bank_card':
        details.cardNumber = document.getElementById('cardNumber')?.value;
        details.cardHolder = document.getElementById('cardHolder')?.value;
        break;
    case 'yoomoney':
        details.wallet = document.getElementById('yoomoneyWallet')?.value;
        break;
    case 'qiwi':
        details.phone = document.getElementById('qiwiPhone')?.value;
        break;
    case 'crypto':
        details.wallet = document.getElementById('cryptoWallet')?.value;
        details.network = document.getElementById('cryptoNetwork')?.value;
        break;
}

return details;
if (partnerId) {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–∫–æ—Å–∏—Å—Ç–µ–º—É
    window.ecosystem = new PartnerEcosystem();
    await window.ecosystem.initialize();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞—à–±–æ—Ä–¥
    window.partnerDashboard = new PartnerDashboard(window.ecosystem);
    await window.partnerDashboard.initialize(partnerId);
}
async function getCurrentPartnerId() {
const response = await fetch('/api/partner/current');
const data = await response.json();
return data.id;
}

// –°—Ç–∏–ª–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
const dashboardStyles = `

<style> /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–∞—à–±–æ—Ä–¥–∞ */ .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 20px; } .partner-header { background: linear-gradient(135deg, #7C3AED, #10B981); border-radius: 16px; padding: 30px; color: white; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; } .partner-info h1 { margin: 0 0 10px 0; font-size: 2rem; } .partner-tier { display: flex; align-items: center; gap: 15px; } .tier-badge { padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; } .tier-bronze { background: #CD7F32; color: white; } .tier-silver { background: #C0C0C0; color: #333; } .tier-gold { background: #FFD700; color: #333; } .tier-platinum { background: linear-gradient(135deg, #E5E4E2, #B9B9B9); color: #333; } .next-tier-info { font-size: 0.9rem; opacity: 0.9; } .partner-actions { display: flex; gap: 15px; } /* –°–µ—Ç–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */ .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; } .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; } .stat-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #7C3AED, #10B981); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; } .stat-content { flex: 1; } .stat-value { font-size: 1.5rem; font-weight: bold; color: #1F2937; margin-bottom: 5px; } .stat-label { color: #6B7280; font-size: 0.9rem; margin-bottom: 5px; } .stat-trend { font-size: 0.85rem; font-weight: 500; } .trend-up { color: #10B981; } .trend-down { color: #EF4444; } /* –°–µ—Ç–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ */ .services-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; } .service-performance-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #E5E7EB; } .service-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #E5E7EB; } .service-header h4 { margin: 0; color: #1F2937; } .service-revenue { font-weight: bold; color: #7C3AED; font-size: 1.1rem; } .service-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; } .metric { text-align: center; } .metric-label { display: block; color: #6B7280; font-size: 0.85rem; margin-bottom: 5px; } .metric-value { display: block; font-weight: bold; color: #1F2937; font-size: 1.1rem; } .service-actions { display: flex; gap: 10px; } .btn-sm { padding: 8px 16px; font-size: 0.85rem; } /* –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ */ .recommendations-list { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; } .recommendation-card { background: white; border-radius: 12px; padding: 20px; display: flex; gap: 20px; align-items: flex-start; border-left: 4px solid #E5E7EB; } .recommendation-card.priority-high { border-left-color: #EF4444; } .recommendation-card.priority-medium { border-left-color: #F59E0B; } .recommendation-icon { width: 40px; height: 40px; background: #F3F4F6; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #7C3AED; font-size: 1.2rem; } .recommendation-content { flex: 1; } .recommendation-content h4 { margin: 0 0 10px 0; color: #1F2937; } .recommendation-content p { margin: 0 0 10px 0; color: #6B7280; line-height: 1.5; } .recommendation-action { background: #F9FAFB; padding: 10px; border-radius: 8px; font-size: 0.9rem; color: #4B5563; } .recommendation-priority { align-self: flex-start; } .priority-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; } .priority-high .priority-badge { background: #FEE2E2; color: #DC2626; } .priority-medium .priority-badge { background: #FEF3C7; color: #D97706; } /* –°—Ä–∞–≤–Ω–µ–Ω–∏–µ */ .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; } .comparison-card { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); } .comparison-card h4 { margin: 0 0 15px 0; color: #6B7280; font-size: 1rem; } .position-display { text-align: center; } .position-number { font-size: 2.5rem; font-weight: bold; color: #7C3AED; line-height: 1; } .position-label { color: #6B7280; font-size: 0.9rem; margin-top: 5px; } .comparison-result { padding: 15px; border-radius: 10px; } .comparison-result.above { background: #D1FAE5; } .comparison-result.below { background: #FEE2E2; } .comparison-value { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; } .comparison-result.above .comparison-value { color: #059669; } .comparison-result.below .comparison-value { color: #DC2626; } .comparison-label { font-size: 0.9rem; color: #6B7280; } /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */ .notification { position: fixed; top: 20px; right: 20px; background: white; border-radius: 12px; padding: 15px 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; z-index: 1000; animation: slideIn 0.3s ease; border-left: 4px solid #3B82F6; } .notification-success { border-left-color: #10B981; } .notification-info { border-left-color: #3B82F6; } @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } .notification-content { display: flex; align-items: center; gap: 10px; flex: 1; } .notification-close { background: none; border: none; color: #6B7280; cursor: pointer; padding: 5px; } /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */ .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001; padding: 20px; } .modal-content { background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalFadeIn 0.3s ease; } @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } } .modal-header { padding: 20px; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center; } .modal-header h3 { margin: 0; } .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6B7280; } .modal-body { padding: 20px; } .withdrawal-modal .balance-info { background: #F9FAFB; padding: 15px; border-radius: 10px; margin-bottom: 20px; } .withdrawal-modal .form-group { margin-bottom: 20px; } .withdrawal-modal label { display: block; margin-bottom: 8px; font-weight: 500; color: #374151; } .withdrawal-modal input, .withdrawal-modal select, .withdrawal-modal textarea { width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; } .withdrawal-modal input:focus, .withdrawal-modal select:focus, .withdrawal-modal textarea:focus { outline: none; border-color: #7C3AED; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); } /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */ @media (max-width: 768px) { .partner-header { flex-direction: column; gap: 20px; text-align: center; } .partner-actions { width: 100%; flex-direction: column; } .stats-grid { grid-template-columns: 1fr; } .services-grid { grid-template-columns: 1fr; } .comparison-grid { grid-template-columns: 1fr; } } /* –ê–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */ .loading-skeleton { background: linear-gradient(90deg, #F3F4F6 25%, #E5E7EB 50%, #F3F4F6 75%); background-size: 200% 100%; animation: loading 1.5s infinite; } @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } } /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */ .btn { padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; } .btn-primary { background: linear-gradient(135deg, #7C3AED, #10B981); color: white; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3); } .btn-secondary { background: white; color: #7C3AED; border: 2px solid #7C3AED; } .btn-secondary:hover { background: #7C3AED; color: white; } .btn-outline { background: transparent; color: #6B7280; border: 1px solid #D1D5DB; } .btn-outline:hover { border-color: #7C3AED; color: #7C3AED; } /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */ @media (prefers-color-scheme: dark) { body { background: #111827; color: #F9FAFB; } .stat-card, .service-performance-card, .recommendation-card, .comparison-card, .notification { background: #1F2937; color: #F9FAFB; } .stat-value, .service-header h4, .recommendation-content h4 { color: #F9FAFB; } .stat-label, .metric-label, .recommendation-content p, .comparison-label { color: #9CA3AF; } .modal-content { background: #1F2937; color: #F9FAFB; } .withdrawal-modal input, .withdrawal-modal select, .withdrawal-modal textarea { background: #374151; border-color: #4B5563; color: #F9FAFB; } .withdrawal-modal .balance-info { background: #374151; } .recommendation-action { background: #374151; color: #9CA3AF; } .loading-skeleton { background: linear-gradient(90deg, #374151 25%, #4B5563 50%, #374151 75%); } } </style>
`;

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç
document.head.insertAdjacentHTML('beforeend', dashboardStyles);
// advanced-features.js
class AdvancedAffiliateFeatures {
    constructor() {
        this.automationRules = new Map();
        this.integrations = new Map();
        this.webhooks = new Map();
    }
    
    async initialize() {
        await this.loadAutomationRules();
        await this.setupIntegrations();
        await this.configureWebhooks();
        
        console.log('Advanced features initialized');
    }
    
    async loadAutomationRules() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
        const response = await fetch('/api/automation/rules');
        const rules = await response.json();
        
        rules.forEach(rule => {
            this.automationRules.set(rule.id, {
                ...rule,
                enabled: true,
                lastExecuted: null,
                executions: 0
            });
        });
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
        this.startAutomationEngine();
    }
    
    startAutomationEngine() {
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
        setInterval(() => {
            this.executeAutomationRules();
        }, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    }
    
    async executeAutomationRules() {
        for (const [ruleId, rule] of this.automationRules) {
            if (!rule.enabled) continue;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
            const shouldExecute = await this.checkRuleConditions(rule);
            
            if (shouldExecute) {
                await this.executeRule(rule);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∞–≤–∏–ª–∞
                rule.lastExecuted = new Date();
                rule.executions++;
                
                // –õ–æ–≥–∏—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                await this.logAutomationEvent(rule);
            }
        }
    }
    
    async checkRuleConditions(rule) {
        switch(rule.type) {
            case 'revenue_threshold':
                return await this.checkRevenueThreshold(rule);
            case 'conversion_rate':
                return await this.checkConversionRate(rule);
            case 'inactivity':
                return await this.checkInactivity(rule);
            case 'seasonal':
                return await this.checkSeasonalRule(rule);
            default:
                return false;
        }
    }
    
    async checkRevenueThreshold(rule) {
        const partnerId = rule.targetPartnerId;
        const revenue = await this.getPartnerRevenue(partnerId, rule.period);
        
        return revenue >= rule.threshold;
    }
    
    async checkConversionRate(rule) {
        const partnerId = rule.targetPartnerId;
        const conversionRate = await this.getPartnerConversionRate(partnerId, rule.period);
        
        if (rule.comparison === 'below' && conversionRate < rule.threshold) {
            return true;
        }
        if (rule.comparison === 'above' && conversionRate > rule.threshold) {
            return true;
        }
        
        return false;
    }
    
    async checkInactivity(rule) {
        const partnerId = rule.targetPartnerId;
        const lastActivity = await this.getPartnerLastActivity(partnerId);
        
        if (!lastActivity) return false;
        
        const daysInactive = (Date.now() - new Date(lastActivity).getTime()) / (1000 * 60 * 60 * 24);
        return daysInactive >= rule.days;
    }
    
    async checkSeasonalRule(rule) {
        const now = new Date();
        const currentMonth = now.getMonth() + 1;
        const currentDay = now.getDate();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–∑–æ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∞–∑–¥–Ω–∏–∫–∏)
        if (rule.season === 'new_year' && currentMonth === 12 && currentDay >= 20) {
            return true;
        }
        if (rule.season === 'black_friday' && currentMonth === 11 && currentDay >= 20 && currentDay <= 30) {
            return true;
        }
        
        return false;
    }
    
    async executeRule(rule) {
        console.log(`Executing rule: ${rule.name}`);
        
        try {
            switch(rule.action.type) {
                case 'send_email':
                    await this.executeEmailAction(rule);
                    break;
                case 'adjust_commission':
                    await this.executeCommissionAction(rule);
                    break;
                case 'send_notification':
                    await this.executeNotificationAction(rule);
                    break;
                case 'run_script':
                    await this.executeScriptAction(rule);
                    break;
                case 'call_webhook':
                    await this.executeWebhookAction(rule);
                    break;
            }
            
            return true;
        } catch (error) {
            console.error(`Error executing rule ${rule.name}:`, error);
            return false;
        }
    }
    
    async executeEmailAction(rule) {
        const template = rule.action.template;
        const partner = await this.getPartner(rule.targetPartnerId);
        
        // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —à–∞–±–ª–æ–Ω–µ
        let subject = template.subject;
        let body = template.body;
        
        // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        subject = this.replaceVariables(subject, partner);
        body = this.replaceVariables(body, partner);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email
        await fetch('/api/email/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to: partner.email,
                subject: subject,
                body: body,
                template: 'automation'
            })
        });
    }
    
    async executeCommissionAction(rule) {
        const partnerId = rule.targetPartnerId;
        const adjustment = rule.action.adjustment;
        
        // –ò–∑–º–µ–Ω—è–µ–º –∫–æ–º–∏—Å—Å–∏—é –ø–∞—Ä—Ç–Ω—ë—Ä–∞
        await fetch(`/api/partners/${partnerId}/commission`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                adjustment: adjustment,
                reason: `Automation: ${rule.name}`,
                validUntil: rule.action.duration ? 
                    new Date(Date.now() + rule.action.duration * 24 * 60 * 60 * 1000).toISOString() : 
                    null
            })
        });
    }
    
    replaceVariables(text, partner) {
        const variables = {
            '{{partner.name}}': partner.name,
            '{{partner.email}}': partner.email,
            '{{partner.tier}}': partner.tier,
            '{{partner.revenue}}': partner.monthlyRevenue || 0,
            '{{date}}': new Date().toLocaleDateString('ru-RU'),
            '{{timestamp}}': new Date().toISOString()
        };
        
        Object.entries(variables).forEach(([key, value]) => {
            text = text.replace(new RegExp(key, 'g'), value);
        });
        
        return text;
    }
    
    async setupIntegrations() {
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
        const integrations = [
            {
                id: 'crm',
                type: 'amo_crm',
                config: await this.loadCRMConfig()
            },
            {
                id: 'analytics',
                type: 'google_analytics',
                config: await this.loadAnalyticsConfig()
            },
            {
                id: 'email',
                type: 'sendgrid',
                config: await this.loadEmailConfig()
            },
            {
                id: 'telegram',
                type: 'telegram_bot',
                config: await this.loadTelegramConfig()
            }
        ];
        
        integrations.forEach(integration => {
            this.integrations.set(integration.id, integration);
        });
    }
    
    async configureWebhooks() {
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º
        const webhooks = [
            {
                id: 'new_conversion',
                url: 'https://ai-catalog.ru/webhooks/conversion',
                events: ['conversion.created', 'conversion.approved'],
                secret: await this.generateWebhookSecret()
            },
            {
                id: 'partner_status',
                url: 'https://ai-catalog.ru/webhooks/partner',
                events: ['partner.created', 'partner.updated', 'partner.tier_changed'],
                secret: await this.generateWebhookSecret()
            },
            {
                id: 'payment',
                url: 'https://ai-catalog.ru/webhooks/payment',
                events: ['payment.processed', 'payment.failed'],
                secret: await this.generateWebhookSecret()
            }
        ];
        
        webhooks.forEach(webhook => {
            this.webhooks.set(webhook.id, webhook);
        });
    }
    
    async triggerWebhook(webhookId, event, data) {
        const webhook = this.webhooks.get(webhookId);
        if (!webhook || !webhook.events.includes(event)) {
            return;
        }
        
        const payload = {
            event: event,
            data: data,
            timestamp: new Date().toISOString(),
            signature: await this.signWebhookPayload(webhook.secret, data)
        };
        
        try {
            const response = await fetch(webhook.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Webhook-Signature': payload.signature
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`Webhook failed: ${response.status}`);
            }
            
            console.log(`Webhook ${webhookId} triggered successfully`);
        } catch (error) {
            console.error(`Error triggering webhook ${webhookId}:`, error);
            
            // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∏ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
            await this.retryWebhook(webhookId, payload);
        }
    }
    
    async signWebhookPayload(secret, data) {
        // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å—å –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
        const encoder = new TextEncoder();
        const key = await crypto.subtle.importKey(
            'raw',
            encoder.encode(secret),
            { name: 'HMAC', hash: 'SHA-256' },
            false,
            ['sign']
        );
        
        const signature = await crypto.subtle.sign(
            'HMAC',
            key,
            encoder.encode(JSON.stringify(data))
        );
        
        return Array.from(new Uint8Array(signature))
            .map(b => b.toString(16).padStart(2, '0'))
            .join('');
    }
    
    async retryWebhook(webhookId, payload, attempt = 1) {
        const maxRetries = 3;
        const retryDelay = attempt * 5000; // 5, 10, 15 —Å–µ–∫—É–Ω–¥
        
        if (attempt > maxRetries) {
            console.error(`Webhook ${webhookId} failed after ${maxRetries} retries`);
            await this.logWebhookFailure(webhookId, payload);
            return;
        }
        
        setTimeout(async () => {
            try {
                const webhook = this.webhooks.get(webhookId);
                const response = await fetch(webhook.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Webhook-Signature': payload.signature
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    console.log(`Webhook ${webhookId} succeeded on retry ${attempt}`);
                } else {
                    await this.retryWebhook(webhookId, payload, attempt + 1);
                }
            } catch (error) {
                await this.retryWebhook(webhookId, payload, attempt + 1);
            }
        }, retryDelay);
    }
    
    async generateWebhookSecret() {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è –≤–µ–±—Ö—É–∫–∞
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
async function getPartnerRevenue(partnerId, period = 'month') {
    const response = await fetch(`/api/partners/${partnerId}/revenue?period=${period}`);
    const data = await response.json();
    return data.revenue || 0;
}

async function getPartnerConversionRate(partnerId, period = 'month') {
    const response = await fetch(`/api/partners/${partnerId}/conversion-rate?period=${period}`);
    const data = await response.json();
    return data.rate || 0;
}

async function getPartnerLastActivity(partnerId) {
    const response = await fetch(`/api/partners/${partnerId}/last-activity`);
    const data = await response.json();
    return data.lastActivity;
}

async function getPartner(partnerId) {
    const response = await fetch(`/api/partners/${partnerId}`);
    return await response.json();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
document.addEventListener('DOMContentLoaded', async function() {
    window.advancedFeatures = new AdvancedAffiliateFeatures();
    await window.advancedFeatures.initialize();
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
class PartnerUtilities {
    constructor() {
        this.tools = new Map();
        this.templates = new Map();
    }
    
    async initialize() {
        await this.loadTools();
        await this.loadTemplates();
        this.setupUtilities();
    }
    
    async loadTools() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
        const tools = [
            {
                id: 'link_shortener',
                name: '–°–æ–∫—Ä–∞—â–∞—Ç–µ–ª—å —Å—Å—ã–ª–æ–∫',
                description: '–°–æ–∫—Ä–∞—â–∞–π—Ç–µ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∫–ª–∏–∫–∏',
                icon: 'fas fa-link',
                component: LinkShortener
            },
            {
                id: 'qr_generator',
                name: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤',
                description: '–°–æ–∑–¥–∞–≤–∞–π—Ç–µ QR-–∫–æ–¥—ã –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫',
                icon: 'fas fa-qrcode',
                component: QRGenerator
            },
            {
                id: 'content_generator',
                name: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞',
                description: '–°–æ–∑–¥–∞–≤–∞–π—Ç–µ SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è',
                icon: 'fas fa-pen-alt',
                component: ContentGenerator
            },
            {
                id: 'analytics_dashboard',
                name: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏',
                description: '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–ª–∏–∫–æ–≤ –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–π',
                icon: 'fas fa-chart-bar',
                component: RealTimeAnalytics
            }
        ];
        
        tools.forEach(tool => {
            this.tools.set(tool.id, tool);
        });
    }
    
    async loadTemplates() {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω—ã –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
        const templates = [
            {
                id: 'email_promo',
                name: 'Email —Ä–∞—Å—Å—ã–ª–∫–∞',
                category: 'marketing',
                content: this.getEmailPromoTemplate(),
                variables: ['partner_name', 'service_name', 'promo_code', 'affiliate_link']
            },
            {
                id: 'social_post',
                name: '–ü–æ—Å—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π',
                category: 'social',
                content: this.getSocialPostTemplate(),
                variables: ['service_name', 'benefits', 'promo_code', 'link']
            },
            {
                id: 'telegram_channel',
                name: '–ü–æ—Å—Ç –¥–ª—è Telegram',
                category: 'messaging',
                content: this.getTelegramTemplate(),
                variables: ['service_name', 'features', 'screenshot_url', 'affiliate_link']
            },
            {
                id: 'comparison_table',
                name: '–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞',
                category: 'content',
                content: this.getComparisonTemplate(),
                variables: ['services', 'features', 'prices', 'ratings']
            }
        ];
        
        templates.forEach(template => {
            this.templates.set(template.id, template);
        });
    }
    
    getEmailPromoTemplate() {
        return `
üéØ –¢–µ–º–∞ –ø–∏—Å—å–º–∞: –û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è [service_name] - —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç!

–ü—Ä–∏–≤–µ—Ç, [partner_name]!

–•–æ—á—É –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –≤–∞–º–∏ –ø–æ—Ç—Ä—è—Å–∞—é—â–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º - [service_name]! 
–≠—Ç–æ –Ω–∞—Å—Ç–æ—è—â–∏–π –ø—Ä–æ—Ä—ã–≤ –≤ –º–∏—Ä–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞.

üî• –ß—Ç–æ –¥–µ–ª–∞–µ—Ç [service_name] –æ—Å–æ–±–µ–Ω–Ω—ã–º:
‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∑–∞ —Å–µ–∫—É–Ω–¥—ã
‚Ä¢ –ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
‚Ä¢ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏

üéÅ –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å –ø—Ä–æ–º–æ–∫–æ–¥: [promo_code]
–î–∞—ë—Ç —Å–∫–∏–¥–∫—É 15% –Ω–∞ –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü!

üöÄ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É: [affiliate_link]

P.S. [service_name] —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç—ã—Å—è—á–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å!

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
[partner_name]
        `;
    }
    
    getSocialPostTemplate() {
        return `
üé® –î—Ä—É–∑—å—è, –Ω–∞—à–µ–ª –∫—Ä—É—Ç–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç!

–¢–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª [service_name] –∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏!

–ß—Ç–æ –º–æ–∂–µ—Ç:
‚Ä¢ [benefits_1]
‚Ä¢ [benefits_2] 
‚Ä¢ [benefits_3]

–ò –≤—Å–µ —ç—Ç–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ —Å –æ—Ç–ª–∏—á–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π!

–ü–æ –ø—Ä–æ–º–æ–∫–æ–¥—É [promo_code] —Å–∫–∏–¥–∫–∞ 20% üéÅ

–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å: [link]

#AI #–Ω–µ–π—Ä–æ—Å–µ—Ç–∏ #[service_name] #—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
        `;
    }
    
    getTelegramTemplate() {
        return `
ü§ñ [SERVICE_NAME] - –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤!

üî∏ [feature_1]
üî∏ [feature_2] 
üî∏ [feature_3]

üì∏ –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, —á—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è: [screenshot_url]

üíé –ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: [promo_code] (—ç–∫–æ–Ω–æ–º–∏—è 25%)

üëâ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É: [affiliate_link]

P.S. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –æ —Å–≤–æ–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö!
        `;
    }
    
    getComparisonTemplate() {
        return `
| –§—É–Ω–∫—Ü–∏—è | [service_1] | [service_2] | [service_3] |
|---------|-------------|-------------|-------------|
| –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ | ‚úÖ | ‚úÖ | ‚ùå |
| –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω | ‚úÖ | ‚ùå | ‚úÖ |
| API –¥–æ—Å—Ç—É–ø | ‚úÖ | ‚úÖ | ‚ùå |
| –°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã | –ë—ã—Å—Ç—Ä–æ | –°—Ä–µ–¥–Ω–µ | –ú–µ–¥–ª–µ–Ω–Ω–æ |
| –¶–µ–Ω–∞ | [price_1] | [price_2] | [price_3] |
| –†–µ–π—Ç–∏–Ω–≥ | [rating_1] | [rating_2] | [rating_3] |

–í—ã–≤–æ–¥: [service_1] –ª—É—á—à–∏–π –≤—ã–±–æ—Ä –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!
        `;
    }
    
    setupUtilities() {
        this.renderToolbox();
        this.setupTemplateEditor();
    }
    
    renderToolbox() {
        const container = document.getElementById('partnerToolbox');
        if (!container) return;
        
        container.innerHTML = `
            <h3>üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</h3>
            <div class="tools-grid">
                ${Array.from(this.tools.values()).map(tool => `
                    <div class="tool-card" onclick="openTool('${tool.id}')">
                        <div class="tool-icon">
                            <i class="${tool.icon}"></i>
                        </div>
                        <div class="tool-info">
                            <h4>${tool.name}</h4>
                            <p>${tool.description}</p>
                        </div>
                        <div class="tool-action">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <h3 style="margin-top: 40px;">üìã –ì–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã</h3>
            <div class="templates-grid">
                ${Array.from(this.templates.values()).map(template => `
                    <div class="template-card" onclick="editTemplate('${template.id}')">
                        <div class="template-header">
                            <h4>${template.name}</h4>
                            <span class="template-category">${template.category}</span>
                        </div>
                        <p class="template-description">
                            ${template.content.substring(0, 100)}...
                        </p>
                        <div class="template-variables">
                            ${template.variables.map(v => `<span class="variable-tag">${v}</span>`).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    setupTemplateEditor() {
        // –°–æ–∑–¥–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤
        const editor = document.createElement('div');
        editor.id = 'templateEditor';
        editor.className = 'template-editor-modal';
        editor.style.display = 'none';
        
        editor.innerHTML = `
            <div class="editor-container">
                <div class="editor-header">
                    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤</h3>
                    <button onclick="closeTemplateEditor()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="editor-toolbar">
                    <div class="variable-palette" id="variablePalette"></div>
                    <div class="formatting-tools">
                        <button onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
                        <button onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
                        <button onclick="formatText('underline')"><i class="fas fa-underline"></i></button>
                        <button onclick="insertLink()"><i class="fas fa-link"></i></button>
                        <button onclick="insertEmoji()"><i class="fas fa-smile"></i></button>
                    </div>
                </div>
                
                <div class="editor-main">
                    <div class="editor-input">
                        <textarea id="templateContent" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞..."></textarea>
                    </div>
                    
                    <div class="editor-preview">
                        <h4>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h4>
                        <div id="templatePreview" class="preview-content"></div>
                    </div>
                </div>
                
                <div class="editor-footer">
                    <button onclick="saveTemplate()" class="btn btn-primary">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω
                    </button>
                    <button onclick="copyTemplate()" class="btn btn-secondary">
                        <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button onclick="testTemplate()" class="btn btn-outline">
                        <i class="fas fa-paper-plane"></i> –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(editor);
    }
}

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
class LinkShortener {
    constructor() {
        this.shortLinks = new Map();
    }
    
    async render(container) {
        container.innerHTML = `
            <div class="link-shortener">
                <h3><i class="fas fa-link"></i> –°–æ–∫—Ä–∞—â–∞—Ç–µ–ª—å —Å—Å—ã–ª–æ–∫</h3>
                
                <div class="input-section">
                    <div class="form-group">
                        <label>–î–ª–∏–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ (URL)</label>
                        <input type="url" id="longUrl" placeholder="https://example.com?ref=your_id" required>
                    </div>
                    
                    <div class="form-group">
                        <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="text" id="customCode" placeholder="my-link" maxlength="20">
                    </div>
                    
                    <div class="form-group">
                        <label>–î–æ–±–∞–≤–∏—Ç—å UTM-–º–µ—Ç–∫–∏</label>
                        <div class="utm-fields">
                            <input type="text" id="utmSource" placeholder="–ò—Å—Ç–æ—á–Ω–∏–∫" value="partner">
                            <input type="text" id="utmMedium" placeholder="–ö–∞–Ω–∞–ª" value="social">
                            <input type="text" id="utmCampaign" placeholder="–ö–∞–º–ø–∞–Ω–∏—è" value="promo">
                        </div>
                    </div>
                    
                    <button onclick="shortenLink()" class="btn btn-primary">
                        <i class="fas fa-magic"></i> –°–æ–∫—Ä–∞—Ç–∏—Ç—å —Å—Å—ã–ª–∫—É
                    </button>
                </div>
                
                <div class="result-section" id="shortenerResult" style="display: none;">
                    <h4>–í–∞—à–∞ –∫–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞:</h4>
                    <div class="result-box">
                        <input type="text" id="shortUrl" readonly>
                        <button onclick="copyShortLink()" class="btn btn-secondary">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="generateQR()" class="btn btn-outline">
                            <i class="fas fa-qrcode"></i> QR-–∫–æ–¥
                        </button>
                    </div>
                    
                    <div class="link-stats">
                        <div class="stat">
                            <span class="stat-label">–î–ª–∏–Ω–∞:</span>
                            <span class="stat-value" id="linkLength">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">–ö–ª–∏–∫–∏:</span>
                            <span class="stat-value" id="linkClicks">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">–°–æ–∑–¥–∞–Ω–∞:</span>
                            <span class="stat-value" id="linkCreated">–¢–æ–ª—å–∫–æ —á—Ç–æ</span>
                        </div>
                    </div>
                    
                    <div class="link-actions">
                        <button onclick="trackLink()" class="btn btn-sm">
                            <i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </button>
                        <button onclick="editLink()" class="btn btn-sm">
                            <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button onclick="shareLink()" class="btn btn-sm">
                            <i class="fas fa-share-alt"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                        </button>
                    </div>
                </div>
                
                <div class="links-history">
                    <h4>–ò—Å—Ç–æ—Ä–∏—è —Å—Å—ã–ª–æ–∫</h4>
                    <div id="linksHistory" class="history-list">
                        <!-- –°—Å—ã–ª–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        `;
        
        await this.loadHistory();
    }
    
    async shortenLink() {
        const longUrl = document.getElementById('longUrl').value;
        const customCode = document.getElementById('customCode').value;
        
        if (!longUrl) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º UTM-–º–µ—Ç–∫–∏
        let finalUrl = longUrl;
        const utmSource = document.getElementById('utmSource').value;
        const utmMedium = document.getElementById('utmMedium').value;
        const utmCampaign = document.getElementById('utmCampaign').value;
        
        if (!finalUrl.includes('?')) {
            finalUrl += '?';
        } else {
            finalUrl += '&';
        }
        
        finalUrl += `utm_source=${encodeURIComponent(utmSource)}&utm_medium=${encodeURIComponent(utmMedium)}&utm_campaign=${encodeURIComponent(utmCampaign)}`;
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É
        const response = await fetch('/api/links/shorten', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                url: finalUrl,
                customCode: customCode || undefined,
                partnerId: getCurrentPartnerId()
            })
        });
        
        const data = await response.json();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        document.getElementById('shortUrl').value = data.shortUrl;
        document.getElementById('linkLength').textContent = 
            `${data.shortUrl.length} —Å–∏–º–≤–æ–ª–æ–≤`;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏–∏
        this.saveToHistory(data);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        document.getElementById('shortenerResult').style.display = 'block';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        await this.loadHistory();
    }
    
    async loadHistory() {
        const partnerId = getCurrentPartnerId();
        const response = await fetch(`/api/links/history/${partnerId}`);
        const history = await response.json();
        
        const container = document.getElementById('linksHistory');
        if (!container) return;
        
        if (history.length === 0) {
            container.innerHTML = '<p class="empty-state">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫</p>';
            return;
        }
        
        container.innerHTML = history.map(link => `
            <div class="history-item">
                <div class="link-info">
                    <div class="short-url">
                        <a href="${link.shortUrl}" target="_blank">${link.shortUrl}</a>
                        <span class="clicks-badge">${link.clicks} –∫–ª–∏–∫–æ–≤</span>
                    </div>
                    <div class="original-url" title="${link.originalUrl}">
                        ${this.truncateUrl(link.originalUrl)}
                    </div>
                </div>
                <div class="link-actions">
                    <button onclick="copyHistoryLink('${link.shortUrl}')" class="btn-icon">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button onclick="deleteLink('${link.id}')" class="btn-icon">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    truncateUrl(url, maxLength = 50) {
        if (url.length <= maxLength) return url;
        return url.substring(0, maxLength) + '...';
    }
    
    saveToHistory(linkData) {
        const history = JSON.parse(localStorage.getItem('linkHistory') || '[]');
        history.unshift({
            ...linkData,
            createdAt: new Date().toISOString(),
            clicks: 0
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Å—ã–ª–æ–∫
        if (history.length > 50) {
            history.pop();
        }
        
        localStorage.setItem('linkHistory', JSON.stringify(history));
    }
}

class QRGenerator {
    constructor() {
        this.qrCodes = new Map();
    }
    
    async render(container) {
        container.innerHTML = `
            <div class="qr-generator">
                <h3><i class="fas fa-qrcode"></i> –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤</h3>
                
                <div class="generator-input">
                    <div class="form-group">
                        <label>–°—Å—ã–ª–∫–∞ –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                        <input type="url" id="qrUrl" placeholder="https://example.com" value="${window.location.href}">
                    </div>
                    
                    <div class="qr-settings">
                        <div class="setting-group">
                            <label>–†–∞–∑–º–µ—Ä</label>
                            <input type="range" id="qrSize" min="100" max="500" value="250">
                            <span id="sizeValue">250px</span>
                        </div>
                        
                        <div class="setting-group">
                            <label>–¶–≤–µ—Ç</label>
                            <input type="color" id="qrColor" value="#000000">
                        </div>
                        
                        <div class="setting-group">
                            <label>–§–æ–Ω</label>
                            <input type="color" id="qrBgColor" value="#FFFFFF">
                        </div>
                        
                        <div class="setting-group">
                            <label>–õ–æ–≥–æ—Ç–∏–ø</label>
                            <input type="file" id="qrLogo" accept="image/*">
                        </div>
                    </div>
                    
                    <button onclick="generateQRCode()" class="btn btn-primary">
                        <i class="fas fa-bolt"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥
                    </button>
                </div>
                
                <div class="generator-output" id="qrOutput" style="display: none;">
                    <h4>–í–∞—à QR-–∫–æ–¥:</h4>
                    <div class="qr-preview">
                        <canvas id="qrCanvas"></canvas>
                        <div class="qr-logo-preview" id="logoPreview"></div>
                    </div>
                    
                    <div class="qr-actions">
                        <button onclick="downloadQR('png')" class="btn btn-secondary">
                            <i class="fas fa-download"></i> PNG
                        </button>
                        <button onclick="downloadQR('svg')" class="btn btn-secondary">
                            <i class="fas fa-download"></i> SVG
                        </button>
                        <button onclick="downloadQR('pdf')" class="btn btn-secondary">
                            <i class="fas fa-download"></i> PDF
                        </button>
                        <button onclick="shareQR()" class="btn btn-outline">
                            <i class="fas fa-share-alt"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                        </button>
                    </div>
                    
                    <div class="qr-info">
                        <div class="info-item">
                            <strong>–†–∞–∑–º–µ—Ä:</strong> <span id="infoSize">250x250</span>
                        </div>
                        <div class="info-item">
                            <strong>–¢–∏–ø:</strong> <span id="infoType">PNG</span>
                        </div>
                        <div class="info-item">
                            <strong>–°—Å—ã–ª–∫–∞:</strong> <span id="infoUrl" class="truncate">${window.location.href}</span>
                        </div>
                    </div>
                </div>
                
                <div class="qr-history">
                    <h4>–ò—Å—Ç–æ—Ä–∏—è QR-–∫–æ–¥–æ–≤</h4>
                    <div id="qrHistory" class="history-grid">
                        <!-- QR-–∫–æ–¥—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        `;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–∞–π–¥–µ—Ä —Ä–∞–∑–º–µ—Ä–∞
        document.getElementById('qrSize').addEventListener('input', function() {
            document.getElementById('sizeValue').textContent = `${this.value}px`;
        });
        
        await this.loadQRHistory();
    }
    
    async generateQRCode() {
        const url = document.getElementById('qrUrl').value;
        const size = document.getElementById('qrSize').value;
        const color = document.getElementById('qrColor').value;
        const bgColor = document.getElementById('qrBgColor').value;
        const logoFile = document.getElementById('qrLogo').files[0];
        
        if (!url) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
            return;
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥ —Å –ø–æ–º–æ—â—å—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        const qrCode = await this.createQRCode(url, {
            size: parseInt(size),
            color: color,
            bgColor: bgColor,
            logo: logoFile
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        this.displayQRCode(qrCode, url, size);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        await this.saveQRToHistory(qrCode, url);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        document.getElementById('qrOutput').style.display = 'block';
    }
    
    async createQRCode(url, options) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞
        const formData = new FormData();
        formData.append('url', url);
        formData.append('size', options.size);
        formData.append('color', options.color);
        formData.append('bgColor', options.bgColor);
        
        if (options.logo) {
            formData.append('logo', options.logo);
        }
        
        const response = await fetch('/api/qr/generate', {
            method: 'POST',
            body: formData
        });
        
        return await response.blob();
    }
    
    displayQRCode(blob, url, size) {
        const canvas = document.getElementById('qrCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = size;
        canvas.height = size;
        
        // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ blob
        const img = new Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0, size, size);
        };
        
        img.src = URL.createObjectURL(blob);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        document.getElementById('infoSize').textContent = `${size}x${size}`;
        document.getElementById('infoUrl').textContent = this.truncateUrl(url, 30);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º blob –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        this.currentQRBlob = blob;
        this.currentQRUrl = url;
    }
    
    async downloadQR(format) {
        if (!this.currentQRBlob) {
            alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥');
            return;
        }
        
        let blob = this.currentQRBlob;
        
        if (format !== 'png') {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            const response = await fetch('/api/qr/convert', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    format: format,
                    url: this.currentQRUrl
                })
            });
            
            blob = await response.blob();
        }
        
        // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `qr-code-${new Date().getTime()}.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    async saveQRToHistory(blob, url) {
        const history = JSON.parse(localStorage.getItem('qrHistory') || '[]');
        
        // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        const thumbnail = await this.createThumbnail(blob);
        
        history.unshift({
            url: url,
            thumbnail: thumbnail,
            createdAt: new Date().toISOString(),
            size: document.getElementById('qrSize').value
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 QR-–∫–æ–¥–æ–≤
        if (history.length > 20) {
            history.pop();
        }
        
        localStorage.setItem('qrHistory', JSON.stringify(history));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        await this.loadQRHistory();
    }
    
    async createThumbnail(blob) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, 100, 100);
                resolve(canvas.toDataURL());
            };
            img.src = URL.createObjectURL(blob);
        });
    }
    
    async loadQRHistory() {
        const history = JSON.parse(localStorage.getItem('qrHistory') || '[]');
        const container = document.getElementById('qrHistory');
        
        if (!container) return;
        
        if (history.length === 0) {
            container.innerHTML = '<p class="empty-state">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö QR-–∫–æ–¥–æ–≤</p>';
            return;
        }
        
        container.innerHTML = history.map((item, index) => `
            <div class="history-qr-item" onclick="loadQRFromHistory(${index})">
                <div class="qr-thumbnail">
                    <img src="${item.thumbnail}" alt="QR-–∫–æ–¥">
                </div>
                <div class="qr-info">
                    <div class="qr-url truncate" title="${item.url}">
                        ${this.truncateUrl(item.url, 25)}
                    </div>
                    <div class="qr-meta">
                        <span class="qr-size">${item.size}px</span>
                        <span class="qr-date">${new Date(item.createdAt).toLocaleDateString('ru-RU')}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    truncateUrl(url, maxLength) {
        if (url.length <= maxLength) return url;
        return url.substring(0, maxLength) + '...';
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
window.openTool = async function(toolId) {
    const tool = window.partnerUtilities?.tools.get(toolId);
    if (!tool) return;
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    const modal = document.createElement('div');
    modal.className = 'tool-modal';
    modal.innerHTML = `
        <div class="tool-modal-content">
            <div class="tool-modal-header">
                <h3>${tool.name}</h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tool-modal-body" id="toolContent"></div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
    const instance = new tool.component();
    await instance.render(document.getElementById('toolContent'));
};

window.editTemplate = function(templateId) {
    const template = window.partnerUtilities?.templates.get(templateId);
    if (!template) return;
    
    const editor = document.getElementById('templateEditor');
    const contentArea = document.getElementById('templateContent');
    const variablePalette = document.getElementById('variablePalette');
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
    contentArea.value = template.content;
    
    // –°–æ–∑–¥–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    variablePalette.innerHTML = `
        <strong>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:</strong>
        ${template.variables.map(v => `
            <button class="variable-button" onclick="insertVariable('${v}')">
                ${v}
            </button>
        `).join('')}
    `;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
    editor.style.display = 'block';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    updateTemplatePreview();
};

window.closeTemplateEditor = function() {
    document.getElementById('templateEditor').style.display = 'none';
};

window.insertVariable = function(variable) {
    const textarea = document.getElementById('templateContent');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    
    const text = textarea.value;
    const variableText = `[${variable}]`;
    
    textarea.value = text.substring(0, start) + variableText + text.substring(end);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    updateTemplatePreview();
};

window.updateTemplatePreview = function() {
    const content = document.getElementById('templateContent').value;
    const preview = document.getElementById('templatePreview');
    
    // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞ –ø—Ä–∏–º–µ—Ä—ã
    let previewContent = content;
    const variables = {
        'partner_name': '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
        'service_name': '–Ø–Ω–¥–µ–∫—Å GPT',
        'promo_code': 'AI2024PRO',
        'affiliate_link': 'https://example.com/ref123',
        'benefits_1': '–ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞',
        'benefits_2': '–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞',
        'benefits_3': '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏'
    };
    
    Object.entries(variables).forEach(([key, value]) => {
        previewContent = previewContent.replace(new RegExp(`\\[${key}\\]`, 'g'), value);
    });
    
    preview.innerHTML = previewContent;
};

window.saveTemplate = function() {
    const content = document.getElementById('templateContent').value;
    const templateName = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞:', '–ú–æ–π —à–∞–±–ª–æ–Ω');
    
    if (!templateName) return;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    const templates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
    templates.push({
        id: 'custom_' + Date.now(),
        name: templateName,
        content: content,
        createdAt: new Date().toISOString()
    });
    
    localStorage.setItem('customTemplates', JSON.stringify(templates));
    
    alert('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
    closeTemplateEditor();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤
    if (window.partnerUtilities) {
        window.partnerUtilities.renderToolbox();
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Ç–∏–ª–∏—Ç
document.addEventListener('DOMContentLoaded', async function() {
    window.partnerUtilities = new PartnerUtilities();
    await window.partnerUtilities.initialize();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
    await loadCustomTemplates();
});

async function loadCustomTemplates() {
    const customTemplates = JSON.parse(localStorage.getItem('customTemplates') || '[]');
    
    customTemplates.forEach(template => {
        window.partnerUtilities.templates.set(template.id, {
            ...template,
            category: 'custom',
            variables: this.extractVariables(template.content)
        });
    });
}

function extractVariables(content) {
    const matches = content.match(/\[([^\]]+)\]/g);
    if (!matches) return [];
    
    return [...new Set(matches.map(m => m.slice(1, -1)))];
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ CSS —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
const toolsStyles = `
<style>
/* –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã */
.tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.tool-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #E5E7EB;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 15px;
}

.tool-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    border-color: #7C3AED;
}

.tool-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #7C3AED, #10B981);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.tool-info {
    flex: 1;
}

.tool-info h4 {
    margin: 0 0 5px 0;
    color: #1F2937;
}

.tool-info p {
    margin: 0;
    color: #6B7280;
    font-size: 0.9rem;
    line-height: 1.4;
}

.tool-action {
    color: #9CA3AF;
    transition: color 0.3s;
}

.tool-card:hover .tool-action {
    color: #7C3AED;
}

/* –®–∞–±–ª–æ–Ω—ã */
.templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.template-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #E5E7EB;
    cursor: pointer;
    transition: all 0.3s;
}

.template-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    border-color: #10B981;
}

.template-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.template-header h4 {
    margin: 0;
    color: #1F2937;
}

.template-category {
    background: #F3F4F6;
    color: #6B7280;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
}

.template-description {
    color: #6B7280;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 15px;
    max-height: 60px;
    overflow: hidden;
}

.template-variables {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.variable-tag {
    background: #E0E7FF;
    color: #4F46E5;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
}

/* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
.tool-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1001;
    padding: 20px;
}

.tool-modal-content {
    background: white;
    border-radius: 16px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalFadeIn 0.3s ease;
}

.tool-modal-header {
    padding: 20px;
    border-bottom: 1px solid #E5E7EB;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tool-modal-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.tool-modal-header button {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: #6B7280;
}

.tool-modal-body {
    padding: 20px;
}

/* –°–æ–∫—Ä–∞—â–∞—Ç–µ–ª—å —Å—Å—ã–ª–æ–∫ */
.link-shortener .form-group {
    margin-bottom: 20px;
}

.utm-fields {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.result-box {
    display: flex;
    gap: 10px;
    margin: 15px 0;
}

.result-box input {
    flex: 1;
    padding: 10px;
    border: 1px solid #D1D5DB;
    border-radius: 8px;
    font-size: 0.9rem;
}

.link-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin: 20px 0;
    padding: 15px;
    background: #F9FAFB;
    border-radius: 10px;
}

.link-actions {
    display: flex;
    gap: 10px;
    margin: 20px 0;
}

.history-list {
    max-height: 300px;
    overflow-y: auto;
}

.history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #E5E7EB;
}
.link-info {
    flex: 1;
    min-width: 0;
}

.short-url {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
}

.short-url a {
    color: #7C3AED;
    text-decoration: none;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.short-url a:hover {
    text-decoration: underline;
}

.clicks-badge {
    background: #10B981;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: 500;
}

.original-url {
    color: #6B7280;
    font-size: 0.85rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.btn-icon {
    background: none;
    border: 1px solid #D1D5DB;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    color: #6B7280;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: #F3F4F6;
    border-color: #9CA3AF;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6B7280;
    font-style: italic;
}

/* –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤ */
.qr-settings {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.setting-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.setting-group label {
    font-size: 0.9rem;
    color: #6B7280;
}

.qr-preview {
    position: relative;
    width: fit-content;
    margin: 20px auto;
    padding: 20px;
    background: white;
    border-radius: 12px;
    border: 1px solid #E5E7EB;
}

.qr-logo-preview {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
    background: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.qr-logo-preview img {
    max-width: 100%;
    max-height: 100%;
}

.qr-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 20px 0;
}

.qr-info {
    background: #F9FAFB;
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
}

.info-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #E5E7EB;
}

.info-item:last-child {
    border-bottom: none;
}

.truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 200px;
}

.history-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
}

.history-qr-item {
    background: white;
    border-radius: 10px;
    padding: 10px;
    border: 1px solid #E5E7EB;
    cursor: pointer;
    transition: all 0.2s;
}

.history-qr-item:hover {
    border-color: #7C3AED;
    transform: translateY(-2px);
}

.qr-thumbnail {
    width: 100%;
    height: 100px;
    background: #F3F4F6;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    overflow: hidden;
}

.qr-thumbnail img {
    max-width: 100%;
    max-height: 100%;
}

.qr-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #6B7280;
    margin-top: 5px;
}

/* –†–µ–¥–∞–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤ */
.template-editor-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1002;
    padding: 20px;
}

.editor-container {
    background: white;
    border-radius: 16px;
    max-width: 1000px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.editor-header {
    padding: 20px;
    border-bottom: 1px solid #E5E7EB;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.editor-header h3 {
    margin: 0;
}

.editor-toolbar {
    padding: 15px 20px;
    border-bottom: 1px solid #E5E7EB;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #F9FAFB;
}

.variable-palette {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

.variable-button {
    background: #E0E7FF;
    color: #4F46E5;
    border: none;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.variable-button:hover {
    background: #C7D2FE;
}

.formatting-tools {
    display: flex;
    gap: 5px;
}

.formatting-tools button {
    background: white;
    border: 1px solid #D1D5DB;
    border-radius: 6px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #6B7280;
    transition: all 0.2s;
}

.formatting-tools button:hover {
    background: #F3F4F6;
    border-color: #9CA3AF;
}

.editor-main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding: 20px;
    flex: 1;
    min-height: 400px;
}

@media (max-width: 768px) {
    .editor-main {
        grid-template-columns: 1fr;
    }
}

.editor-input textarea {
    width: 100%;
    height: 100%;
    min-height: 300px;
    padding: 15px;
    border: 1px solid #D1D5DB;
    border-radius: 8px;
    font-family: 'Inter', sans-serif;
    font-size: 0.95rem;
    line-height: 1.5;
    resize: vertical;
}

.editor-input textarea:focus {
    outline: none;
    border-color: #7C3AED;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
}

.editor-preview {
    display: flex;
    flex-direction: column;
}

.preview-content {
    flex: 1;
    background: #F9FAFB;
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    padding: 20px;
    overflow-y: auto;
    font-size: 0.95rem;
    line-height: 1.6;
    white-space: pre-wrap;
}

.editor-footer {
    padding: 20px;
    border-top: 1px solid #E5E7EB;
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .tools-grid,
    .templates-grid {
        grid-template-columns: 1fr;
    }
    
    .editor-main {
        grid-template-columns: 1fr;
    }
    
    .editor-footer {
        flex-direction: column;
    }
    
    .editor-footer .btn {
        width: 100%;
    }
    
    .qr-settings {
        grid-template-columns: 1fr;
    }
    
    .utm-fields {
        grid-template-columns: 1fr;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tool-card,
.template-card,
.history-item,
.history-qr-item {
    animation: fadeIn 0.3s ease;
}

/* –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ –∫–ª–∞—Å—Å—ã */
.loading {
    position: relative;
    overflow: hidden;
}

.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: loadingShimmer 1.5s infinite;
}

@keyframes loadingShimmer {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(100%);
    }
}

.success-message {
    background: #D1FAE5;
    color: #065F46;
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid #A7F3D0;
    margin: 10px 0;
}

.error-message {
    background: #FEE2E2;
    color: #991B1B;
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid #FECACA;
    margin: 10px 0;
}

.warning-message {
    background: #FEF3C7;
    color: #92400E;
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid #FDE68A;
    margin: 10px 0;
}

/* –ò–∫–æ–Ω–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π */
.icon-success {
    color: #10B981;
}

.icon-warning {
    color: #F59E0B;
}

.icon-error {
    color: #EF4444;
}

.icon-info {
    color: #3B82F6;
}

/* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #F3F4F6;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #9CA3AF;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #6B7280;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 480px) {
    .tool-modal-content,
    .editor-container {
        border-radius: 0;
        max-height: 100vh;
        height: 100vh;
    }
    
    .tool-modal {
        padding: 0;
    }
    
    .history-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
}

/* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
@media (prefers-color-scheme: dark) {
    .tool-card,
    .template-card,
    .history-item,
    .history-qr-item,
    .tool-modal-content,
    .editor-container,
    .link-shortener,
    .qr-generator {
        background: #1F2937;
        border-color: #374151;
        color: #F9FAFB;
    }
    
    .tool-info h4,
    .template-header h4,
    .short-url a,
    .info-item strong {
        color: #F9FAFB;
    }
    
    .tool-info p,
    .template-description,
    .original-url,
    .qr-meta,
    .info-item span {
        color: #9CA3AF;
    }
    
    .tool-icon {
        background: linear-gradient(135deg, #8B5CF6, #0EA5E9);
    }
    
    .template-category {
        background: #374151;
        color: #D1D5DB;
    }
    
    .variable-tag {
        background: #4C1D95;
        color: #C4B5FD;
    }
    
    .qr-preview {
        background: #111827;
        border-color: #374151;
    }
    
    .qr-info,
    .link-stats,
    .editor-toolbar {
        background: #111827;
    }
    
    .editor-input textarea,
    .preview-content {
        background: #111827;
        border-color: #374151;
        color: #F9FAFB;
    }
    
    .variable-button {
        background: #4C1D95;
        color: #C4B5FD;
    }
    
    .variable-button:hover {
        background: #5B21B6;
    }
    
    .formatting-tools button {
        background: #374151;
        border-color: #4B5563;
        color: #D1D5DB;
    }
    
    .formatting-tools button:hover {
        background: #4B5563;
    }
    
    .btn-icon {
        border-color: #4B5563;
        color: #D1D5DB;
    }
    
    .btn-icon:hover {
        background: #374151;
        border-color: #6B7280;
    }
    
    .empty-state {
        color: #9CA3AF;
    }
    
    .success-message {
        background: #064E3B;
        color: #A7F3D0;
        border-color: #047857;
    }
    
    .error-message {
        background: #7F1D1D;
        color: #FECACA;
        border-color: #991B1B;
    }
    
    .warning-message {
        background: #78350F;
        color: #FDE68A;
        border-color: #92400E;
    }
    
    ::-webkit-scrollbar-track {
        background: #111827;
    }
    
    ::-webkit-scrollbar-thumb {
        background: #4B5563;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: #6B7280;
    }
}
</style>
`;

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç
document.head.insertAdjacentHTML('beforeend', toolsStyles);

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
class ContentGenerator {
    constructor() {
        this.aiService = new AIService();
        this.templates = this.getContentTemplates();
    }
    
    async render(container) {
        container.innerHTML = `
            <div class="content-generator">
                <h3><i class="fas fa-pen-alt"></i> –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h3>
                
                <div class="generator-controls">
                    <div class="form-group">
                        <label>–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                        <select id="contentType" onchange="updateContentFields()">
                            <option value="article">–°—Ç–∞—Ç—å—è</option>
                            <option value="social_post">–ü–æ—Å—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π</option>
                            <option value="email">Email —Ä–∞—Å—Å—ã–ª–∫–∞</option>
                            <option value="product_review">–û–±–∑–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞</option>
                            <option value="comparison">–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç—å—è</option>
                            <option value="guide">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è/–ì–∞–π–¥</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–¢–µ–º–∞/–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        <input type="text" id="contentTopic" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–±–∑–æ—Ä –Ø–Ω–¥–µ–∫—Å GPT">
                    </div>
                    
                    <div class="form-group">
                        <label>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</label>
                        <input type="text" id="contentKeywords" placeholder="AI, –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞">
                    </div>
                    
                    <div class="form-group">
                        <label>–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</label>
                        <select id="contentAudience">
                            <option value="general">–û–±—â–∞—è</option>
                            <option value="beginners">–ù–æ–≤–∏—á–∫–∏</option>
                            <option value="professionals">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã</option>
                            <option value="business">–ë–∏–∑–Ω–µ—Å</option>
                            <option value="developers">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–¢–æ–Ω –ø–∏—Å—å–º–∞</label>
                        <select id="contentTone">
                            <option value="professional">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
                            <option value="friendly">–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option>
                            <option value="persuasive">–£–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π</option>
                            <option value="casual">–ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
                            <option value="enthusiastic">–≠–Ω—Ç—É–∑–∏–∞—Å—Ç–∏—á–Ω—ã–π</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–î–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                        <select id="contentLength">
                            <option value="short">–ö–æ—Ä–æ—Ç–∫–∏–π (200-500 —Å–ª–æ–≤)</option>
                            <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π (500-1000 —Å–ª–æ–≤)</option>
                            <option value="long">–î–ª–∏–Ω–Ω—ã–π (1000-2000 —Å–ª–æ–≤)</option>
                        </select>
                    </div>
                    
                    <div id="additionalFields">
                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø–æ—è–≤—è—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
                    </div>
                    
                    <div class="form-group">
                        <label>–í–∫–ª—é—á–∏—Ç—å SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é</label>
                        <input type="checkbox" id="seoOptimization" checked>
                    </div>
                    
                    <div class="form-group">
                        <label>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (CTA)</label>
                        <input type="checkbox" id="includeCTA" checked>
                    </div>
                    
                    <button onclick="generateContent()" class="btn btn-primary" id="generateButton">
                        <i class="fas fa-magic"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
                    </button>
                </div>
                
                <div class="generator-output" id="contentOutput" style="display: none;">
                    <div class="output-header">
                        <h4>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</h4>
                        <div class="output-actions">
                            <button onclick="copyContent()" class="btn btn-sm">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="downloadContent()" class="btn btn-sm">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="editContent()" class="btn btn-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="regenerateContent()" class="btn btn-sm">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="content-preview" id="contentPreview">
                        <!-- –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                    </div>
                    
                    <div class="content-metrics">
                        <div class="metric">
                            <span class="metric-label">–°–ª–æ–≤:</span>
                            <span class="metric-value" id="wordCount">0</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">–°–∏–º–≤–æ–ª–æ–≤:</span>
                            <span class="metric-value" id="charCount">0</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">–í—Ä–µ–º—è —á—Ç–µ–Ω–∏—è:</span>
                            <span class="metric-value" id="readTime">0 –º–∏–Ω</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</span>
                            <span class="metric-value" id="readability">–°—Ä–µ–¥–Ω–∏–π</span>
                        </div>
                    </div>
                    
                    <div class="seo-analysis" id="seoAnalysis">
                        <h5>SEO-–∞–Ω–∞–ª–∏–∑</h5>
                        <div id="seoResults"></div>
                    </div>
                </div>
                
                <div class="content-history">
                    <h4>–ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h4>
                    <div id="contentHistory">
                        <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        `;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        await this.loadContentHistory();
    }
    
    getContentTemplates() {
        return {
            article: {
                fields: ['introduction', 'sections', 'conclusion'],
                template: this.getArticleTemplate()
            },
            social_post: {
                fields: ['platform', 'hashtags', 'emoji'],
                template: this.getSocialPostTemplate()
            },
            email: {
                fields: ['subject', 'greeting', 'closing'],
                template: this.getEmailTemplate()
            }
        };
    }
    
    async generateContent() {
        const generateButton = document.getElementById('generateButton');
        const originalText = generateButton.innerHTML;
        
        try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            generateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
            generateButton.disabled = true;
            
            // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const params = this.collectGenerationParams();
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ AI
            const content = await this.aiService.generateContent(params);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            this.displayGeneratedContent(content);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            await this.saveToHistory(content, params);
            
        } catch (error) {
            console.error('Error generating content:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            generateButton.innerHTML = originalText;
            generateButton.disabled = false;
        }
    }
    
    collectGenerationParams() {
        return {
            type: document.getElementById('contentType').value,
            topic: document.getElementById('contentTopic').value,
            keywords: document.getElementById('contentKeywords').value,
            audience: document.getElementById('contentAudience').value,
            tone: document.getElementById('contentTone').value,
            length: document.getElementById('contentLength').value,
            seo: document.getElementById('seoOptimization').checked,
            cta: document.getElementById('includeCTA').checked,
            additionalFields: this.getAdditionalFields()
        };
    }
    
    getAdditionalFields() {
        const type = document.getElementById('contentType').value;
        const fields = {};
        
        switch(type) {
            case 'article':
                fields.sections = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–¥–µ–ª–æ–≤:', '3');
                break;
            case 'social_post':
                fields.platform = prompt('–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ (VK, Telegram, etc):', 'VK');
                fields.hashtags = prompt('–•—ç—à—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):', '#AI #–Ω–µ–π—Ä–æ—Å–µ—Ç–∏');
                break;
            case 'email':
                fields.subject = prompt('–¢–µ–º–∞ –ø–∏—Å—å–º–∞:', '');
                fields.greeting = prompt('–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:', '–£–≤–∞–∂–∞–µ–º—ã–π –∫–æ–ª–ª–µ–≥–∞!');
                break;
        }
        
        return fields;
    }
    
    displayGeneratedContent(content) {
        const output = document.getElementById('contentOutput');
        const preview = document.getElementById('contentPreview');
        
        preview.innerHTML = this.formatContent(content);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
        this.updateMetrics(content);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º SEO –∞–Ω–∞–ª–∏–∑ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
        if (document.getElementById('seoOptimization').checked) {
            this.showSEOAnalysis(content);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        output.style.display = 'block';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
        this.currentContent = content;
    }
    
    formatContent(content) {
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        const type = document.getElementById('contentType').value;
        
        switch(type) {
            case 'article':
                return this.formatArticle(content);
            case 'social_post':
                return this.formatSocialPost(content);
            case 'email':
                return this.formatEmail(content);
            default:
                return `<div class="formatted-content">${content}</div>`;
        }
    }
    
    formatArticle(content) {
        // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        const paragraphs = content.split('\n\n');
        return paragraphs.map((para, index) => {
            if (index === 0) {
                return `<h4>${para}</h4>`;
            } else if (para.match(/^#{1,3}\s/)) {
                // –≠—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                const level = para.match(/^(#{1,3})/)[1].length;
                const title = para.replace(/^#{1,3}\s/, '');
                return `<h${level + 3}>${title}</h${level + 3}>`;
            } else {
                return `<p>${para}</p>`;
            }
        }).join('');
    }
    
    updateMetrics(content) {
        // –°—á–∏—Ç–∞–µ–º —Å–ª–æ–≤–∞
        const words = content.split(/\s+/).length;
        document.getElementById('wordCount').textContent = words;
        
        // –°—á–∏—Ç–∞–µ–º —Å–∏–º–≤–æ–ª—ã
        const chars = content.length;
        document.getElementById('charCount').textContent = chars;
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è —á—Ç–µ–Ω–∏—è (—Å—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å 200 —Å–ª–æ–≤ –≤ –º–∏–Ω—É—Ç—É)
        const readTime = Math.ceil(words / 200);
        document.getElementById('readTime').textContent = `${readTime} –º–∏–Ω`;
        
        // –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        const readability = this.calculateReadability(content);
        document.getElementById('readability').textContent = readability;
    }
    
    calculateReadability(text) {
        // –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –æ—Ü–µ–Ω–∫–∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        const sentences = text.split(/[.!?]+/).length;
        const words = text.split(/\s+/).length;
        const syllables = this.countSyllables(text);
        
        if (sentences === 0) return '–õ–µ–≥–∫–∏–π';
        
        const asl = words / sentences; // Average Sentence Length
        const asw = syllables / words; // Average Syllables per Word
        
        // –§–æ—Ä–º—É–ª–∞ Flesch Reading Ease (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
        const score = 206.835 - (1.015 * asl) - (84.6 * asw);
        
        if (score > 80) return '–û—á–µ–Ω—å –ª–µ–≥–∫–∏–π';
        if (score > 60) return '–õ–µ–≥–∫–∏–π';
        if (score > 40) return '–°—Ä–µ–¥–Ω–∏–π';
        if (score > 20) return '–°–ª–æ–∂–Ω—ã–π';
        return '–û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π';
    }
    
    countSyllables(text) {
        // –ü—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Å—á–µ—Ç —Å–ª–æ–≥–æ–≤ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
        const vowels = '–∞–µ—ë–∏–æ—É—ã—ç—é—èaeiouy';
        let syllables = 0;
        
        text.toLowerCase().split('').forEach(char => {
            if (vowels.includes(char)) {
                syllables++;
            }
        });
        
        return syllables;
    }
    
    async saveToHistory(content, params) {
        const history = JSON.parse(localStorage.getItem('contentHistory') || '[]');
        
        history.unshift({
            id: 'content_' + Date.now(),
            content: content.substring(0, 200) + '...',
            params: params,
            createdAt: new Date().toISOString(),
            metrics: {
                words: content.split(/\s+/).length,
                chars: content.length
            }
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
        if (history.length > 20) {
            history.pop();
        }
        
        localStorage.setItem('contentHistory', JSON.stringify(history));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        await this.loadContentHistory();
    }
    
    async loadContentHistory() {
        const history = JSON.parse(localStorage.getItem('contentHistory') || '[]');
        const container = document.getElementById('contentHistory');
        
        if (!container) return;
        
        if (history.length === 0) {
            container.innerHTML = '<p class="empty-state">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</p>';
            return;
        }
        
        container.innerHTML = history.map(item => `
            <div class="history-content-item" onclick="loadContentFromHistory('${item.id}')">
                <div class="content-preview-small">
                    ${item.content}
                </div>
                <div class="content-meta">
                    <span class="content-type">${item.params.type}</span>
                    <span class="content-date">
                        ${new Date(item.createdAt).toLocaleDateString('ru-RU')}
                    </span>
                    <span class="content-metrics">
                        ${item.metrics.words} —Å–ª–æ–≤
                    </span>
                </div>
            </div>
        `).join('');
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
window.updateContentFields = function() {
    const type = document.getElementById('contentType').value;
    const container = document.getElementById('additionalFields');
    
    switch(type) {
        case 'article':
            container.innerHTML = `
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–¥–µ–ª–æ–≤</label>
                    <input type="number" id="articleSections" min="1" max="10" value="3">
                </div>
                <div class="form-group">
                    <label>–í–∫–ª—é—á–∏—Ç—å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏</label>
                    <input type="checkbox" id="articleSubheadings" checked>
                </div>
            `;
            break;
            
        case 'social_post':
            container.innerHTML = `
                <div class="form-group">
                    <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
                    <select id="socialPlatform">
                        <option value="vk">VK</option>
                        <option value="telegram">Telegram</option>
                        <option value="instagram">Instagram</option>
                        <option value="facebook">Facebook</option>
                        <option value="twitter">Twitter</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–•—ç—à—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <input type="text" id="socialHashtags" placeholder="#AI #–Ω–µ–π—Ä–æ—Å–µ—Ç–∏ #—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏">
                </div>
                <div class="form-group">
                    <label>–î–æ–±–∞–≤–∏—Ç—å —ç–º–æ–¥–∑–∏</label>
                    <input type="checkbox" id="socialEmoji" checked>
                </div>
            `;
            break;
            
        case 'email':
            container.innerHTML = `
                <div class="form-group">
                    <label>–¢–µ–º–∞ –ø–∏—Å—å–º–∞</label>
                    <input type="text" id="emailSubject" placeholder="–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä">
                </div>
                <div class="form-group">
                    <label>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</label>
                    <input type="text" id="emailGreeting" placeholder="–£–≤–∞–∂–∞–µ–º—ã–π –∫–æ–ª–ª–µ–≥–∞!">
                </div>
                <div class="form-group">
                    <label>–ü–æ–¥–ø–∏—Å—å</label>
                    <input type="text" id="emailClosing" placeholder="–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –∫–æ–º–∞–Ω–¥–∞ AI Catalog">
                </div>
            `;
            break;
            
        default:
            container.innerHTML = '';
    }
};

window.generateContent = async function() {
    if (window.contentGenerator) {
        await window.contentGenerator.generateContent();
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', async function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const container = document.getElementById('contentGeneratorContainer');
    if (container) {
        window.contentGenerator = new ContentGenerator();
        await window.contentGenerator.render(container);
    }
});
// marketing-automation.js
class MarketingAutomation {
    constructor() {
        this.campaigns = new Map();
        this.sequences = new Map();
        this.triggers = new Map();
        this.automations = new Map();
    }
    
    async initialize() {
        await this.loadCampaigns();
        await this.loadSequences();
        await this.loadTriggers();
        await this.setupAutomations();
        
        console.log('Marketing automation initialized');
    }
    
    async loadCampaigns() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏
        const response = await fetch('/api/automation/campaigns');
        const campaigns = await response.json();
        
        campaigns.forEach(campaign => {
            this.campaigns.set(campaign.id, {
                ...campaign,
                status: 'draft',
                stats: this.initializeCampaignStats(),
                automationRules: []
            });
        });
    }
    
    initializeCampaignStats() {
        return {
            sent: 0,
            delivered: 0,
            opened: 0,
            clicked: 0,
            converted: 0,
            revenue: 0,
            roi: 0,
            ctr: 0,
            conversionRate: 0
        };
    }
    
    async loadSequences() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
        const sequences = [
            {
                id: 'welcome_sequence',
                name: '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
                steps: this.getWelcomeSequence()
            },
            {
                id: 'abandoned_cart',
                name: '–ë—Ä–æ—à–µ–Ω–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞',
                steps: this.getAbandonedCartSequence()
            },
            {
                id: 're_engagement',
                name: '–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ',
                steps: this.getReEngagementSequence()
            },
            {
                id: 'cross_sell',
                name: '–ö—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂–∏',
                steps: this.getCrossSellSequence()
            }
        ];
        
        sequences.forEach(seq => {
            this.sequences.set(seq.id, seq);
        });
    }
    
    getWelcomeSequence() {
        return [
            {
                delay: 0, // –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                type: 'email',
                template: 'welcome_email',
                subject: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AI Catalog! üöÄ'
            },
            {
                delay: 1 * 24 * 60 * 60 * 1000, // –ß–µ—Ä–µ–∑ 1 –¥–µ–Ω—å
                type: 'email',
                template: 'first_tips',
                subject: '–°–µ–∫—Ä–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞'
            },
            {
                delay: 3 * 24 * 60 * 60 * 1000, // –ß–µ—Ä–µ–∑ 3 –¥–Ω—è
                type: 'email',
                template: 'best_practices',
                subject: '–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤'
            },
            {
                delay: 7 * 24 * 60 * 60 * 1000, // –ß–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
                type: 'email',
                template: 'first_results',
                subject: '–ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥ –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã'
            }
        ];
    }
    
    async loadTriggers() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
        const triggers = [
            {
                id: 'new_partner',
                name: '–ù–æ–≤—ã–π –ø–∞—Ä—Ç–Ω—ë—Ä',
                event: 'partner.registered',
                actions: ['start_welcome_sequence']
            },
            {
                id: 'first_conversion',
                name: '–ü–µ—Ä–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è',
                event: 'conversion.first',
                actions: ['send_congratulations', 'offer_coaching']
            },
            {
                id: 'revenue_threshold',
                name: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ –¥–æ—Ö–æ–¥–∞',
                event: 'revenue.milestone',
                actions: ['send_achievement', 'upgrade_tier']
            },
            {
                id: 'inactivity',
                name: '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                event: 'partner.inactive',
                actions: ['send_reminder', 'offer_help']
            }
        ];
        
        triggers.forEach(trigger => {
            this.triggers.set(trigger.id, trigger);
        });
    }
    
    async setupAutomations() {
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
        this.setupEmailAutomation();
        this.setupNotificationAutomation();
        this.setupCommissionAutomation();
        this.setupReportAutomation();
    }
    
    setupEmailAutomation() {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ email –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
        setInterval(async () => {
            await this.processScheduledEmails();
        }, 5 * 60 * 1000); // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    }
    
    async processScheduledEmails() {
        const scheduled = await this.getScheduledEmails();
        
        for (const email of scheduled) {
            if (new Date(email.scheduledFor) <= new Date()) {
                await this.sendAutomatedEmail(email);
                await this.markEmailAsSent(email.id);
            }
        }
    }
    
    async createCampaign(campaignData) {
        const campaignId = `campaign_${Date.now()}`;
        const campaign = {
            id: campaignId,
            ...campaignData,
            createdAt: new Date().toISOString(),
            status: 'draft',
            stats: this.initializeCampaignStats()
        };
        
        this.campaigns.set(campaignId, campaign);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        await fetch('/api/automation/campaigns', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(campaign)
        });
        
        return campaignId;
    }
    
    async launchCampaign(campaignId) {
        const campaign = this.campaigns.get(campaignId);
        if (!campaign) throw new Error('Campaign not found');
        
        campaign.status = 'active';
        campaign.launchedAt = new Date().toISOString();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∫–∏
        await this.startCampaignDelivery(campaign);
        
        // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
        this.startCampaignTracking(campaignId);
        
        return true;
    }
    
    async startCampaignDelivery(campaign) {
        const segments = await this.getCampaignSegments(campaign);
        
        for (const segment of segments) {
            for (const partner of segment.partners) {
                await this.sendCampaignToPartner(campaign, partner);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                campaign.stats.sent++;
                
                // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ (—á—Ç–æ–±—ã –Ω–µ –±—ã—Ç—å –∑–∞–±–∞–Ω–µ–Ω–Ω—ã–º–∏)
                await this.delay(1000);
            }
        }
    }
    
    async sendCampaignToPartner(campaign, partner) {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const personalizedContent = this.personalizeContent(
            campaign.content,
            partner
        );
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª
        switch (campaign.channel) {
            case 'email':
                await this.sendEmail(partner.email, campaign.subject, personalizedContent);
                break;
            case 'telegram':
                await this.sendTelegram(partner.telegramId, personalizedContent);
                break;
            case 'sms':
                await this.sendSMS(partner.phone, personalizedContent);
                break;
        }
        
        // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
        await this.logCampaignDelivery(campaign.id, partner.id);
    }
    
    personalizeContent(content, partner) {
        // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ
        const variables = {
            '{{partner.name}}': partner.name,
            '{{partner.email}}': partner.email,
            '{{partner.tier}}': partner.tier,
            '{{partner.revenue}}': partner.monthlyRevenue || 0,
            '{{partner.conversion_rate}}': partner.conversionRate || '0%',
            '{{date}}': new Date().toLocaleDateString('ru-RU'),
            '{{month}}': new Date().toLocaleDateString('ru-RU', { month: 'long' })
        };
        
        let personalized = content;
        Object.entries(variables).forEach(([key, value]) => {
            personalized = personalized.replace(new RegExp(key, 'g'), value);
        });
        
        return personalized;
    }
    
    startCampaignTracking(campaignId) {
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–∏–π –∏ –∫–ª–∏–∫–æ–≤
        const trackingInterval = setInterval(async () => {
            await this.updateCampaignStats(campaignId);
        }, 60 * 1000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º interval –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
        this.campaignTrackingIntervals = this.campaignTrackingIntervals || new Map();
        this.campaignTrackingIntervals.set(campaignId, trackingInterval);
    }
    
    async updateCampaignStats(campaignId) {
        const campaign = this.campaigns.get(campaignId);
        if (!campaign) return;
        
        // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ –ë–î
        const stats = await this.fetchCampaignStats(campaignId);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        campaign.stats = { ...campaign.stats, ...stats };
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
        campaign.stats.ctr = campaign.stats.clicked / campaign.stats.delivered * 100 || 0;
        campaign.stats.conversionRate = campaign.stats.converted / campaign.stats.clicked * 100 || 0;
        campaign.stats.roi = campaign.stats.revenue / campaign.cost || 0;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–º–ø–∞–Ω–∏–∏
        await this.checkCampaignStopConditions(campaign);
    }
    
    async checkCampaignStopConditions(campaign) {
        const stopConditions = [
            {
                condition: campaign.stats.sent >= campaign.target,
                action: () => this.stopCampaign(campaign.id, 'target_reached')
            },
            {
                condition: campaign.stats.ctr < 1 && campaign.stats.sent > 1000,
                action: () => this.stopCampaign(campaign.id, 'low_ctr')
            },
            {
                condition: campaign.stats.roi < 0.5 && campaign.stats.revenue > 1000,
                action: () => this.stopCampaign(campaign.id, 'low_roi')
            }
        ];
        
        for (const condition of stopConditions) {
            if (condition.condition) {
                await condition.action();
                break;
            }
        }
    }
    
    async stopCampaign(campaignId, reason) {
        const campaign = this.campaigns.get(campaignId);
        if (!campaign) return;
        
        campaign.status = 'stopped';
        campaign.stoppedAt = new Date().toISOString();
        campaign.stopReason = reason;
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
        const interval = this.campaignTrackingIntervals?.get(campaignId);
        if (interval) {
            clearInterval(interval);
            this.campaignTrackingIntervals.delete(campaignId);
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
        await this.sendCampaignStopNotification(campaign, reason);
    }
    
    async sendCampaignStopNotification(campaign, reason) {
        const reasons = {
            'target_reached': '–ö–∞–º–ø–∞–Ω–∏—è –¥–æ—Å—Ç–∏–≥–ª–∞ —Ü–µ–ª–µ–≤–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–ø—Ä–∞–≤–æ–∫',
            'low_ctr': '–ö–∞–º–ø–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–≥–æ CTR',
            'low_roi': '–ö–∞–º–ø–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–≥–æ ROI'
        };
        
        const message = `
üéØ –ö–∞–º–ø–∞–Ω–∏—è "${campaign.name}" –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

–ü—Ä–∏—á–∏–Ω–∞: ${reasons[reason] || reason}

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–∏:
‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${campaign.stats.sent}
‚Ä¢ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${campaign.stats.delivered}
‚Ä¢ –û—Ç–∫—Ä—ã—Ç–æ: ${campaign.stats.opened}
‚Ä¢ –ö–ª–∏–∫–æ–≤: ${campaign.stats.clicked}
‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Å–∏–π: ${campaign.stats.converted}
‚Ä¢ –î–æ—Ö–æ–¥: ${campaign.stats.revenue} ‚ÇΩ
‚Ä¢ ROI: ${campaign.stats.roi.toFixed(2)}
‚Ä¢ CTR: ${campaign.stats.ctr.toFixed(2)}%
        `;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—é –∫–∞–º–ø–∞–Ω–∏–∏
        await this.sendEmail(campaign.createdBy, '–ö–∞–º–ø–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', message);
    }
    
    async createAutomationRule(ruleData) {
        const ruleId = `rule_${Date.now()}`;
        const rule = {
            id: ruleId,
            ...ruleData,
            enabled: true,
            createdAt: new Date().toISOString(),
            lastTriggered: null,
            triggerCount: 0
        };
        
        this.automations.set(ruleId, rule);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        await fetch('/api/automation/rules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(rule)
        });
        
        return ruleId;
    }
    
    async triggerAutomation(event, data) {
        // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∞–≤–∏–ª–∞, —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–µ –Ω–∞ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ
        const rules = Array.from(this.automations.values())
            .filter(rule => 
                rule.enabled && 
                rule.trigger.event === event &&
                this.checkConditions(rule.conditions, data)
            );
        
        for (const rule of rules) {
            await this.executeAutomationRule(rule, data);
        }
    }
    
    checkConditions(conditions, data) {
        if (!conditions) return true;
        
        return conditions.every(condition => {
            const value = this.getValueFromPath(data, condition.field);
            
            switch (condition.operator) {
                case 'equals':
                    return value == condition.value;
                case 'not_equals':
                    return value != condition.value;
                case 'greater_than':
                    return value > condition.value;
                case 'less_than':
                    return value < condition.value;
                case 'contains':
                    return String(value).includes(condition.value);
                case 'not_contains':
                    return !String(value).includes(condition.value);
                default:
                    return false;
            }
        });
    }
    
    getValueFromPath(obj, path) {
        return path.split('.').reduce((acc, part) => acc && acc[part], obj);
    }
    
    async executeAutomationRule(rule, data) {
        console.log(`Executing automation rule: ${rule.name}`);
        
        try {
            for (const action of rule.actions) {
                await this.executeAction(action, data);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∞–≤–∏–ª–∞
            rule.lastTriggered = new Date().toISOString();
            rule.triggerCount++;
            
            // –õ–æ–≥–∏—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
            await this.logAutomationExecution(rule, data);
            
        } catch (error) {
            console.error(`Error executing rule ${rule.name}:`, error);
            await this.logAutomationError(rule, error);
        }
    }
    
    async executeAction(action, data) {
        switch (action.type) {
            case 'send_email':
                await this.executeEmailAction(action, data);
                break;
            case 'send_notification':
                await this.executeNotificationAction(action, data);
                break;
            case 'update_partner':
                await this.executeUpdateAction(action, data);
                break;
            case 'start_sequence':
                await this.executeSequenceAction(action, data);
                break;
            case 'create_task':
                await this.executeTaskAction(action, data);
                break;
            case 'call_webhook':
                await this.executeWebhookAction(action, data);
                break;
        }
    }
    
    async executeEmailAction(action, data) {
        const template = await this.getEmailTemplate(action.template);
        const personalized = this.personalizeContent(template, data);
        
        await this.sendEmail(data.email, action.subject, personalized);
    }
    
    async executeSequenceAction(action, data) {
        const sequence = this.sequences.get(action.sequenceId);
        if (!sequence) return;
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await this.startSequenceForPartner(sequence, data.partnerId);
    }
    
    async startSequenceForPartner(sequence, partnerId) {
        for (const step of sequence.steps) {
            // –ü–ª–∞–Ω–∏—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–≥–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(async () => {
                await this.executeSequenceStep(step, partnerId);
            }, step.delay);
        }
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏—è–º–∏
class CampaignManager {
    constructor(automation) {
        this.automation = automation;
        this.charts = new Map();
    }
    
    async render(container) {
        container.innerHTML = `
            <div class="campaign-manager">
                <div class="manager-header">
                    <h3><i class="fas fa-bullhorn"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏—è–º–∏</h3>
                    <button class="btn btn-primary" onclick="createNewCampaign()">
                        <i class="fas fa-plus"></i> –ù–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è
                    </button>
                </div>
                
                <div class="campaign-tabs">
                    <div class="tab active" onclick="switchTab('active')">
                        <i class="fas fa-play-circle"></i>
                        <span>–ê–∫—Ç–∏–≤–Ω—ã–µ</span>
                        <span class="tab-badge" id="activeCount">0</span>
                    </div>
                    <div class="tab" onclick="switchTab('draft')">
                        <i class="fas fa-edit"></i>
                        <span>–ß–µ—Ä–Ω–æ–≤–∏–∫–∏</span>
                        <span class="tab-badge" id="draftCount">0</span>
                    </div>
                    <div class="tab" onclick="switchTab('completed')">
                        <i class="fas fa-check-circle"></i>
                        <span>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</span>
                        <span class="tab-badge" id="completedCount">0</span>
                    </div>
                    <div class="tab" onclick="switchTab('scheduled')">
                        <i class="fas fa-calendar-alt"></i>
                        <span>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</span>
                        <span class="tab-badge" id="scheduledCount">0</span>
                    </div>
                </div>
                
                <div class="campaign-list" id="campaignList">
                    <!-- –ö–∞–º–ø–∞–Ω–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                
                <div class="campaign-analytics">
                    <h4>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π</h4>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <canvas id="performanceChart"></canvas>
                        </div>
                        <div class="analytics-card">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        await this.loadCampaigns();
        this.renderAnalytics();
    }
    
    async loadCampaigns() {
        const campaigns = Array.from(this.automation.campaigns.values());
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
        document.getElementById('activeCount').textContent = 
            campaigns.filter(c => c.status === 'active').length;
        document.getElementById('draftCount').textContent = 
            campaigns.filter(c => c.status === 'draft').length;
        document.getElementById('completedCount').textContent = 
            campaigns.filter(c => c.status === 'completed').length;
        document.getElementById('scheduledCount').textContent = 
            campaigns.filter(c => c.status === 'scheduled').length;
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–º–ø–∞–Ω–∏–∏
        await this.renderCampaigns(campaigns);
    }
    
    async renderCampaigns(campaigns) {
        const container = document.getElementById('campaignList');
        if (!container) return;
        
        if (campaigns.length === 0) {
            container.innerHTML = `
                <div class="empty-campaigns">
                    <i class="fas fa-bullhorn"></i>
                    <h4>–ù–µ—Ç –∫–∞–º–ø–∞–Ω–∏–π</h4>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é</p>
                    <button class="btn btn-primary" onclick="createNewCampaign()">
                        –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = campaigns.map(campaign => `
            <div class="campaign-card" data-status="${campaign.status}">
                <div class="campaign-header">
                    <div class="campaign-title">
                        <h4>${campaign.name}</h4>
                        <span class="campaign-status status-${campaign.status}">
                            ${this.getStatusLabel(campaign.status)}
                        </span>
                    </div>
                    <div class="campaign-actions">
                        <button class="btn-icon" onclick="editCampaign('${campaign.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="duplicateCampaign('${campaign.id}')">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn-icon" onclick="deleteCampaign('${campaign.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="campaign-info">
                    <div class="info-item">
                        <i class="fas fa-users"></i>
                        <span>–ê—É–¥–∏—Ç–æ—Ä–∏—è: ${campaign.audience || '–í—Å–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã'}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-paper-plane"></i>
                        <span>–ö–∞–Ω–∞–ª: ${this.getChannelLabel(campaign.channel)}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-calendar"></i>
                        <span>–°–æ–∑–¥–∞–Ω–∞: ${new Date(campaign.createdAt).toLocaleDateString('ru-RU')}</span>
                    </div>
                </div>
                
                <div class="campaign-stats">
                    <div class="stat">
                        <div class="stat-value">${campaign.stats?.sent || 0}</div>
                        <div class="stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${campaign.stats?.opened || 0}</div>
                        <div class="stat-label">–û—Ç–∫—Ä—ã—Ç–æ</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${campaign.stats?.clicked || 0}</div>
                        <div class="stat-label">–ö–ª–∏–∫–æ–≤</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${campaign.stats?.converted || 0}</div>
                        <div class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏–π</div>
                    </div>
                </div>
                
                <div class="campaign-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${this.calculateProgress(campaign)}%"></div>
                    </div>
                    <div class="progress-text">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: ${this.calculateProgress(campaign)}%</span>
                        <span>ROI: ${campaign.stats?.roi?.toFixed(2) || '0.00'}</span>
                    </div>
                </div>
                
                <div class="campaign-footer">
                    <button class="btn btn-sm" onclick="viewCampaignDetails('${campaign.id}')">
                        <i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </button>
                    
                    ${campaign.status === 'draft' ? `
                        <button class="btn btn-sm btn-primary" onclick="launchCampaign('${campaign.id}')">
                            <i class="fas fa-rocket"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å
                        </button>
                    ` : ''}
                    
                    ${campaign.status === 'active' ? `
                        <button class="btn btn-sm btn-warning" onclick="pauseCampaign('${campaign.id}')">
                            <i class="fas fa-pause"></i> –ü–∞—É–∑–∞
                        </button>
                    ` : ''}
                </div>
            </div>
        `).join('');
    }
    
    getStatusLabel(status) {
        const labels = {
            'draft': '–ß–µ—Ä–Ω–æ–≤–∏–∫',
            'active': '–ê–∫—Ç–∏–≤–Ω–∞',
            'paused': '–ù–∞ –ø–∞—É–∑–µ',
            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
            'scheduled': '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞'
        };
        return labels[status] || status;
    }
    
    getChannelLabel(channel) {
        const labels = {
            'email': 'Email',
            'telegram': 'Telegram',
            'sms': 'SMS',
            'push': 'Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'
        };
        return labels[channel] || channel;
    }
    
    calculateProgress(campaign) {
        if (!campaign.target) return 0;
        return Math.min(100, (campaign.stats?.sent / campaign.target * 100) || 0);
    }
    
    renderAnalytics() {
        this.renderPerformanceChart();
        this.renderRevenueChart();
    }
    
    renderPerformanceChart() {
        const ctx = document.getElementById('performanceChart');
        if (!ctx) return;
        
        const campaigns = Array.from(this.automation.campaigns.values());
        
        this.charts.performance = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: campaigns.map(c => c.name.substring(0, 15) + '...'),
                datasets: [
                    {
                        label: 'CTR (%)',
                        data: campaigns.map(c => c.stats?.ctr || 0),
                        backgroundColor: 'rgba(124, 58, 237, 0.6)',
                        borderColor: 'rgba(124, 58, 237, 1)',
                        borderWidth: 1
                    },
                    {
                        label: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è (%)',
                        data: campaigns.map(c => c.stats?.conversionRate || 0),
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–º–ø–∞–Ω–∏–π'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–ü—Ä–æ—Ü–µ–Ω—Ç (%)'
                        }
                    }
                }
            }
        });
    }
    
    renderRevenueChart() {
        const ctx = document.getElementById('revenueChart');
        if (!ctx) return;
        
        const campaigns = Array.from(this.automation.campaigns.values())
            .filter(c => c.stats?.revenue > 0);
        
        this.charts.revenue = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: campaigns.map(c => new Date(c.createdAt).toLocaleDateString('ru-RU')),
                datasets: [
                    {
                        label: '–î–æ—Ö–æ–¥ (‚ÇΩ)',
                        data: campaigns.map(c => c.stats?.revenue || 0),
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'ROI',
                        data: campaigns.map(c => c.stats?.roi || 0),
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∫–∞–º–ø–∞–Ω–∏–π'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '–î–æ—Ö–æ–¥ (‚ÇΩ)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'ROI'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }
}

// AI-—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
class AIContentOptimizer {
    constructor() {
        this.models = {
            gpt4: 'gpt-4',
            claude: 'claude-3',
            gemini: 'gemini-pro'
        };
    }
    
    async optimizeContent(content, options = {}) {
        const defaultOptions = {
            model: this.models.gpt4,
            language: 'russian',
            tone: 'professional',
            targetAudience: 'general',
            seo: true,
            length: 'preserve'
        };
        
        const config = { ...defaultOptions, ...options };
        
        try {
            const prompt = this.buildOptimizationPrompt(content, config);
            const optimized = await this.callAI(prompt, config.model);
            
            return {
                original: content,
                optimized: optimized,
                improvements: this.analyzeImprovements(content, optimized),
                suggestions: await this.getContentSuggestions(optimized)
            };
            
        } catch (error) {
            console.error('Content optimization error:', error);
            return {
                original: content,
                optimized: content,
                improvements: [],
                suggestions: [],
                error: error.message
            };
        }
    }
    
    buildOptimizationPrompt(content, config) {
        return `
–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —Ü–µ–ª–µ–π:

–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:
"${content}"

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
1. –Ø–∑—ã–∫: ${config.language}
2. –¢–æ–Ω: ${config.tone}
3. –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: ${config.targetAudience}
4. SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: ${config.seo ? '–î–∞' : '–ù–µ—Ç'}
5. –î–ª–∏–Ω–∞: ${config.length}

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞:
1. –£–ª—É—á—à–∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å
2. –î–æ–±–∞–≤—å —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é
3. –í–∫–ª—é—á–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É
5. –£–±–µ—Ä–∏ –≤–æ–¥—É –∏ –ø–æ–≤—Ç–æ—Ä—ã

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
        `;
    }
    
    async callAI(prompt, model) {
        const response = await fetch('/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: model,
                prompt: prompt,
                max_tokens: 2000,
                temperature: 0.7
            })
        });
        
        const data = await response.json();
        return data.content;
    }
    
    analyzeImprovements(original, optimized) {
        const improvements = [];
        
        // –ê–Ω–∞–ª–∏–∑ –¥–ª–∏–Ω—ã
        const originalLength = original.length;
        const optimizedLength = optimized.length;
        
        if (optimizedLength > originalLength * 1.2) {
            improvements.push('–£–≤–µ–ª–∏—á–µ–Ω –æ–±—ä–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞');
        } else if (optimizedLength < originalLength * 0.8) {
            improvements.push('–£–¥–∞–ª–µ–Ω–∞ –ª–∏—à–Ω—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è');
        } else {
            improvements.push('–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –æ–±—ä–µ–º');
        }
        
        // –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        const originalParagraphs = original.split('\n\n').length;
        const optimizedParagraphs = optimized.split('\n\n').length;
        
        if (optimizedParagraphs > originalParagraphs) {
            improvements.push('–£–ª—É—á—à–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ–∫—Å—Ç–∞');
        }
        
        // –ê–Ω–∞–ª–∏–∑ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        const originalReadability = this.calculateReadability(original);
        const optimizedReadability = this.calculateReadability(optimized);
        
        if (optimizedReadability > originalReadability) {
            improvements.push('–£–ª—É—á—à–µ–Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å');
        }
        
        return improvements;
    }
    
    async getContentSuggestions(content) {
        const prompt = `
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:

"${content}"

–ü—Ä–µ–¥–ª–æ–∂–∏:
1. 3-5 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è SEO
2. –í–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
3. –ò–¥–µ–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
4. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é
5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥—É

–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
        `;
        
        try {
            const response = await this.callAI(prompt, this.models.gpt4);
            
            // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
            const jsonMatch = response.match(/```json\n([\s\S]*?)\n```/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[1]);
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç JSON, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
            return {
                keywords: this.extractKeywords(content),
                headlines: this.generateHeadlines(content),
                visualIdeas: [],
                distribution: [],
                targeting: []
            };
            
        } catch (error) {
            return {
                keywords: [],
                headlines: [],
                visualIdeas: [],
                distribution: [],
                targeting: [],
                error: error.message
            };
        }
    }
    
    extractKeywords(text) {
        // –ü—Ä–æ—Å—Ç–∞—è —ç–∫—Å—Ç—Ä–∞–∫—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        const words = text.toLowerCase().split(/\W+/);
        const frequencies = {};
        
        words.forEach(word => {
            if (word.length > 3) {
                frequencies[word] = (frequencies[word] || 0) + 1;
            }
        });
        
        return Object.entries(frequencies)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([word]) => word);
    }
    
    generateHeadlines(text) {
        const sentences = text.split(/[.!?]+/);
        return sentences
            .filter(s => s.split(/\s+/).length > 5)
            .slice(0, 3)
            .map(s => s.trim());
    }
    
    calculateReadability(text) {
        // –§–æ—Ä–º—É–ª–∞ Flesch Reading Ease (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
        const sentences = text.split(/[.!?]+/).length;
        const words = text.split(/\s+/).length;
        const syllables = this.countSyllables(text);
        
        if (sentences === 0 || words === 0) return 0;
        
        const asl = words / sentences; // Average Sentence Length
        const asw = syllables / words; // Average Syllables per Word
        
        return 206.835 - (1.015 * asl) - (84.6 * asw);
    }
    
    countSyllables(text) {
        const vowels = '–∞–µ—ë–∏–æ—É—ã—ç—é—èaeiouy';
        let syllables = 0;
        
        text.toLowerCase().split('').forEach(char => {
            if (vowels.includes(char)) {
                syllables++;
            }
        });
        
        return syllables;
    }
}

// –°–∏—Å—Ç–µ–º–∞ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
class ABTestingSystem {
    constructor() {
        this.experiments = new Map();
        this.variants = new Map();
        this.results = new Map();
    }
    
    async initialize() {
        await this.loadExperiments();
        this.startExperimentMonitoring();
    }
    
    async loadExperiments() {
        const response = await fetch('/api/ab-testing/experiments');
        const experiments = await response.json();
        
        experiments.forEach(exp => {
            this.experiments.set(exp.id, {
                ...exp,
                status: 'draft',
                participants: 0,
                conversions: 0,
                confidence: 0
            });
        });
    }
    
    startExperimentMonitoring() {
        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        setInterval(async () => {
            await this.checkExperiments();
        }, 60 * 1000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    }
    
    async checkExperiments() {
        for (const [expId, experiment] of this.experiments) {
            if (experiment.status === 'active') {
                             await this.updateExperimentResults(expId);
                await this.checkExperimentSignificance(expId);
            }
        }
    }
    
    async updateExperimentResults(expId) {
        const experiment = this.experiments.get(expId);
        if (!experiment) return;
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É
        const results = await this.fetchExperimentResults(expId);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        experiment.participants = results.totalParticipants;
        experiment.conversions = results.totalConversions;
        experiment.variants = results.variants;
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Å–∏—é
        experiment.conversionRate = (experiment.conversions / experiment.participants * 100) || 0;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        this.experiments.set(expId, experiment);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        this.results.set(expId, results);
    }
    
    async checkExperimentSignificance(expId) {
        const experiment = this.experiments.get(expId);
        if (!experiment || experiment.variants?.length < 2) return;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫—É—é –∑–Ω–∞—á–∏–º–æ—Å—Ç—å
        const significance = await this.calculateSignificance(experiment.variants);
        experiment.confidence = significance.confidence;
        experiment.significant = significance.significant;
        
        // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –∏ –µ—Å—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—å
        if (significance.significant && significance.winner) {
            // –ó–∞–≤–µ—Ä—à–∞–µ–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
            await this.completeExperiment(expId, significance.winner);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        await this.checkStopConditions(expId);
    }
    
    async calculateSignificance(variants) {
        // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é z-—Ç–µ—Å—Ç–∞
        const control = variants.find(v => v.name === 'control') || variants[0];
        const treatment = variants.find(v => v.name !== 'control') || variants[1];
        
        if (!control || !treatment) {
            return { significant: false, confidence: 0, winner: null };
        }
        
        const n1 = control.participants;
        const n2 = treatment.participants;
        const p1 = control.conversions / n1 || 0;
        const p2 = treatment.conversions / n2 || 0;
        
        if (n1 < 30 || n2 < 30) {
            return { significant: false, confidence: 0, winner: null };
        }
        
        // –†–∞—Å—á–µ—Ç z-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        const p = (control.conversions + treatment.conversions) / (n1 + n2);
        const se = Math.sqrt(p * (1 - p) * (1/n1 + 1/n2));
        const z = (p2 - p1) / se;
        
        // –£—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è 95%
        const confidenceLevel = 1.96;
        const confidence = Math.abs(z) * 100 / confidenceLevel;
        
        return {
            significant: Math.abs(z) > confidenceLevel,
            confidence: Math.min(100, confidence),
            winner: p2 > p1 ? treatment.name : control.name,
            uplift: ((p2 - p1) / p1 * 100) || 0
        };
    }
    
    async checkStopConditions(expId) {
        const experiment = this.experiments.get(expId);
        if (!experiment) return;
        
        const stopConditions = [
            {
                condition: experiment.participants >= experiment.targetSampleSize,
                action: () => this.forceCompleteExperiment(expId, 'sample_size_reached')
            },
            {
                condition: Date.now() - new Date(experiment.startedAt).getTime() > experiment.maxDuration,
                action: () => this.forceCompleteExperiment(expId, 'time_limit_reached')
            },
            {
                condition: experiment.significant && experiment.confidence > 95,
                action: () => this.completeExperiment(expId, experiment.variants.find(v => v.name === this.getWinner(experiment.variants)))
            }
        ];
        
        for (const condition of stopConditions) {
            if (condition.condition) {
                await condition.action();
                break;
            }
        }
    }
    
    async createExperiment(experimentData) {
        const expId = `exp_${Date.now()}`;
        
        const experiment = {
            id: expId,
            ...experimentData,
            createdAt: new Date().toISOString(),
            status: 'draft',
            variants: this.initializeVariants(experimentData.variants),
            targetSampleSize: experimentData.sampleSize || 1000,
            maxDuration: experimentData.duration || 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω–µ–π
            participants: 0,
            conversions: 0,
            confidence: 0,
            significant: false
        };
        
        this.experiments.set(expId, experiment);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        await fetch('/api/ab-testing/experiments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(experiment)
        });
        
        return expId;
    }
    
    initializeVariants(variantData) {
        return variantData.map((variant, index) => ({
            id: `var_${Date.now()}_${index}`,
            name: variant.name || (index === 0 ? 'control' : `variant_${index}`),
            weight: variant.weight || 50,
            content: variant.content,
            participants: 0,
            conversions: 0,
            conversionRate: 0,
            revenue: 0
        }));
    }
    
    async launchExperiment(expId) {
        const experiment = this.experiments.get(expId);
        if (!experiment) throw new Error('Experiment not found');
        
        experiment.status = 'active';
        experiment.startedAt = new Date().toISOString();
        
        // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞—Ñ–∏–∫
        await this.startTrafficAllocation(expId);
        
        return true;
    }
    
    async startTrafficAllocation(expId) {
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ –º–µ–∂–¥—É –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
        // –ù–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Optimize, VWO –∏–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
        console.log(`Starting traffic allocation for experiment ${expId}`);
    }
    
    async trackParticipation(expId, variantId, userId) {
        const experiment = this.experiments.get(expId);
        if (!experiment || experiment.status !== 'active') return;
        
        const variant = experiment.variants.find(v => v.id === variantId);
        if (!variant) return;
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        variant.participants++;
        experiment.participants++;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—á–∞—Å—Ç–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await this.logParticipation(expId, variantId, userId);
    }
    
    async trackConversion(expId, variantId, userId, value = 0) {
        const experiment = this.experiments.get(expId);
        if (!experiment || experiment.status !== 'active') return;
        
        const variant = experiment.variants.find(v => v.id === variantId);
        if (!variant) return;
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–Ω–≤–µ—Ä—Å–∏–π
        variant.conversions++;
        variant.revenue += value;
        variant.conversionRate = (variant.conversions / variant.participants * 100) || 0;
        
        experiment.conversions++;
        experiment.conversionRate = (experiment.conversions / experiment.participants * 100) || 0;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω–≤–µ—Ä—Å–∏—é
        await this.logConversion(expId, variantId, userId, value);
    }
    
    async completeExperiment(expId, winnerVariant) {
        const experiment = this.experiments.get(expId);
        if (!experiment) return;
        
        experiment.status = 'completed';
        experiment.completedAt = new Date().toISOString();
        experiment.winner = winnerVariant?.name || null;
        experiment.winnerVariant = winnerVariant;
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞
        await this.stopTrafficAllocation(expId);
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–±–µ–¥–∏–≤—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
        await this.applyWinningVariant(expId, winnerVariant);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        await this.sendExperimentResults(experiment);
        
        return true;
    }
    
    async applyWinningVariant(expId, winnerVariant) {
        if (!winnerVariant) return;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–±–µ–¥–∏–≤—à–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
        // –ù–∞–ø—Ä–∏–º–µ—Ä, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É, —Ç–µ–∫—Å—Ç, –¥–∏–∑–∞–π–Ω –∏ —Ç.–¥.
        console.log(`Applying winning variant ${winnerVariant.name} for experiment ${expId}`);
        
        // –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        await this.saveExperimentResult(expId, winnerVariant);
    }
    
    async sendExperimentResults(experiment) {
        const results = this.formatExperimentResults(experiment);
        
        const message = `
üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã A/B —Ç–µ—Å—Ç–∞: ${experiment.name}

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${experiment.participants}
‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Å–∏–π: ${experiment.conversions}
‚Ä¢ –û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è: ${experiment.conversionRate.toFixed(2)}%
‚Ä¢ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${experiment.confidence.toFixed(2)}%

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º:
${experiment.variants.map(v => `
${v.name}:
  - –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${v.participants}
  - –ö–æ–Ω–≤–µ—Ä—Å–∏–π: ${v.conversions}
  - –ö–æ–Ω–≤–µ—Ä—Å–∏—è: ${v.conversionRate.toFixed(2)}%
  - –î–æ—Ö–æ–¥: ${v.revenue} ‚ÇΩ
`).join('')}

üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${experiment.winner || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}
üìà Uplift: ${experiment.winnerVariant?.uplift?.toFixed(2) || '0'}%

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
${this.getExperimentRecommendations(experiment)}
        `;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email —Å–æ–∑–¥–∞—Ç–µ–ª—é —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
        await this.sendEmail(experiment.createdBy, `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã A/B —Ç–µ—Å—Ç–∞: ${experiment.name}`, message);
    }
    
    formatExperimentResults(experiment) {
        return {
            experimentId: experiment.id,
            experimentName: experiment.name,
            status: experiment.status,
            duration: this.calculateExperimentDuration(experiment),
            participants: experiment.participants,
            conversions: experiment.conversions,
            overallConversionRate: experiment.conversionRate,
            confidence: experiment.confidence,
            significant: experiment.significant,
            winner: experiment.winner,
            variants: experiment.variants.map(v => ({
                name: v.name,
                participants: v.participants,
                conversions: v.conversions,
                conversionRate: v.conversionRate,
                revenue: v.revenue
            })),
            recommendations: this.getExperimentRecommendations(experiment)
        };
    }
    
    calculateExperimentDuration(experiment) {
        if (!experiment.startedAt) return '0 –¥–Ω–µ–π';
        
        const start = new Date(experiment.startedAt);
        const end = experiment.completedAt ? new Date(experiment.completedAt) : new Date();
        
        const days = Math.floor((end - start) / (1000 * 60 * 60 * 24));
        const hours = Math.floor((end - start) / (1000 * 60 * 60)) % 24;
        
        return `${days} –¥–Ω–µ–π ${hours} —á–∞—Å–æ–≤`;
    }
    
    getExperimentRecommendations(experiment) {
        const recommendations = [];
        
        if (!experiment.significant && experiment.confidence < 80) {
            recommendations.push('–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç–µ—Å—Ç –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ —Ç—Ä–∞—Ñ–∏–∫.');
        }
        
        if (experiment.participants < 100) {
            recommendations.push('–°–ª–∏—à–∫–æ–º –º–∞–ª–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏.');
        }
        
        const bestVariant = this.getBestVariant(experiment.variants);
        if (bestVariant && bestVariant.conversionRate > 10) {
            recommendations.push(`–í–∞—Ä–∏–∞–Ω—Ç "${bestVariant.name}" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é.`);
        }
        
        return recommendations.length > 0 ? recommendations : ['–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é.'];
    }
    
    getBestVariant(variants) {
        return variants.reduce((best, current) => 
            current.conversionRate > best.conversionRate ? current : best
        );
    }
}

// UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è A/B —Ç–µ—Å—Ç–∞–º–∏
class ABTestingUI {
    constructor(testingSystem) {
        this.testingSystem = testingSystem;
        this.currentExperiment = null;
    }
    
    async render(container) {
        container.innerHTML = `
            <div class="ab-testing-ui">
                <div class="testing-header">
                    <h3><i class="fas fa-flask"></i> A/B –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                    <button class="btn btn-primary" onclick="createNewExperiment()">
                        <i class="fas fa-plus"></i> –ù–æ–≤—ã–π —Ç–µ—Å—Ç
                    </button>
                </div>
                
                <div class="testing-tabs">
                    <div class="tab active" onclick="switchTestingTab('active')">
                        <i class="fas fa-play-circle"></i>
                        <span>–ê–∫—Ç–∏–≤–Ω—ã–µ</span>
                    </div>
                    <div class="tab" onclick="switchTestingTab('draft')">
                        <i class="fas fa-edit"></i>
                        <span>–ß–µ—Ä–Ω–æ–≤–∏–∫–∏</span>
                    </div>
                    <div class="tab" onclick="switchTestingTab('completed')">
                        <i class="fas fa-check-circle"></i>
                        <span>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</span>
                    </div>
                </div>
                
                <div class="experiments-list" id="experimentsList">
                    <!-- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                
                <div class="testing-analytics">
                    <h4>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤</h4>
                    <div class="analytics-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalExperiments">0</div>
                            <div class="stat-label">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="activeExperiments">0</div>
                            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="winningRate">0%</div>
                            <div class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgUplift">0%</div>
                            <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–æ—Å—Ç</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        await this.loadExperiments();
        await this.updateAnalytics();
    }
    
    async loadExperiments() {
        const experiments = Array.from(this.testingSystem.experiments.values());
        await this.renderExperiments(experiments);
    }
    
    async renderExperiments(experiments) {
        const container = document.getElementById('experimentsList');
        if (!container) return;
        
        if (experiments.length === 0) {
            container.innerHTML = `
                <div class="empty-experiments">
                    <i class="fas fa-flask"></i>
                    <h4>–ù–µ—Ç A/B —Ç–µ—Å—Ç–æ–≤</h4>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π A/B —Ç–µ—Å—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏</p>
                    <button class="btn btn-primary" onclick="createNewExperiment()">
                        –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = experiments.map(exp => `
            <div class="experiment-card" data-status="${exp.status}">
                <div class="experiment-header">
                    <div class="experiment-title">
                        <h4>${exp.name}</h4>
                        <span class="experiment-status status-${exp.status}">
                            ${this.getStatusLabel(exp.status)}
                        </span>
                    </div>
                    <div class="experiment-actions">
                        <button class="btn-icon" onclick="viewExperiment('${exp.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="editExperiment('${exp.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="duplicateExperiment('${exp.id}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="experiment-info">
                    <div class="info-item">
                        <i class="fas fa-bullseye"></i>
                        <span>–¶–µ–ª—å: ${exp.objective || '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏'}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-users"></i>
                        <span>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${exp.participants}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-percentage"></i>
                        <span>–ö–æ–Ω–≤–µ—Ä—Å–∏—è: ${exp.conversionRate?.toFixed(2) || '0.00'}%</span>
                    </div>
                </div>
                
                <div class="experiment-variants">
                    <h5>–í–∞—Ä–∏–∞–Ω—Ç—ã:</h5>
                    <div class="variants-list">
                        ${exp.variants?.map(variant => `
                            <div class="variant-item ${exp.winner === variant.name ? 'winner' : ''}">
                                <span class="variant-name">${variant.name}</span>
                                <span class="variant-stats">
                                    ${variant.conversionRate?.toFixed(2) || '0.00'}%
                                    <small>(${variant.conversions}/${variant.participants})</small>
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="experiment-progress">
                    <div class="progress-info">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: ${this.calculateProgress(exp)}%</span>
                        <span>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${exp.confidence?.toFixed(2) || '0.00'}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${this.calculateProgress(exp)}%"></div>
                    </div>
                </div>
                
                <div class="experiment-footer">
                    ${exp.status === 'draft' ? `
                        <button class="btn btn-sm btn-primary" onclick="launchExperiment('${exp.id}')">
                            <i class="fas fa-rocket"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å
                        </button>
                    ` : ''}
                    
                    ${exp.status === 'active' ? `
                        <button class="btn btn-sm btn-warning" onclick="stopExperiment('${exp.id}')">
                            <i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                    ` : ''}
                    
                    ${exp.status === 'completed' ? `
                        <button class="btn btn-sm btn-success" onclick="applyExperiment('${exp.id}')">
                            <i class="fas fa-check"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                        </button>
                    ` : ''}
                </div>
            </div>
        `).join('');
    }
    
    getStatusLabel(status) {
        const labels = {
            'draft': '–ß–µ—Ä–Ω–æ–≤–∏–∫',
            'active': '–ê–∫—Ç–∏–≤–µ–Ω',
            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω',
            'stopped': '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
        };
        return labels[status] || status;
    }
    
    calculateProgress(experiment) {
        if (!experiment.targetSampleSize) return 0;
        return Math.min(100, (experiment.participants / experiment.targetSampleSize * 100) || 0);
    }
    
    async updateAnalytics() {
        const experiments = Array.from(this.testingSystem.experiments.values());
        
        // –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏
        document.getElementById('totalExperiments').textContent = experiments.length;
        document.getElementById('activeExperiments').textContent = 
            experiments.filter(e => e.status === 'active').length;
        
        // –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
        const completed = experiments.filter(e => e.status === 'completed');
        const successful = completed.filter(e => e.significant && e.winner);
        const winningRate = completed.length > 0 ? (successful.length / completed.length * 100) : 0;
        document.getElementById('winningRate').textContent = `${winningRate.toFixed(1)}%`;
        
        // –°—Ä–µ–¥–Ω–∏–π uplift
        const uplifts = successful.map(e => e.winnerVariant?.uplift || 0);
        const avgUplift = uplifts.length > 0 ? 
            uplifts.reduce((a, b) => a + b, 0) / uplifts.length : 0;
        document.getElementById('avgUplift').textContent = `${avgUplift.toFixed(1)}%`;
    }
}

// –°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ ML
class MLRecommendationEngine {
    constructor() {
        this.models = new Map();
        this.userProfiles = new Map();
        this.recommendations = new Map();
    }
    
    async initialize() {
        await this.loadModels();
        await this.loadUserProfiles();
        await this.trainModels();
        
        console.log('ML Recommendation Engine initialized');
    }
    
    async loadModels() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–æ–±—É—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ
        this.models.set('collaborative', await this.loadCollaborativeModel());
        this.models.set('content_based', await this.loadContentBasedModel());
        this.models.set('hybrid', await this.loadHybridModel());
    }
    
    async loadUserProfiles() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const response = await fetch('/api/recommendations/user-profiles');
        const profiles = await response.json();
        
        profiles.forEach(profile => {
            this.userProfiles.set(profile.userId, profile);
        });
    }
    
    async getRecommendations(userId, context = {}) {
        const userProfile = this.userProfiles.get(userId);
        if (!userProfile) {
            return this.getDefaultRecommendations(context);
        }
        
        // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
        const collaborative = await this.getCollaborativeRecommendations(userId, context);
        const contentBased = await this.getContentBasedRecommendations(userId, context);
        const hybrid = await this.getHybridRecommendations(userId, context);
        
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —Ä–∞–Ω–∂–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        const allRecommendations = [...collaborative, ...contentBased, ...hybrid];
        const ranked = this.rankRecommendations(allRecommendations, userProfile, context);
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        const filtered = this.filterRecommendations(ranked, context);
        const final = filtered.slice(0, 10); // –¢–æ–ø-10 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        
        // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        this.recommendations.set(`${userId}_${JSON.stringify(context)}`, {
            recommendations: final,
            timestamp: Date.now(),
            source: 'ml_engine'
        });
        
        return final;
    }
    
    async getCollaborativeRecommendations(userId, context) {
        const model = this.models.get('collaborative');
        if (!model) return [];
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const similarUsers = await this.findSimilarUsers(userId);
        
        // –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ç–æ, —á—Ç–æ –Ω—Ä–∞–≤–∏–ª–æ—Å—å –ø–æ—Ö–æ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        const recommendations = [];
        
        for (const similarUser of similarUsers) {
            const likedItems = await this.getUserLikedItems(similarUser.userId);
            
            for (const item of likedItems) {
                if (!await this.hasUserSeenItem(userId, item.id)) {
                    recommendations.push({
                        type: 'service',
                        item: item,
                        score: similarUser.similarity * item.score,
                        source: 'collaborative',
                        reason: `–ù—Ä–∞–≤–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –ø–æ—Ö–æ–∂–∏–º –Ω–∞ –≤–∞—Å`
                    });
                }
            }
        }
        
        return recommendations;
    }
    
    async getContentBasedRecommendations(userId, context) {
        const model = this.models.get('content_based');
        if (!model) return [];
        
        const userProfile = this.userProfiles.get(userId);
        const userInterests = userProfile?.interests || [];
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–µ—Ä–≤–∏—Å—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const services = await this.getServicesByInterests(userInterests);
        
        return services.map(service => ({
            type: 'service',
            item: service,
            score: this.calculateInterestMatch(userInterests, service.tags),
            source: 'content_based',
            reason: `–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–∞–º: ${service.tags.slice(0, 2).join(', ')}`
        }));
    }
    
    async getHybridRecommendations(userId, context) {
        const model = this.models.get('hybrid');
        if (!model) return [];
        
        // –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º collaborative –∏ content-based –ø–æ–¥—Ö–æ–¥—ã
        const collaborative = await this.getCollaborativeRecommendations(userId, context);
        const contentBased = await this.getContentBasedRecommendations(userId, context);
        
        // –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
        const hybrid = [];
        
        // –î–æ–±–∞–≤–ª—è–µ–º collaborative —Å –≤–µ—Å–æ–º 0.6
        collaborative.forEach(rec => {
            hybrid.push({
                ...rec,
                score: rec.score * 0.6
            });
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º content-based —Å –≤–µ—Å–æ–º 0.4
        contentBased.forEach(rec => {
            const existing = hybrid.find(h => h.item.id === rec.item.id);
            if (existing) {
                existing.score += rec.score * 0.4;
                existing.source = 'hybrid';
            } else {
                hybrid.push({
                    ...rec,
                    score: rec.score * 0.4
                });
            }
        });
        
        return hybrid;
    }
    
    rankRecommendations(recommendations, userProfile, context) {
        return recommendations
            .map(rec => {
                let score = rec.score;
                
                // –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                if (context.timeOfDay) {
                    score *= this.getTimeRelevance(rec.item, context.timeOfDay);
                }
                
                if (context.device) {
                    score *= this.getDeviceRelevance(rec.item, context.device);
                }
                
                // –£—á–∏—Ç—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                score *= this.getPersonalizationFactor(rec.item, userProfile);
                
                // –£—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
                score *= this.getPopularityFactor(rec.item);
                
                // –£—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤–∏–∑–Ω—É
                score *= this.getNoveltyFactor(rec.item, userProfile);
                
                return { ...rec, finalScore: score };
            })
            .sort((a, b) => b.finalScore - a.finalScore);
    }
    
    filterRecommendations(recommendations, context) {
        return recommendations.filter(rec => {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
            if (rec.finalScore < 0.1) return false;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
            if (context.filters) {
                if (context.filters.category && !rec.item.categories?.includes(context.filters.category)) {
                    return false;
                }
                if (context.filters.price && rec.item.price > context.filters.price) {
                    return false;
                }
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ
            if (rec.item.seenByUser) return false;
            
            return true;
        });
    }
    
    async findSimilarUsers(userId, limit = 10) {
        const targetUser = this.userProfiles.get(userId);
        if (!targetUser) return [];
        
        const similarities = [];
        
        for (const [otherId, otherUser] of this.userProfiles) {
            if (otherId === userId) continue;
            
            const similarity = this.calculateUserSimilarity(targetUser, otherUser);
            if (similarity > 0.3) { // –ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏
                similarities.push({
                    userId: otherId,
                    similarity: similarity
                });
            }
        }
        
        return similarities
            .sort((a, b) => b.similarity - a.similarity)
            .slice(0, limit);
    }
    
    calculateUserSimilarity(user1, user2) {
        // –ö–æ—Å–∏–Ω—É—Å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è
        const interests1 = new Set(user1.interests || []);
        const interests2 = new Set(user2.interests || []);
        
        const intersection = [...interests1].filter(x => interests2.has(x)).length;
        const union = interests1.size + interests2.size - intersection;
        
        if (union === 0) return 0;
        
        return intersection / union;
    }
    
    calculateInterestMatch(userInterests, itemTags) {
        const userSet = new Set(userInterests);
        const itemSet = new Set(itemTags);
        
        const intersection = [...userSet].filter(x => itemSet.has(x)).length;
        const union = userSet.size + itemSet.size - intersection;
        
        if (union === 0) return 0;
        
        return intersection / union;
    }
    
    getTimeRelevance(item, timeOfDay) {
        // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫
        const timePreferences = item.timePreferences || {};
        
        switch(timeOfDay) {
            case 'morning':
                return timePreferences.morning || 1.0;
            case 'afternoon':
                return timePreferences.afternoon || 1.0;
            case 'evening':
                return timePreferences.evening || 1.0;
            case 'night':
                return timePreferences.night || 1.0;
            default:
                return 1.0;
        }
    }
    
    getDeviceRelevance(item, device) {
        // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
        const deviceCompatibility = item.deviceCompatibility || {};
        
        switch(device) {
            case 'mobile':
                return deviceCompatibility.mobile || 1.0;
            case 'tablet':
                return deviceCompatibility.tablet || 1.0;
            case 'desktop':
                return deviceCompatibility.desktop || 1.0;
            default:
                return 1.0;
        }
    }
    
    getPersonalizationFactor(item, userProfile) {
        let factor = 1.0;
        
        // –£—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (userProfile.tier) {
            const tierFactor = {
                'bronze': 1.0,
                'silver': 1.1,
                'gold': 1.2,
                'platinum': 1.3
            };
            factor *= tierFactor[userProfile.tier] || 1.0;
        }
        
        // –£—á–∏—Ç—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω–≤–µ—Ä—Å–∏–π
        if (userProfile.conversionRate > 0.1) {
            factor *= 1.2;
        }
        
        return factor;
    }
    
    getPopularityFactor(item) {
        // –£—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞
        const popularity = item.popularity || 0;
        return 1 + (popularity * 0.1); // +10% –∑–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
    }
    
    getNoveltyFactor(item, userProfile) {
        // –£—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤–∏–∑–Ω—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userSeenCount = userProfile.seenItems?.filter(id => id === item.id).length || 0;
        
        if (userSeenCount === 0) {
            return 1.2; // –ë–æ–Ω—É—Å –∑–∞ –Ω–æ–≤–∏–∑–Ω—É
        } else if (userSeenCount > 3) {
            return 0.8; // –®—Ç—Ä–∞—Ñ –∑–∞ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –ø–æ–∫–∞–∑—ã
        }
        
        return 1.0;
    }
    
    async getDefaultRecommendations(context) {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const popularServices = await this.getPopularServices(10);
        
        return popularServices.map(service => ({
            type: 'service',
            item: service,
            score: service.popularity || 0.5,
            source: 'popular',
            reason: '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π —Å–µ—Ä–≤–∏—Å —Å—Ä–µ–¥–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤'
        }));
    }
    
    async trainModels() {
        console.log('Training recommendation models...');
        
        // –û–±—É—á–µ–Ω–∏–µ collaborative filtering
        await this.trainCollaborativeModel();
        
        // –û–±—É—á–µ–Ω–∏–µ content-based –º–æ–¥–µ–ª–∏
        await this.trainContentBasedModel();
        
        // –û–±—É—á–µ–Ω–∏–µ hybrid –º–æ–¥–µ–ª–∏
        await this.trainHybridModel();
        
        console.log('Models training completed');
    }
    
    async trainCollaborativeModel() {
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è collaborative filtering –º–æ–¥–µ–ª–∏
        // –ù–∞–ø—Ä–∏–º–µ—Ä, –º–∞—Ç—Ä–∏—á–Ω–∞—è —Ñ–∞–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, k-NN –∏ —Ç.–¥.
        console.log('Training collaborative model...');
    }
    
    async trainContentBasedModel() {
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è content-based –º–æ–¥–µ–ª–∏
        // –ù–∞–ø—Ä–∏–º–µ—Ä, TF-IDF, word2vec –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏–π —Å–µ—Ä–≤–∏—Å–æ–≤
        console.log('Training content-based model...');
    }
    
    async trainHybridModel() {
        // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ
        console.log('Training hybrid model...');
    }
}

// UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
class RecommendationUI {
    constructor(recommendationEngine) {
        this.engine = recommendationEngine;
        this.currentUserId = null;
    }
    
    async render(container, userId, context = {}) {
        this.currentUserId = userId;
        
        container.innerHTML = `
            <div class="recommendation-ui">
                <div class="recommendation-header">
                    <h3><i class="fas fa-lightbulb"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—Å</h3>
                    <button class="btn btn-sm" onclick="refreshRecommendations()">
                        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
                
                <div class="recommendation-filters">
                    <div class="filter-group">
                        <label>–¢–∏–ø:</label>
                        <select id="recTypeFilter" onchange="filterRecommendations()">
                            <option value="all">–í—Å–µ</option>
                            <option value="service">–°–µ—Ä–≤–∏—Å—ã</option>
                            <option value="content">–ö–æ–Ω—Ç–µ–Ω—Ç</option>
                            <option value="tool">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                        <select id="recCategoryFilter" onchange="filterRecommendations()">
                            <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            <option value="text">–¢–µ–∫—Å—Ç</option>
                            <option value="image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</option>
                            <option value="video">–í–∏–¥–µ–æ</option>
                            <option value="code">–ö–æ–¥</option>
                            <option value="business">–ë–∏–∑–Ω–µ—Å</option>
                        </select>
                    </div>
                </div>
                
                <div class="recommendation-list" id="recommendationList">
                    <div class="loading-recommendations">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>–ò—â–µ–º –ª—É—á—à–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...</p>
                    </div>
                </div>
                
                <div class="recommendation-footer">
                    <p class="feedback-text">
                        –ù—Ä–∞–≤—è—Ç—Å—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏?
                        <button class="btn-link" onclick="giveFeedback('positive')">
                            <i class="fas fa-thumbs-up"></i> –î–∞
                        </button>
                        <button class="btn-link" onclick="giveFeedback('negative')">
                            <i class="fas fa-thumbs-down"></i> –ù–µ—Ç
                        </button>
                    </p>
                </div>
            </div>
        `;
        
        await this.loadRecommendations(context);
    }
    
    async loadRecommendations(context = {}) {
        const container = document.getElementById('recommendationList');
        if (!container) return;
        
        try {
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç –¥–≤–∏–∂–∫–∞
            const recommendations = await this.engine.getRecommendations(
                this.currentUserId,
                context
            );
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            this.renderRecommendations(recommendations);
            
        } catch (error) {
            console.error('Error loading recommendations:', error);
            container.innerHTML = `
                <div class="recommendation-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                    <button class="btn btn-sm" onclick="this.closest('.recommendation-ui').querySelector('.btn').click()">
                        <i class="fas fa-sync-alt"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                    </button>
                </div>
            `;
        }
    }
    
    renderRecommendations(recommendations) {
        const container = document.getElementById('recommendationList');
        if (!container) return;
        
        if (!recommendations || recommendations.length === 0) {
            container.innerHTML = `
                <div class="no-recommendations">
                    <i class="fas fa-search"></i>
                    <h4>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</h4>
                    <p>–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã, –∏ –º—ã –ø–æ–¥–±–µ—Ä–µ–º –¥–ª—è –≤–∞—Å –ª—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = recommendations.map((rec, index) => `
            <div class="recommendation-item" data-type="${rec.type}" data-category="${rec.item.category || 'other'}" data-score="${rec.finalScore || rec.score}">
                <div class="recommendation-rank">#${index + 1}</div>
                
                <div class="recommendation-content">
                    <div class="recommendation-header">
                        <h4>${rec.item.name}</h4>
                        <span class="recommendation-score">
                            <i class="fas fa-star"></i>
                            ${(rec.finalScore || rec.score).toFixed(1)}
                        </span>
                    </div>
                    
                    <p class="recommendation-description">${rec.item.description || ''}</p>
                    
                    <div class="recommendation-meta">
                        <span class="meta-item">
                            <i class="fas fa-tag"></i>
                            ${rec.source === 'collaborative' ? '–ù–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' : 
                              rec.source === 'content_based' ? '–ü–æ –≤–∞—à–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–∞–º' :
                              rec.source === 'hybrid' ? '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è' :
                              rec.source === 'popular' ? '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π —Å–µ—Ä–≤–∏—Å' : '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'}
                        </span>
                        
                        ${rec.reason ? `
                            <span class="meta-item">
                                <i class="fas fa-info-circle"></i>
                                ${rec.reason}
                            </span>
                        ` : ''}
                        
                        ${rec.item.commission ? `
                            <span class="meta-item commission-badge">
                                <i class="fas fa-percentage"></i>
                                –ö–æ–º–∏—Å—Å–∏—è: ${rec.item.commission}%
                            </span>
                        ` : ''}
                    </div>
                    
                    <div class="recommendation-actions">
                        <button class="btn btn-sm btn-primary" onclick="viewRecommendation('${rec.item.id}', '${rec.type}')">
                            <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                        
                        <button class="btn btn-sm btn-secondary" onclick="trackRecommendationClick('${rec.item.id}', ${index + 1})">
                            <i class="fas fa-external-link-alt"></i> –ü–µ—Ä–µ–π—Ç–∏
                        </button>
                        
                        <button class="btn btn-sm btn-outline" onclick="hideRecommendation('${rec.item.id}')">
                            <i class="fas fa-times"></i> –°–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
window.refreshRecommendations = async function() {
    const userId = getCurrentUserId();
    const container = document.querySelector('.recommendation-ui');
    
    if (userId && container) {
        const recommendationUI = new RecommendationUI(window.recommendationEngine);
        await recommendationUI.render(container, userId);
    }
};

window.filterRecommendations = function() {
    const typeFilter = document.getElementById('recTypeFilter').value;
    const categoryFilter = document.getElementById('recCategoryFilter').value;
    
    const items = document.querySelectorAll('.recommendation-item');
    
    items.forEach(item => {
        const itemType = item.dataset.type;
        const itemCategory = item.dataset.category;
        
        const typeMatch = typeFilter === 'all' || itemType === typeFilter;
        const categoryMatch = categoryFilter === 'all' || itemCategory === categoryFilter;
        
        if (typeMatch && categoryMatch) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
};

window.viewRecommendation = function(itemId, type) {
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    window.open(`/recommendation/${type}/${itemId}`, '_blank');
    
    // –¢—Ä–µ–∫–∏–Ω–≥ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    trackRecommendationView(itemId);
};

window.trackRecommendationClick = async function(itemId, position) {
    const userId = getCurrentUserId();
    
    await fetch('/api/recommendations/track-click', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            userId: userId,
            itemId: itemId,
            position: position,
            timestamp: new Date().toISOString()
        })
    });
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
    const item = await getRecommendationItem(itemId);
    if (item?.url) {
        window.open(item.url, '_blank');
    }
};

window.hideRecommendation = async function(itemId) {
    const userId = getCurrentUserId();
    
    await fetch('/api/recommendations/hide', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            userId: userId,
            itemId: itemId,
            reason: 'user_hidden',
            timestamp: new Date().toISOString()
        })
    });
    
    // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
    const item = document.querySelector(`.recommendation-item[data-item-id="${itemId}"]`);
    if (item) {
        item.remove();
    }
};

window.giveFeedback = async function(feedback) {
    const userId = getCurrentUserId();
    
    await fetch('/api/recommendations/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            userId: userId,
            feedback: feedback,
            timestamp: new Date().toISOString(),
            page: window.location.pathname
        })
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    const message = feedback === 'positive' ? 
        '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å! –ë—É–¥–µ–º —É–ª—É—á—à–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.' :
        '–°–ø–∞—Å–∏–±–æ! –£—á—Ç–µ–º –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ –≤ –±—É–¥—É—â–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö.';
    
    showNotification(message, 'info');
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º
class AIAffiliatePlatform {
    constructor() {
        this.automation = new MarketingAutomation();
        this.abTesting = new ABTestingSystem();
        this.recommendationEngine = new MLRecommendationEngine();
        this.contentOptimizer = new AIContentOptimizer();
        
        this.initialized = false;
    }
    
    async initialize() {
        if (this.initialized) return;
        
        console.log('Initializing AI Affiliate Platform...');
        
        try {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã
            await Promise.all([
                this.automation.initialize(),
                this.abTesting.initialize(),
                this.recommendationEngine.initialize()
            ]);
            
            this.initialized = true;
            console.log('AI Affiliate Platform initialized successfully');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
            this.startBackgroundProcesses();
            
        } catch (error) {
            console.error('Failed to initialize platform:', error);
            throw error;
        }
    }
    
    startBackgroundProcesses() {
        // –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
        setInterval(async () => {
            await this.recommendationEngine.trainModels();
        }, 24 * 60 * 60 * 1000); // –ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
        
        // –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
        setInterval(async () => {
            await this.optimizeSystem();
        }, 7 * 24 * 60 * 60 * 1000); // –ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é
    }
    
    async optimizeSystem() {
        console.log('Running system optimization...');
        
        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
        await this.optimizeDatabases();
        
        // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–µ–π
        await this.clearCaches();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
        await this.updateIndexes();
        
        // –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        await this.analyzePerformance();
        
        console.log('System optimization completed');
    }
    
    async optimizeDatabases() {
        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
        await fetch('/api/system/optimize-db', {
            method: 'POST'
        });
    }
    
    async clearCaches() {
        // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–µ–π
        await fetch('/api/system/clear-cache', {
            method: 'POST'
        });
    }
    
    async updateIndexes() {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
        await fetch('/api/system/update-indexes', {
            method: 'POST'
        });
    }
    
    async analyzePerformance() {
        // –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã
        const response = await fetch('/api/system/performance');
        const data = await response.json();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç
        await this.sendPerformanceReport(data);
    }
    
    async sendPerformanceReport(metrics) {
        const report = this.formatPerformanceReport(metrics);
        
        await fetch('/api/system/send-report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                report: report,
                metrics: metrics,
                timestamp: new Date().toISOString()
            })
        });
    }
    
    formatPerformanceReport(metrics) {
        return `
üìä –û—Ç—á–µ—Ç –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã

–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${metrics.uptime}
‚Ä¢ –ó–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É: ${metrics.requestsPerMinute}
‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${metrics.avgResponseTime}–º—Å
‚Ä¢ –û—à–∏–±–æ–∫: ${metrics.errorRate}%

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:
‚Ä¢ CPU: ${metrics.cpuUsage}%
‚Ä¢ –ü–∞–º—è—Ç—å: ${metrics.memoryUsage}%
‚Ä¢ –î–∏—Å–∫: ${metrics.diskUsage}%
‚Ä¢ –°–µ—Ç—å: ${metrics.networkUsage}

–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
‚Ä¢ –ó–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É: ${metrics.dbQueriesPerSecond}
‚Ä¢ –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –ë–î: ${metrics.dbResponseTime}–º—Å
‚Ä¢ –†–∞–∑–º–µ—Ä –ë–î: ${metrics.dbSize}

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
${metrics.recommendations?.map(rec => `‚Ä¢ ${rec}`).join('\n') || '‚Ä¢ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ'}
        `;
    }
    
    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏
    async getPartnerRecommendations(partnerId) {
        const context = await this.getPartnerContext(partnerId);
        return await this.recommendationEngine.getRecommendations(partnerId, context);
    }
    
    async getPartnerContext(partnerId) {
        const partner = await this.getPartner(partnerId);
        const stats = await this.getPartnerStats(partnerId);
        
        return {
            tier: partner.tier,
            conversionRate: stats.conversionRate,
            interests: partner.interests || [],
            device: this.detectDevice(),
            timeOfDay: this.getTimeOfDay(),
            filters: {
                category: partner.preferredCategories || [],
                minCommission: partner.minCommission || 10
            }
        };
    }
    
    async optimizePartnerContent(partnerId, content) {
        const partner = await this.getPartner(partnerId);
        
        return await this.contentOptimizer.optimizeContent(content, {
            targetAudience: this.getPartnerAudience(partner),
            tone: partner.preferredTone || 'professional',
            seo: true
        });
    }
    
    async createABTestForPartner(partnerId, testData) {
        // –°–æ–∑–¥–∞–µ–º A/B —Ç–µ—Å—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
        const experiment = {
            ...testData,
            targetAudience: `partner_${partnerId}`,
            createdBy: partnerId
        };
        
        return await this.abTesting.createExperiment(experiment);
    }
    
    async runAutomationForPartner(partnerId, automationType) {
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞
        switch(automationType) {
            case 'welcome_sequence':
                return await this.startWelcomeSequence(partnerId);
            case 're_engagement':
                return await this.startReEngagement(partnerId);
            case 'performance_review':
                return await this.startPerformanceReview(partnerId);
            default:
                throw new Error(`Unknown automation type: ${automationType}`);
        }
    }
    
    async startWelcomeSequence(partnerId) {
        const sequence = this.automation.sequences.get('welcome_sequence');
        if (!sequence) return;
        
        await this.automation.startSequenceForPartner(sequence, partnerId);
        
        // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫
        await this.logAutomationEvent('welcome_sequence_started', {
            partnerId: partnerId,
            timestamp: new Date().toISOString()
        });
    }
    
    async getPartner(partnerId) {
        const response = await fetch(`/api/partners/${partnerId}`);
        return await response.json();
    }
    
    async getPartnerStats(partnerId) {
        const response = await fetch(`/api/partners/${partnerId}/stats`);
        return await response.json();
    }
    
    detectDevice() {
        const ua = navigator.userAgent;
        if (/Mobile|Android|iPhone|iPad|iPod|Windows Phone/i.test(ua)) {
            return 'mobile';
        } else if (/Tablet|iPad/i.test(ua)) {
            return 'tablet';
        } else {
            return 'desktop';
        }
    }
    
    getTimeOfDay() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return 'morning';
        if (hour >= 12 && hour < 17) return 'afternoon';
        if (hour >= 17 && hour < 22) return 'evening';
        return 'night';
    }
    
    getPartnerAudience(partner) {
        if (partner.tier === 'platinum' || partner.monthlyRevenue > 50000) {
            return 'business';
        } else if (partner.tier === 'gold' || partner.monthlyRevenue > 20000) {
            return 'professionals';
        } else {
            return 'beginners';
        }
    }
    
    async logAutomationEvent(event, data) {
        await fetch('/api/automation/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                event: event,
                data: data,
                timestamp: new Date().toISOString()
            })
        });
    }
}

// –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
class AffiliatePlatformController {
    constructor() {
        this.platform = new AIAffiliatePlatform();
        this.currentUser = null;
        this.modules = new Map();
    }
    
    async initialize() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        this.currentUser = await this.getCurrentUser();
        if (!this.currentUser) {
            window.location.href = '/login';
            return;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
        await this.platform.initialize();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await this.loadUserModules();
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        await this.renderInterface();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        this.startAutoUpdates();
        
        console.log('Affiliate Platform Controller initialized');
    }
    
    async getCurrentUser() {
        const response = await fetch('/api/user/current');
        if (response.ok) {
            return await response.json();
        }
        return null;
    }
    
    async loadUserModules() {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userTier = this.currentUser.tier || 'bronze';
        
        const baseModules = ['dashboard', 'analytics', 'links'];
        const premiumModules = ['automation', 'ab_testing', 'recommendations', 'content_optimizer'];
        
        const availableModules = [...baseModules];
        
        if (['silver', 'gold', 'platinum'].includes(userTier)) {
            availableModules.push(...premiumModules);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å
        for (const moduleName of availableModules) {
            await this.loadModule(moduleName);
        }
    }
    
    async loadModule(moduleName) {
        switch(moduleName) {
            case 'dashboard':
                this.modules.set('dashboard', new PartnerDashboard(this.platform.automation));
                break;
            case 'automation':
                this.modules.set('automation', new CampaignManager(this.platform.automation));
                break;
            case 'ab_testing':
                this.modules.set('ab_testing', new ABTestingUI(this.platform.abTesting));
                break;
            case 'recommendations':
                this.modules.set('recommendations', new RecommendationUI(this.platform.recommendationEngine));
                break;
            // –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏
        }
    }
    
    async renderInterface() {
        // –†–µ–Ω–¥–µ—Ä–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        const appContainer = document.getElementById('app');
        if (!appContainer) return;
        
        appContainer.innerHTML = this.getAppTemplate();
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –º–æ–¥—É–ª–∏
        await this.renderModules();
    }
    
    getAppTemplate() {
        return `
            <div class="affiliate-platform">
                <header class="app-header">
                    <div class="header-left">
                        <div class="logo">
                            <i class="fas fa-robot"></i>
                            <span>AI Affiliate Platform</span>
                        </div>
                        <nav class="main-nav" id="mainNav">
                            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </nav>
                    </div>
                    
                    <div class="header-right">
                        <div class="user-menu">
                            <div class="user-info">
                                <span class="user-name">${this.currentUser.name}</span>
                                <span class="user-tier tier-${this.currentUser.tier}">
                                    ${this.currentUser.tier?.toUpperCase() || 'BRONZE'}
                                </span>
                            </div>
                            <button class="user-avatar" onclick="toggleUserMenu()">
                                ${this.getUserInitials(this.currentUser.name)}
                            </button>
                            
                            <div class="user-dropdown" id="userDropdown">
                                <a href="/profile"><i class="fas fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å</a>
                                <a href="/settings"><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                                <a href="/help"><i class="fas fa-question-circle"></i> –ü–æ–º–æ—â—å</a>
                                <div class="divider"></div>
                                <a href="/logout" class="logout"><i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏</a>
                            </div>
                        </div>
                    </div>
                </header>
                
                <div class="app-sidebar" id="appSidebar">
                    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                
                <main class="app-main">
                    <div class="main-content" id="mainContent">
                        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥—É–ª–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                    </div>
                    
                    <div class="main-sidebar" id="mainSidebar">
                        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ -->
                    </div>
                </main>
                
                <footer class="app-footer">
                    <div class="footer-content">
                        <p>¬© 2024 AI Affiliate Platform. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
                        <div class="footer-links">
                            <a href="/privacy">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</a>
                            <a href="/terms">–£—Å–ª–æ–≤–∏—è</a>
                            <a href="/contact">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
                        </div>
                    </div>
                </footer>
            </div>
        `;
    }
    
    getUserInitials(name) {
        return name.split(' ')
            .map(part => part[0])
            .join('')
            .toUpperCase()
            .substring(0, 2);
    }
    
    async renderModules() {
        // –†–µ–Ω–¥–µ—Ä–∏–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
        await this.renderNavigation();
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å
        await this.renderSidebar();
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–¥–∞—à–±–æ—Ä–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        await this.renderModule('dashboard');
        
        // –†–µ–Ω–¥–µ—Ä–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        await this.renderRecommendationsSidebar();
    }
    
    async renderNavigation() {
        const nav = document.getElementById('mainNav');
        if (!nav) return;
        
        nav.innerHTML = Array.from(this.modules.keys()).map(moduleName => `
            <a href="#" class="nav-link" onclick="switchModule('${moduleName}')">
                <i class="${this.getModuleIcon(moduleName)}"></i>
                <span>${this.getModuleTitle(moduleName)}</span>
            </a>
        `).join('');
    }
    
    getModuleIcon(moduleName) {
        const icons = {
            'dashboard': 'fas fa-tachometer-alt',
            'analytics': 'fas fa-chart-line',
            'links': 'fas fa-link',
            'automation': 'fas fa-robot',
            'ab_testing': 'fas fa-flask',
            'recommendations': 'fas fa-lightbulb',
            'content_optimizer': 'fas fa-magic'
        };
        return icons[moduleName] || 'fas fa-cube';
    }
    
    getModuleTitle(moduleName) {
        const titles = {
            'dashboard': '–î–∞—à–±–æ—Ä–¥',
            'analytics': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
            'links': '–°—Å—ã–ª–∫–∏',
            'automation': '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è',
            'ab_testing': 'A/B –¢–µ—Å—Ç—ã',
            'recommendations': '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏',
            'content_optimizer': '–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä'
        };
        return titles[moduleName] || moduleName;
    }
    
    async renderSidebar() {
        const sidebar = document.getElementById('appSidebar');
        if (!sidebar) return;
        
        sidebar.innerHTML = `
            <div class="sidebar-section">
                <h4>–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø</h4>
                <button class="sidebar-btn" onclick="createCampaign()">
                    <i class="fas fa-plus"></i> –ù–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è
                </button>
                <button class="sidebar-btn" onclick="generateContent()">
                    <i class="fas fa-pen"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
                </button>
                <button class="sidebar-btn" onclick="viewReports()">
                    <i class="fas fa-file-alt"></i> –û—Ç—á–µ—Ç—ã
                </button>
            </div>
            
            <div class="sidebar-section">
                <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                <div class="sidebar-stats">
                    <div class="stat">
                        <span class="stat-label">–î–æ—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è</span>
                        <span class="stat-value">${this.currentUser.todayRevenue || 0} ‚ÇΩ</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</span>
                        <span class="stat-value">${this.currentUser.conversionRate || '0.00'}%</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏</span>
                        <span class="stat-value">${this.currentUser.activeCampaigns || 0}</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h4>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h4>
                <div class="sidebar-notifications" id="sidebarNotifications">
                    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        `;
        
        await this.loadNotifications();
    }
    
    async renderModule(moduleName) {
        const module = this.modules.get(moduleName);
        const container = document.getElementById('mainContent');
        
        if (!module || !container) return;
        
        container.innerHTML = `<div class="module-container" id="module_${moduleName}"></div>`;
        
        await module.render(document.getElementById(`module_${moduleName}`));
    }
    
    async renderRecommendationsSidebar() {
        const sidebar = document.getElementById('mainSidebar');
        if (!sidebar) return;
        
        const recommendationsModule = this.modules.get('recommendations');
        if (recommendationsModule) {
            sidebar.innerHTML = `<div class="recommendations-sidebar" id="recommendationsSidebar"></div>`;
            
            await recommendationsModule.render(
                document.getElementById('recommendationsSidebar'),
                this.currentUser.id
            );
        }
    }
    
    async loadNotifications() {
        const container = document.getElementById('sidebarNotifications');
        if (!container) return;
        
        const response = await fetch('/api/notifications');
        const notifications = await response.json();
        
        if (notifications.length === 0) {
            container.innerHTML = '<p class="no-notifications">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>';
            return;
        }
        
        container.innerHTML = notifications.map(notif => `
            <div class="notification-item ${notif.type}">
                <div class="notification-icon">
                    <i class="${this.getNotificationIcon(notif.type)}"></i>
                </div>
                <div class="notification-content">
                    <p>${notif.message}</p>
                    <small>${new Date(notif.timestamp).toLocaleTimeString('ru-RU')}</small>
                </div>
                <button class="notification-close" onclick="dismissNotification('${notif.id}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }
    
    getNotificationIcon(type) {
        const icons = {
            'success': 'fas fa-check-circle',
            'warning': 'fas fa-exclamation-triangle',
            'error': 'fas fa-exclamation-circle',
            'info': 'fas fa-info-circle'
        };
        return icons[type] || 'fas fa-bell';
    }
    
    startAutoUpdates() {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(async () => {
            await this.loadNotifications();
        }, 30000);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        setInterval(async () => {
            await this.updateUserStats();
        }, 60000);
    }
    
    async updateUserStats() {
        const response = await fetch('/api/user/stats');
        const stats = await response.json();
        
        this.currentUser = { ...this.currentUser, ...stats };
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        await this.renderSidebar();
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π
window.switchModule = async function(moduleName) {
    const controller = window.platformController;
    if (controller) {
        await controller.renderModule(moduleName);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å—Å—ã–ª–∫—É –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        const activeLink = document.querySelector(`.nav-link[onclick="switchModule('${moduleName}')"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }
};

window.toggleUserMenu = function() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.classList.toggle('show');
};

window.dismissNotification = async function(notificationId) {
    await fetch(`/api/notifications/${notificationId}/dismiss`, {
        method: 'POST'
    });
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ UI
    const notification = document.querySelector(`[onclick="dismissNotification('${notificationId}')"]`);
    if (notification) {
        notification.closest('.notification-item').remove();
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // –°–æ–∑–¥–∞–µ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
        window.platformController = new AffiliatePlatformController();
        await window.platformController.initialize();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        window.platform = window.platformController.platform;
        
        console.log('Platform initialized successfully');
        
    } catch (error) {
        console.error('Failed to initialize platform:', error);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        const appContainer = document.getElementById('app');
        if (appContainer) {
            appContainer.innerHTML = `
                <div class="error-container">
                    <h1>üòï –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</h1>
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    </button>
                    <p class="error-details">${error.message}</p>
                </div>
            `;
        }
    }
});

// –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
const platformStyles = `
<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã */
.affiliate-platform {
    display: grid;
    grid-template-areas:
        "header header"
        "sidebar main"
        "footer footer";
    grid-template-columns: 250px 1fr;
    grid-template-rows: auto 1fr auto;
    min-height: 100vh;
    background: #f8fafc;
}

.app-header {
    grid-area: header;
    background: white;
    border-bottom: 1px solid #e2e8f0;
    padding: 0 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 64px;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 40px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.25rem;
    font-weight: bold;
    color: #7c3aed;
}

.logo i {
    font-size: 1.5rem;
}

.main-nav {
    display: flex;
    gap: 8px;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 8px;
    color: #64748b;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
}

.nav-link:hover {
    background: #f1f5f9;
    color: #475569;
}

.nav-link.active {
    background: #ede9fe;
    color: #7c3aed;
}

.nav-link i {
    font-size: 1.1rem;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
}

.user-menu {
    position: relative;
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-info {
    text-align: right;
}

.user-name {
    display: block;
    font-weight: 500;
    color: #1e293b;
}

.user-tier {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.tier-bronze {
    background: #fef3c7;
    color: #92400e;
}

.tier-silver {
    background: #e5e7eb;
    color: #374151;
}

.tier-gold {
    background: #fef3c7;
    color: #92400e;
}

.tier-platinum {
    background: linear-gradient(135deg, #e5e7eb, #d1d5db);
    color: #1f2937;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #7c3aed, #10b981);
    color: white;
    border: none;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.user-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    min-width: 200px;
    display: none;
    z-index: 1001;
}

.user-dropdown.show {
    display: block;
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.user-dropdown a {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: #475569;
    text-decoration: none;
    transition: all 0.2s;
}

.user-dropdown a:hover {
    background: #f8fafc;
    color: #7c3aed;
}

.user-dropdown a.logout {
    color: #ef4444;
}

.user-dropdown .divider {
    height: 1px;
    background: #e2e8f0;
    margin: 8px 0;
}

.app-sidebar {
    grid-area: sidebar;
    background: white;
    border-right: 1px solid #e2e8f0;
    padding: 24px;
    overflow-y: auto;
}

.sidebar-section {
    margin-bottom: 32px;
}

.sidebar-section h4 {
    margin: 0 0 16px 0;
    color: #475569;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.sidebar-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 16px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    color: #475569;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 8px;
}

.sidebar-btn:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
    color: #334155;
}

.sidebar-btn i {
    color: #7c3aed;
}

.sidebar-stats {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.sidebar-stats .stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #f8fafc;
    border-radius: 8px;
}

.sidebar-stats .stat-label {
    font-size: 0.875rem;
    color: #64748b;
}

.sidebar-stats .stat-value {
    font-weight: 600;
    color: #1e293b;
}

.sidebar-notifications {
    max-height: 300px;
    overflow-y: auto;
}

.notification-item {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
    margin-bottom: 8px;
border-left: 3px solid #e2e8f0;
animation: slideIn 0.3s ease;
}

@keyframes slideIn {
from {
opacity: 0;
transform: translateX(-10px);
}
to {
opacity: 1;
transform: translateX(0);
}
}

.notification-item.success {
border-left-color: #10b981;
background: #f0fdf4;
}

.notification-item.warning {
border-left-color: #f59e0b;
background: #fffbeb;
}

.notification-item.error {
border-left-color: #ef4444;
background: #fef2f2;
}

.notification-item.info {
border-left-color: #3b82f6;
background: #eff6ff;
}

.notification-icon {
width: 32px;
height: 32px;
background: white;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
flex-shrink: 0;
}

.notification-icon i {
font-size: 0.875rem;
}

.notification-item.success .notification-icon i {
color: #10b981;
}

.notification-item.warning .notification-icon i {
color: #f59e0b;
}

.notification-item.error .notification-icon i {
color: #ef4444;
}

.notification-item.info .notification-icon i {
color: #3b82f6;
}

.notification-content {
flex: 1;
min-width: 0;
}

.notification-content p {
margin: 0 0 4px 0;
font-size: 0.875rem;
color: #475569;
line-height: 1.4;
}

.notification-content small {
font-size: 0.75rem;
color: #94a3b8;
}

.notification-close {
background: none;
border: none;
color: #94a3b8;
cursor: pointer;
padding: 4px;
align-self: flex-start;
flex-shrink: 0;
}

.notification-close:hover {
color: #64748b;
}

.no-notifications {
text-align: center;
padding: 24px;
color: #94a3b8;
font-style: italic;
font-size: 0.875rem;
}

.app-main {
grid-area: main;
display: grid;
grid-template-columns: 1fr 300px;
gap: 24px;
padding: 24px;
overflow-y: auto;
}

.main-content {
background: white;
border-radius: 12px;
border: 1px solid #e2e8f0;
padding: 24px;
overflow-y: auto;
}

.main-sidebar {
background: white;
border-radius: 12px;
border: 1px solid #e2e8f0;
padding: 24px;
overflow-y: auto;
}

.app-footer {
grid-area: footer;
background: white;
border-top: 1px solid #e2e8f0;
padding: 20px 24px;
}

.footer-content {
display: flex;
justify-content: space-between;
align-items: center;
max-width: 1200px;
margin: 0 auto;
}

.footer-content p {
margin: 0;
color: #64748b;
font-size: 0.875rem;
}

.footer-links {
display: flex;
gap: 20px;
}

.footer-links a {
color: #64748b;
text-decoration: none;
font-size: 0.875rem;
transition: color 0.2s;
}

.footer-links a:hover {
color: #7c3aed;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥—É–ª–µ–π */
.module-container {
height: 100%;
}

.campaign-manager,
.ab-testing-ui,
.recommendation-ui {
height: 100%;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1024px) {
.affiliate-platform {
grid-template-columns: 1fr;
grid-template-areas:
"header"
"main"
"footer";
}
.app-sidebar {
    display: none;
}

.app-main {
    grid-template-columns: 1fr;
}

.main-sidebar {
    display: none;
}

.header-left {
    gap: 20px;
}

.main-nav {
    display: none;
}

.mobile-menu-btn {
    display: block;
}
.app-main {
    padding: 16px;
    gap: 16px;
}

.main-content {
    padding: 16px;
}

.footer-content {
    flex-direction: column;
    gap: 12px;
    text-align: center;
}

.footer-links {
    justify-content: center;
    flex-wrap: wrap;
}
/* –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é */
.mobile-menu-btn {
display: none;
background: none;
border: none;
color: #64748b;
font-size: 1.5rem;
cursor: pointer;
padding: 8px;
}

.mobile-menu {
position: fixed;
top: 64px;
left: 0;
right: 0;
bottom: 0;
background: white;
z-index: 999;
padding: 24px;
overflow-y: auto;
transform: translateX(-100%);
transition: transform 0.3s ease;
}

.mobile-menu.show {
transform: translateX(0);
}

.mobile-menu .nav-link {
display: flex;
align-items: center;
gap: 12px;
padding: 16px;
border-radius: 8px;
margin-bottom: 8px;
}

@media (max-width: 1024px) {
.mobile-menu-btn {
display: block;
}
}

/* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
@media (prefers-color-scheme: dark) {
.affiliate-platform {
background: #0f172a;
}
.app-header,
.app-sidebar,
.main-content,
.main-sidebar,
.app-footer {
    background: #1e293b;
    border-color: #334155;
}

.logo {
    color: #a78bfa;
}

.nav-link {
    color: #cbd5e1;
}

.nav-link:hover {
    background: #334155;
    color: #e2e8f0;
}

.nav-link.active {
    background: #4c1d95;
    color: #a78bfa;
}

.user-name {
    color: #f1f5f9;
}

.user-tier {
    color: white;
}

.tier-bronze {
    background: #92400e;
    color: #fef3c7;
}

.tier-silver {
    background: #374151;
    color: #e5e7eb;
}

.tier-gold {
    background: #92400e;
    color: #fef3c7;
}

.tier-platinum {
    background: linear-gradient(135deg, #374151, #1f2937);
    color: #e5e7eb;
}

.user-dropdown {
    background: #1e293b;
    border-color: #475569;
}

.user-dropdown a {
    color: #cbd5e1;
}

.user-dropdown a:hover {
    background: #334155;
    color: #a78bfa;
}

.sidebar-btn {
    background: #334155;
    border-color: #475569;
    color: #cbd5e1;
}

.sidebar-btn:hover {
    background: #475569;
    border-color: #64748b;
    color: #e2e8f0;
}

.sidebar-stats .stat {
    background: #334155;
}

.sidebar-stats .stat-label {
    color: #94a3b8;
}

.sidebar-stats .stat-value {
    color: #f1f5f9;
}

.notification-item {
    background: #334155;
    border-left-color: #475569;
}

.notification-item.success {
    background: #064e3b;
    border-left-color: #10b981;
}

.notification-item.warning {
    background: #78350f;
    border-left-color: #f59e0b;
}

.notification-item.error {
    background: #7f1d1d;
    border-left-color: #ef4444;
}

.notification-item.info {
    background: #1e3a8a;
    border-left-color: #3b82f6;
}

.notification-icon {
    background: #1e293b;
}

.notification-content p {
    color: #cbd5e1;
}

.notification-content small {
    color: #94a3b8;
}

.footer-content p {
    color: #94a3b8;
}

.footer-links a {
    color: #94a3b8;
}

.footer-links a:hover {
    color: #a78bfa;
}

.mobile-menu {
    background: #1e293b;
}
/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes pulse {
0%, 100% {
opacity: 1;
}
50% {
opacity: 0.5;
}
}

.loading {
animation: pulse 2s infinite;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—à–∏–±–æ–∫ */
.error-container {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
min-height: 100vh;
padding: 24px;
text-align: center;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
}

.error-container h1 {
font-size: 3rem;
margin-bottom: 16px;
}

.error-container p {
font-size: 1.25rem;
margin-bottom: 32px;
max-width: 500px;
}

.error-details {
margin-top: 24px;
padding: 16px;
background: rgba(255, 255, 255, 0.1);
border-radius: 8px;
font-family: monospace;
font-size: 0.875rem;
max-width: 600px;
word-break: break-word;
}

/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
.progress-bar {
height: 6px;
background: #e2e8f0;
border-radius: 3px;
overflow: hidden;
margin: 8px 0;
}

.progress-fill {
height: 100%;
background: linear-gradient(90deg, #7c3aed, #10b981);
border-radius: 3px;
transition: width 0.3s ease;
}

/* –†–µ–π—Ç–∏–Ω–≥ */
.rating-stars {
display: flex;
gap: 2px;
}

.rating-stars i {
color: #fbbf24;
font-size: 0.875rem;
}

/* –ë–µ–π–¥–∂–∏ */
.badge {
display: inline-block;
padding: 4px 8px;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 600;
text-transform: uppercase;
}

.badge-success {
background: #d1fae5;
color: #065f46;
}

.badge-warning {
background: #fef3c7;
color: #92400e;
}

.badge-error {
background: #fee2e2;
color: #991b1b;
}

.badge-info {
background: #dbeafe;
color: #1e40af;
}

/* –°–µ—Ç–∫–∏ */
.grid-2 {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 16px;
}

.grid-3 {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 16px;
}

.grid-4 {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 16px;
}

@media (max-width: 1024px) {
.grid-4 {
grid-template-columns: repeat(2, 1fr);
}
}

@media (max-width: 768px) {
.grid-2,
.grid-3,
.grid-4 {
grid-template-columns: 1fr;
}
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ */
.card {
background: white;
border-radius: 12px;
border: 1px solid #e2e8f0;
padding: 20px;
transition: all 0.3s;
}

.card:hover {
box-shadow: 0 10px 25px rgba(0,0,0,0.1);
transform: translateY(-2px);
}

.card-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 16px;
padding-bottom: 12px;
border-bottom: 1px solid #e2e8f0;
}

.card-title {
margin: 0;
font-size: 1.25rem;
color: #1e293b;
}

.card-body {
margin-bottom: 16px;
}

.card-footer {
display: flex;
justify-content: space-between;
align-items: center;
padding-top: 12px;
border-top: 1px solid #e2e8f0;
}

/* –§–æ—Ä–º—ã */
.form-group {
margin-bottom: 20px;
}

.form-label {
display: block;
margin-bottom: 8px;
font-weight: 500;
color: #374151;
}

.form-control {
width: 100%;
padding: 10px 12px;
border: 1px solid #d1d5db;
border-radius: 8px;
font-size: 1rem;
transition: all 0.2s;
}

.form-control:focus {
outline: none;
border-color: #7c3aed;
box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
}

.form-text {
display: block;
margin-top: 6px;
font-size: 0.875rem;
color: #6b7280;
}

.form-error {
color: #ef4444;
font-size: 0.875rem;
margin-top: 6px;
}

/* –ö–Ω–æ–ø–∫–∏ */
.btn {
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
padding: 10px 20px;
border-radius: 8px;
font-weight: 500;
cursor: pointer;
transition: all 0.2s;
border: none;
font-size: 1rem;
}

.btn-primary {
background: linear-gradient(135deg, #7c3aed, #10b981);
color: white;
}

.btn-primary:hover {
opacity: 0.9;
transform: translateY(-1px);
}

.btn-secondary {
background: #f1f5f9;
color: #475569;
border: 1px solid #e2e8f0;
}

.btn-secondary:hover {
background: #e2e8f0;
}

.btn-outline {
background: transparent;
color: #7c3aed;
border: 1px solid #7c3aed;
}

.btn-outline:hover {
background: #7c3aed;
color: white;
}

.btn-sm {
padding: 6px 12px;
font-size: 0.875rem;
}

.btn-lg {
padding: 14px 28px;
font-size: 1.125rem;
}

.btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* –£—Ç–∏–ª–∏—Ç—ã */
.text-center {
text-align: center;
}

.text-right {
text-align: right;
}

.mt-1 { margin-top: 4px; }
.mt-2 { margin-top: 8px; }
.mt-3 { margin-top: 12px; }
.mt-4 { margin-top: 16px; }
.mt-5 { margin-top: 20px; }

.mb-1 { margin-bottom: 4px; }
.mb-2 { margin-bottom: 8px; }
.mb-3 { margin-bottom: 12px; }
.mb-4 { margin-bottom: 16px; }
.mb-5 { margin-bottom: 20px; }

.ml-1 { margin-left: 4px; }
.ml-2 { margin-left: 8px; }
.ml-3 { margin-left: 12px; }
.ml-4 { margin-left: 16px; }
.ml-5 { margin-left: 20px; }

.mr-1 { margin-right: 4px; }
.mr-2 { margin-right: 8px; }
.mr-3 { margin-right: 12px; }
.mr-4 { margin-right: 16px; }
.mr-5 { margin-right: 20px; }

.p-1 { padding: 4px; }
.p-2 { padding: 8px; }
.p-3 { padding: 12px; }
.p-4 { padding: 16px; }
.p-5 { padding: 20px; }

.w-100 { width: 100%; }
.h-100 { height: 100%; }

.d-flex { display: flex; }
.d-block { display: block; }
.d-none { display: none; }

.flex-column { flex-direction: column; }
.flex-row { flex-direction: row; }
.flex-wrap { flex-wrap: wrap; }

.justify-start { justify-content: flex-start; }
.justify-end { justify-content: flex-end; }
.justify-center { justify-content: center; }
.justify-between { justify-content: space-between; }
.justify-around { justify-content: space-around; }

.items-start { align-items: flex-start; }
.items-end { align-items: flex-end; }
.items-center { align-items: center; }
.items-baseline { align-items: baseline; }
.items-stretch { align-items: stretch; }

.gap-1 { gap: 4px; }
.gap-2 { gap: 8px; }
.gap-3 { gap: 12px; }
.gap-4 { gap: 16px; }
.gap-5 { gap: 20px; }
</style>
`;

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç
document.head.insertAdjacentHTML('beforeend', platformStyles);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', async function() {
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
const loader = document.createElement('div');
loader.className = 'loading-overlay';
loader.innerHTML = <div class="loading-content"> <div class="loading-spinner"></div> <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã...</p> </div>;
document.body.appendChild(loader);
try {
    // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–∂–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ DOMContentLoaded
    // –ï—Å–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
    if (!window.platformController) {
        window.platformController = new AffiliatePlatformController();
        await window.platformController.initialize();
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
    loader.style.opacity = '0';
    setTimeout(() => {
        loader.remove();
    }, 300);
    
} catch (error) {
    console.error('Failed to initialize platform:', error);
    loader.innerHTML = `
        <div class="error-content">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p>${error.message}</p>
            <button class="btn btn-primary" onclick="location.reload()">
                –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
            </button>
        </div>
    `;
}
// –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Å—Ç–∏–ª–∏
const loaderStyles = `

<style> .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.3s ease; } .loading-content { text-align: center; color: white; } .loading-spinner { width: 60px; height: 60px; border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin: 0 auto 20px; } @keyframes spin { to { transform: rotate(360deg); } } .loading-content p { font-size: 1.25rem; margin: 0; opacity: 0.9; } .error-content { text-align: center; color: white; max-width: 400px; padding: 20px; } .error-content i { font-size: 3rem; margin-bottom: 20px; color: #fbbf24; } .error-content h3 { font-size: 1.5rem; margin: 0 0 10px 0; } .error-content p { margin: 0 0 20px 0; opacity: 0.9; } </style>
`;

document.head.insertAdjacentHTML('beforeend', loaderStyles);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
async function updateRealTimeMetrics() {
if (!window.platformController) return;
try {
    const response = await fetch('/api/metrics/realtime');
    const metrics = await response.json();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
    updateMetricsUI(metrics);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    checkForNotifications(metrics);
    
} catch (error) {
    console.error('Failed to update metrics:', error);
}
// –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(updateRealTimeMetrics, 30000);

// –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É
updateRealTimeMetrics();

// –≠–∫—Å–ø–æ—Ä—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
if (process.env.NODE_ENV === 'development') {
window.debug = {
platform: window.platform,
controller: window.platformController,
utils: {
updateRealTimeMetrics,
refreshRecommendations
}
};
}

console.log('üöÄ AI Affiliate Platform –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
import pygame
import sys
import os
import random
from pygame.locals import *

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pygame
pygame.init()
pygame.mixer.init()

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
SCREEN_WIDTH = 1000
SCREEN_HEIGHT = 700
FPS = 60
GRAVITY = 0.5
JUMP_STRENGTH = -12
PLAYER_SPEED = 5

# –¶–≤–µ—Ç–∞
WHITE = (255, 255, 255)
BLACK = (0, 0, 0)
RED = (255, 0, 0)
GREEN = (0, 255, 0)
BLUE = (0, 120, 255)
YELLOW = (255, 255, 0)
PURPLE = (180, 0, 255)
BACKGROUND = (20, 20, 35)

class Player:
    def __init__(self, x, y):
        self.rect = pygame.Rect(x, y, 40, 60)
        self.vel_y = 0
        self.on_ground = False
        self.facing_right = True
        self.animation_frames = []
        self.load_animations()
        self.current_frame = 0
        self.animation_speed = 0.15
        self.animation_counter = 0
        self.color = BLUE
        
    def load_animations(self):
        # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Å—Ç—É—é –∞–Ω–∏–º–∞—Ü–∏—é (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏ –±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏)
        self.idle_frames = [self.create_frame(1), self.create_frame(0.9)]
        self.run_frames = [self.create_frame(0.8), self.create_frame(1), self.create_frame(0.8), self.create_frame(1.2)]
        self.jump_frame = self.create_frame(1.1)
        
    def create_frame(self, scale):
        # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Å—Ç—É—é –≥—Ä–∞—Ñ–∏–∫—É –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        surf = pygame.Surface((40, 60), pygame.SRCALPHA)
        color = (0, 150, 255) if scale >= 1 else (0, 120, 230)
        pygame.draw.rect(surf, color, (5, 5, 30, 50 * scale))
        pygame.draw.circle(surf, (200, 230, 255), (20, 15), 10)
        return surf
        
    def update(self, platforms):
        keys = pygame.key.get_pressed()
        
        # –î–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ
        if keys[K_LEFT] or keys[K_a]:
            self.rect.x -= PLAYER_SPEED
            self.facing_right = False
        if keys[K_RIGHT] or keys[K_d]:
            self.rect.x += PLAYER_SPEED
            self.facing_right = True
            
        # –ü—Ä—ã–∂–æ–∫
        if (keys[K_SPACE] or keys[K_UP] or keys[K_w]) and self.on_ground:
            self.vel_y = JUMP_STRENGTH
            self.on_ground = False
            
        # –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
        self.vel_y += GRAVITY
        self.rect.y += self.vel_y
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏
        self.on_ground = False
        for platform in platforms:
            if self.rect.colliderect(platform.rect):
                if self.vel_y > 0:
                    self.rect.bottom = platform.rect.top
                    self.vel_y = 0
                    self.on_ground = True
                elif self.vel_y < 0:
                    self.rect.top = platform.rect.bottom
                    self.vel_y = 0
        
        # –ì—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
        if self.rect.left < 0:
            self.rect.left = 0
        if self.rect.right > SCREEN_WIDTH:
            self.rect.right = SCREEN_WIDTH
        if self.rect.top < 0:
            self.rect.top = 0
            self.vel_y = 0
            
        # –ê–Ω–∏–º–∞—Ü–∏—è
        self.animation_counter += self.animation_speed
        if not self.on_ground:
            self.animation_frames = [self.jump_frame]
        elif keys[K_LEFT] or keys[K_RIGHT] or keys[K_a] or keys[K_d]:
            self.animation_frames = self.run_frames
        else:
            self.animation_frames = self.idle_frames
            
        if self.animation_counter >= 1:
            self.animation_counter = 0
            self.current_frame = (self.current_frame + 1) % len(self.animation_frames)
    
    def draw(self, screen, camera_x):
        frame = self.animation_frames[self.current_frame]
        
        # –û—Ç—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ —Å–º–æ—Ç—Ä–∏—Ç –≤–ª–µ–≤–æ
        if not self.facing_right:
            frame = pygame.transform.flip(frame, True, False)
            
        screen.blit(frame, (self.rect.x - camera_x, self.rect.y))

class Platform:
    def __init__(self, x, y, width, height):
        self.rect = pygame.Rect(x, y, width, height)
        self.color = GREEN
        self.type = "normal"
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É
        self.texture = self.create_texture(width, height)
        
    def create_texture(self, width, height):
        texture = pygame.Surface((width, height))
        base_color = (50, 180, 50)
        for i in range(0, width, 4):
            for j in range(0, height, 4):
                shade = random.randint(-20, 20)
                color = (
                    max(0, min(255, base_color[0] + shade)),
                    max(0, min(255, base_color[1] + shade)),
                    max(0, min(255, base_color[2] + shade))
                )
                pygame.draw.rect(texture, color, (i, j, 4, 4))
        return texture
        
    def draw(self, screen, camera_x):
        screen.blit(self.texture, (self.rect.x - camera_x, self.rect.y))

class Coin:
    def __init__(self, x, y):
        self.rect = pygame.Rect(x, y, 20, 20)
        self.collected = False
        self.animation_counter = 0
        self.color = YELLOW
        
    def update(self):
        if not self.collected:
            self.animation_counter += 0.1
            
    def draw(self, screen, camera_x):
        if not self.collected:
            # –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–Ω–µ—Ç–∫–∞
            size = 10 + 3 * abs(pygame.math.Vector2(0, 1).rotate(self.animation_counter * 50).y)
            pygame.draw.circle(screen, YELLOW, 
                             (self.rect.centerx - camera_x, self.rect.centery), 
                             int(size))
            pygame.draw.circle(screen, (255, 200, 0), 
                             (self.rect.centerx - camera_x, self.rect.centery), 
                             int(size) - 3)

class Enemy:
    def __init__(self, x, y, patrol_range=100):
        self.rect = pygame.Rect(x, y, 35, 45)
        self.direction = 1
        self.speed = 2
        self.patrol_range = patrol_range
        self.start_x = x
        self.color = RED
        self.animation_counter = 0
        
    def update(self):
        self.rect.x += self.direction * self.speed
        self.animation_counter += 0.1
        
        # –†–∞–∑–≤–æ—Ä–æ—Ç –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –ø–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è
        if self.rect.x > self.start_x + self.patrol_range:
            self.direction = -1
        elif self.rect.x < self.start_x - self.patrol_range:
            self.direction = 1
            
    def draw(self, screen, camera_x):
        # –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—Ä–∞–≥
        eye_offset = 3 * abs(pygame.math.Vector2(0, 1).rotate(self.animation_counter * 30).y)
        
        # –¢–µ–ª–æ
        pygame.draw.rect(screen, RED, 
                        (self.rect.x - camera_x, self.rect.y, self.rect.width, self.rect.height),
                        border_radius=8)
        pygame.draw.rect(screen, (150, 0, 0), 
                        (self.rect.x - camera_x + 3, self.rect.y + 3, 
                         self.rect.width - 6, self.rect.height - 6),
                        border_radius=5)
        
        # –ì–ª–∞–∑–∞
        eye_y = self.rect.y + 15
        pygame.draw.circle(screen, WHITE, 
                         (self.rect.x - camera_x + 10, eye_y + eye_offset), 6)
        pygame.draw.circle(screen, WHITE, 
                         (self.rect.x - camera_x + 25, eye_y - eye_offset), 6)
        pygame.draw.circle(screen, BLACK, 
                         (self.rect.x - camera_x + 10, eye_y + eye_offset), 3)
        pygame.draw.circle(screen, BLACK, 
                         (self.rect.x - camera_x + 25, eye_y - eye_offset), 3)

class Particle:
    def __init__(self, x, y, color, velocity):
        self.x = x
        self.y = y
        self.color = color
        self.velocity = velocity
        self.size = random.randint(3, 8)
        self.life = 100
        
    def update(self):
        self.x += self.velocity[0]
        self.y += self.velocity[1]
        self.velocity[1] += 0.1  # –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
        self.life -= 3
        self.size = max(0, self.size - 0.1)
        
    def draw(self, screen, camera_x):
        if self.life > 0:
            alpha = min(255, self.life * 2.5)
            color_with_alpha = (*self.color, int(alpha))
            surf = pygame.Surface((int(self.size * 2), int(self.size * 2)), pygame.SRCALPHA)
            pygame.draw.circle(surf, color_with_alpha, (int(self.size), int(self.size)), int(self.size))
            screen.blit(surf, (self.x - camera_x - self.size, self.y - self.size))

class VideoPlayer:
    def __init__(self, screen):
        self.screen = screen
        self.video_surface = None
        self.playing = False
        self.current_video = 0
        self.videos = self.create_video_surfaces()
        
    def create_video_surfaces(self):
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –±—ã –≤–∏–¥–µ–æ—Ñ–∞–π–ª—ã
        # –°–æ–∑–¥–∞—ë–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –∫–∞–∫ –∑–∞–º–µ–Ω—É –≤–∏–¥–µ–æ
        videos = []
        for i in range(3):
            frames = []
            for frame in range(30):
                surf = pygame.Surface((300, 200))
                # –°–æ–∑–¥–∞—ë–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
                for y in range(200):
                    color_value = (y + frame * 10 + i * 50) % 255
                    color = (
                        (color_value + i * 30) % 255,
                        (color_value + i * 60) % 255,
                        (color_value + i * 90) % 255
                    )
                    pygame.draw.line(surf, color, (0, y), (300, y))
                
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä "–≤–∏–¥–µ–æ"
                font = pygame.font.Font(None, 36)
                text = font.render(f"–í–∏–¥–µ–æ {i+1}", True, WHITE)
                surf.blit(text, (100, 80))
                
                frames.append(surf)
            videos.append(frames)
        return videos
    
    def play(self, video_index=0):
        self.current_video = video_index
        self.playing = True
        self.frame_counter = 0
        
    def stop(self):
        self.playing = False
        
    def update(self):
        if self.playing:
            self.frame_counter += 1
            if self.frame_counter >= len(self.videos[self.current_video]):
                self.frame_counter = 0
                
    def draw(self, x, y):
        if self.playing:
            frame = self.frame_counter % len(self.videos[self.current_video])
            self.screen.blit(self.videos[self.current_video][frame], (x, y))
            # –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            pygame.draw.rect(self.screen, RED, (x + 270, y + 10, 20, 20), border_radius=3)
            font = pygame.font.Font(None, 20)
            text = font.render("X", True, WHITE)
            self.screen.blit(text, (x + 275, y + 11))
        else:
            # –ü–ª–µ–π–µ—Ä –≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
            surf = pygame.Surface((300, 200))
            surf.fill((40, 40, 60))
            pygame.draw.rect(surf, (60, 60, 80), surf.get_rect(), 3)
            
            # –ö–Ω–æ–ø–∫–∞ play
            pygame.draw.circle(surf, GREEN, (150, 100), 30)
            pygame.draw.polygon(surf, WHITE, [(165, 90), (165, 110), (185, 100)])
            
            font = pygame.font.Font(None, 28)
            text = font.render("–ù–∞–∂–º–∏—Ç–µ PLAY", True, WHITE)
            surf.blit(text, (80, 150))
            
            self.screen.blit(surf, (x, y))

class Game:
    def __init__(self):
        self.screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
        pygame.display.set_caption("–ü–ª–∞—Ç—Ñ–æ—Ä–º–µ—Ä —Å –≤–∏–¥–µ–æ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–π")
        self.clock = pygame.time.Clock()
        self.running = True
        self.font = pygame.font.Font(None, 36)
        self.small_font = pygame.font.Font(None, 24)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        self.reset_game()
        
        # –í–∏–¥–µ–æ–ø–ª–µ–µ—Ä
        self.video_player = VideoPlayer(self.screen)
        
        # –ß–∞—Å—Ç–∏—Ü—ã
        self.particles = []
        
        # –≠—Ñ—Ñ–µ–∫—Ç—ã
        self.screen_shake = 0
        
    def reset_game(self):
        self.player = Player(100, 300)
        self.camera_x = 0
        
        # –°–æ–∑–¥–∞—ë–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        self.platforms = [
            Platform(0, 400, 200, 30),
            Platform(250, 350, 150, 30),
            Platform(450, 300, 200, 30),
            Platform(700, 250, 150, 30),
            Platform(300, 500, 400, 30),
            Platform(800, 450, 200, 30),
            Platform(100, 600, 300, 30),
            Platform(500, 200, 100, 30),
        ]
        
        # –°–æ–∑–¥–∞—ë–º –º–æ–Ω–µ—Ç–∫–∏
        self.coins = [
            Coin(120, 340),
            Coin(320, 320),
            Coin(550, 270),
            Coin(750, 220),
            Coin(350, 470),
            Coin(850, 420),
        ]
        
        # –°–æ–∑–¥–∞—ë–º –≤—Ä–∞–≥–æ–≤
        self.enemies = [
            Enemy(300, 460, 150),
            Enemy(600, 210, 80),
        ]
        
        self.score = 0
        self.lives = 3
        self.game_over = False
        
    def handle_events(self):
        for event in pygame.event.get():
            if event.type == QUIT:
                self.running = False
                
            elif event.type == KEYDOWN:
                if event.key == K_ESCAPE:
                    self.running = False
                    
                elif event.key == K_r and self.game_over:
                    self.reset_game()
                    
                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä–æ–º
                elif event.key == K_1:
                    self.video_player.play(0)
                elif event.key == K_2:
                    self.video_player.play(1)
                elif event.key == K_3:
                    self.video_player.play(2)
                elif event.key == K_0:
                    self.video_player.stop()
                    
            elif event.type == MOUSEBUTTONDOWN:
                x, y = event.pos
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–¥–µ–æ
                if 970 <= x <= 990 and 210 <= y <= 230:
                    self.video_player.stop()
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ play –≤–∏–¥–µ–æ
                elif 650 <= x <= 950 and 500 <= y <= 700:
                    self.video_player.play()
                    
    def update(self):
        if not self.game_over:
            self.player.update(self.platforms)
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
            self.camera_x = self.player.rect.x - SCREEN_WIDTH // 3
            self.camera_x = max(0, min(self.camera_x, 2000 - SCREEN_WIDTH))
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç–æ–∫
            for coin in self.coins:
                coin.update()
                if not coin.collected and self.player.rect.colliderect(coin.rect):
                    coin.collected = True
                    self.score += 10
                    
                    # –≠—Ñ—Ñ–µ–∫—Ç —Å–±–æ—Ä–∞ –º–æ–Ω–µ—Ç–∫–∏
                    for _ in range(10):
                        self.particles.append(Particle(
                            coin.rect.centerx, coin.rect.centery,
                            YELLOW,
                            (random.uniform(-3, 3), random.uniform(-5, -1))
                        ))
                    
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
            for enemy in self.enemies:
                enemy.update()
                if self.player.rect.colliderect(enemy.rect):
                    self.lives -= 1
                    self.screen_shake = 10
                    
                    # –≠—Ñ—Ñ–µ–∫—Ç —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
                    for _ in range(20):
                        self.particles.append(Particle(
                            self.player.rect.centerx, self.player.rect.centery,
                            RED,
                            (random.uniform(-5, 5), random.uniform(-5, 0))
                        ))
                    
                    # –°–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
                    self.player.rect.x = 100
                    self.player.rect.y = 300
                    self.player.vel_y = 0
                    
                    if self.lives <= 0:
                        self.game_over = True
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
        for particle in self.particles[:]:
            particle.update()
            if particle.life <= 0:
                self.particles.remove(particle)
                
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä–∞
        self.video_player.update()
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç—Ä—è—Å–∫–∏ —ç–∫—Ä–∞–Ω–∞
        if self.screen_shake > 0:
            self.screen_shake -= 1
    
    def draw_background(self):
        # –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
        for y in range(0, SCREEN_HEIGHT, 2):
            color_value = int(20 + (y / SCREEN_HEIGHT) * 15)
            color = (color_value, color_value, color_value + 15)
            pygame.draw.line(self.screen, color, (0, y), (SCREEN_WIDTH, y))
        
        # –ó–≤—ë–∑–¥—ã
        for i in range(100):
            x = (i * 37) % SCREEN_WIDTH
            y = (i * 29) % SCREEN_HEIGHT
            size = 1 + (i % 3)
            brightness = 150 + (i % 105)
            pygame.draw.circle(self.screen, (brightness, brightness, brightness), 
                             (x, y), size)
    
    def draw_hud(self):
        # –°—á—ë—Ç
        score_text = self.font.render(f"–û—á–∫–∏: {self.score}", True, WHITE)
        self.screen.blit(score_text, (20, 20))
        
        # –ñ–∏–∑–Ω–∏
        lives_text = self.font.render(f"–ñ–∏–∑–Ω–∏: {self.lives}", True, WHITE)
        self.screen.blit(lives_text, (20, 60))
        
        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        controls = [
            "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:",
            "‚Üê ‚Üí / A D - –î–≤–∏–∂–µ–Ω–∏–µ",
            "SPACE / W - –ü—Ä—ã–∂–æ–∫",
            "1,2,3 - –í–∏–¥–µ–æ",
            "0 - –°—Ç–æ–ø –≤–∏–¥–µ–æ",
            "R - –†–µ—Å—Ç–∞—Ä—Ç",
            "ESC - –í—ã—Ö–æ–¥"
        ]
        
        for i, text in enumerate(controls):
            rendered = self.small_font.render(text, True, (200, 200, 200))
            self.screen.blit(rendered, (SCREEN_WIDTH - 250, 20 + i * 25))
        
        # –í–∏–¥–µ–æ–ø–ª–µ–µ—Ä
        video_label = self.font.render("–í–ò–î–ï–û –ü–õ–ï–ï–†", True, PURPLE)
        self.screen.blit(video_label, (650, 460))
        self.video_player.draw(650, 500)
    
    def draw(self):
        # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç—Ä—è—Å–∫–∏ —ç–∫—Ä–∞–Ω–∞
        shake_offset = 0
        if self.screen_shake > 0:
            shake_offset = random.randint(-3, 3)
            
        # –§–æ–Ω
        self.draw_background()
        
        # –°–º–µ—â–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç—Ä—è—Å–∫–∏
        draw_offset = shake_offset
        
        # –†–∏—Å—É–µ–º –∏–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã —Å —É—á—ë—Ç–æ–º –∫–∞–º–µ—Ä—ã
        for platform in self.platforms:
            platform.draw(self.screen, self.camera_x + draw_offset)
            
        for coin in self.coins:
            coin.draw(self.screen, self.camera_x + draw_offset)
            
        for enemy in self.enemies:
            enemy.draw(self.screen, self.camera_x + draw_offset)
            
        # –ß–∞—Å—Ç–∏—Ü—ã
        for particle in self.particles:
            particle.draw(self.screen, self.camera_x + draw_offset)
            
        # –ò–≥—Ä–æ–∫
        self.player.draw(self.screen, self.camera_x + draw_offset)
        
        # HUD (–±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç—Ä—è—Å–∫–∏)
        self.draw_hud()
        
        # –≠–∫—Ä–∞–Ω Game Over
        if self.game_over:
            overlay = pygame.Surface((SCREEN_WIDTH, SCREEN_HEIGHT), pygame.SRCALPHA)
            overlay.fill((0, 0, 0, 180))
            self.screen.blit(overlay, (0, 0))
            
            game_over_text = self.font.render("–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê", True, RED)
            score_text = self.font.render(f"–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á—ë—Ç: {self.score}", True, YELLOW)
            restart_text = self.small_font.render("–ù–∞–∂–º–∏—Ç–µ R –¥–ª—è —Ä–µ—Å—Ç–∞—Ä—Ç–∞", True, WHITE)
            
            self.screen.blit(game_over_text, 
                           (SCREEN_WIDTH//2 - game_over_text.get_width()//2, 
                            SCREEN_HEIGHT//2 - 50))
            self.screen.blit(score_text, 
                           (SCREEN_WIDTH//2 - score_text.get_width()//2, 
                            SCREEN_HEIGHT//2))
            self.screen.blit(restart_text, 
                           (SCREEN_WIDTH//2 - restart_text.get_width()//2, 
                            SCREEN_HEIGHT//2 + 50))
        
        pygame.display.flip()
    
    def run(self):
        while self.running:
            self.handle_events()
            self.update()
            self.draw()
            self.clock.tick(FPS)
        
        pygame.quit()
        sys.exit()

if __name__ == "__main__":
    game = Game()
    game.run()
